# –ú–ê–¢–†–ò–¶–ê –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ô –ú–ï–ñ–î–£ –ö–û–ú–ü–û–ù–ï–ù–¢–ê–ú–ò
## –î–∞—Ç–∞: 03 –Ω–æ—è–±—Ä—è 2025
## –í–µ—Ä—Å–∏—è: 1.0

---

## üìã –û–ì–õ–ê–í–õ–ï–ù–ò–ï

1. [Frontend ‚Üî Backend Type Mismatches](#1-frontend--backend-type-mismatches)
2. [Database ‚Üî Models Inconsistencies](#2-database--models-inconsistencies)
3. [API Documentation ‚Üî Implementation](#3-api-documentation--implementation)
4. [Tests ‚Üî Code Coverage Gaps](#4-tests--code-coverage-gaps)

---

## 1. FRONTEND ‚Üî BACKEND TYPE MISMATCHES

### –û–±–∑–æ—Ä

**–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:** 8 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π
**–í–ª–∏—è–Ω–∏–µ:** Runtime errors, UX –ø—Ä–æ–±–ª–µ–º—ã, confusion
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0-P1

---

### Mismatch 1: book.is_processing

**–¢–∏–ø:** Missing field –≤ Backend response
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0 (–ö–†–ò–¢–ò–ß–ù–û)

#### Frontend Expectation

```typescript
// frontend/src/types/state.ts:45
interface Book {
  id: string;
  title: string;
  author: string;
  is_processing: boolean;  // –û–ñ–ò–î–ê–ï–¢–°–Ø!
  parsing_progress?: number;
}

// frontend/src/components/Books/BookUploadModal.tsx:120
if (book.is_processing) {
  return <ParsingSpinner progress={book.parsing_progress} />;
}
```

#### Backend Reality

```python
# backend/app/routers/books/crud.py:360
@router.get("/{book_id}")
async def get_book(book_id: UUID) -> Dict[str, Any]:
    book = await book_service.get_by_id(book_id)

    return {
        "id": str(book.id),
        "title": book.title,
        "author": book.author,
        # is_processing –ù–ï –í–ö–õ–Æ–ß–ï–ù–û! ‚ùå
        # parsing_progress –ù–ï –í–ö–õ–Æ–ß–ï–ù–û! ‚ùå
    }
```

#### Impact

- ‚ùå Spinner –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –∫–Ω–∏–≥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚ùå UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "0 descriptions" –≤–º–µ—Å—Ç–æ "Processing..."
- ‚ùå Confusion: "–ü–æ—á–µ–º—É –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π?"

#### Fix

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
# backend/app/schemas/book.py

class BookDetailResponse(BaseModel):
    id: UUID4
    title: str
    author: str
    is_processing: bool  # –î–û–ë–ê–í–õ–ï–ù–û!
    parsing_progress: Optional[int] = None  # –î–û–ë–ê–í–õ–ï–ù–û!

    class Config:
        from_attributes = True


# backend/app/routers/books/crud.py

@router.get("/{book_id}", response_model=BookDetailResponse)
async def get_book(book_id: UUID) -> BookDetailResponse:
    book = await book_service.get_by_id(book_id)

    # –ü–æ–ª—É—á–∞–µ–º is_processing status
    is_processing = await book_service.is_book_processing(book_id)
    parsing_progress = await book_service.get_parsing_progress(book_id)

    return BookDetailResponse(
        id=book.id,
        title=book.title,
        author=book.author,
        is_processing=is_processing,  # ‚úÖ
        parsing_progress=parsing_progress  # ‚úÖ
    )
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 30 –º–∏–Ω—É—Ç
**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Spinner –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### Mismatch 2: book.genre (Enum vs String)

**–¢–∏–ø:** Type incompatibility
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1

#### Frontend Expectation

```typescript
// frontend/src/types/state.ts:50
interface Book {
  genre: string;  // Plain string
}

// frontend/src/components/Books/BookCard.tsx:80
<Badge>{book.genre}</Badge>  // –û–∂–∏–¥–∞–µ—Ç "fantasy", "sci-fi"
```

#### Backend Reality

```python
# backend/app/models/book.py:20
from enum import Enum

class BookGenre(str, Enum):
    FANTASY = "fantasy"
    SCI_FI = "sci_fi"  # ‚ùå Underscore!
    DETECTIVE = "detective"
    ROMANCE = "romance"

# backend/app/routers/books/crud.py
return {
    "genre": book.genre.value  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç "sci_fi" ‚ùå
}
```

#### Impact

- ‚ùå Frontend –ø–æ–ª—É—á–∞–µ—Ç "sci_fi" –≤–º–µ—Å—Ç–æ "sci-fi"
- ‚ùå Badge display: "sci_fi" (–Ω–µ–∫—Ä–∞—Å–∏–≤–æ)
- ‚ùå Filtering –ø–æ –∂–∞–Ω—Ä–∞–º –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### Fix (Option 1: Backend –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ kebab-case)

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1
class BookDetailResponse(BaseModel):
    genre: str

    @validator('genre', pre=True)
    def convert_genre(cls, v):
        if isinstance(v, BookGenre):
            # sci_fi ‚Üí sci-fi
            return v.value.replace('_', '-')
        return v
```

#### Fix (Option 2: Frontend –ø—Ä–∏–Ω–∏–º–∞–µ—Ç snake_case)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2
const genreDisplay: Record<string, string> = {
  'fantasy': 'Fantasy',
  'sci_fi': 'Sci-Fi',
  'detective': 'Detective',
  'romance': 'Romance'
};

<Badge>{genreDisplay[book.genre] || book.genre}</Badge>
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** Option 1 (Backend –ø—Ä–∏–≤–æ–¥–∏—Ç)
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 15 –º–∏–Ω—É—Ç

---

### Mismatch 3: description.description_type vs type

**–¢–∏–ø:** Field naming inconsistency
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1

#### Frontend Expectation

```typescript
// frontend/src/types/state.ts:100
interface Description {
  id: string;
  text: string;
  type: 'location' | 'character' | 'atmosphere';  // "type" ‚úÖ
}

// frontend/src/components/Reader/DescriptionModal.tsx:45
const icon = getIconForType(description.type);
```

#### Backend Reality

```python
# backend/app/models/description.py:25
class Description(Base):
    id: UUID
    text: str
    description_type: str  # "description_type" ‚ùå

# backend/app/schemas/description.py
class DescriptionResponse(BaseModel):
    id: UUID4
    text: str
    description_type: str  # ‚ùå Inconsistent naming
```

#### Impact

- ‚ùå Frontend –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `description.type` ‚Üí undefined
- ‚ùå Icons –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
- ‚ùå Filtering –ø–æ —Ç–∏–ø—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### Fix (Option 1: Backend –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–∏ serialization)

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1
class DescriptionResponse(BaseModel):
    id: UUID4
    text: str
    type: str  # Renamed from description_type

    class Config:
        from_attributes = True

    @classmethod
    def from_orm(cls, obj):
        return cls(
            id=obj.id,
            text=obj.text,
            type=obj.description_type  # Mapping
        )
```

#### Fix (Option 2: Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç description_type)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2
interface Description {
  id: string;
  text: string;
  description_type: 'location' | 'character' | 'atmosphere';  // Renamed
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** Option 1 (Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "type" –≤ API)
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 20 –º–∏–Ω—É—Ç

---

### Mismatch 4: auth response - missing user info

**–¢–∏–ø:** Missing nested object
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0 (–ö–†–ò–¢–ò–ß–ù–û)

#### Frontend Expectation

```typescript
// frontend/src/types/auth.ts:10
interface LoginResponse {
  access_token: string;
  token_type: string;
  user: {  // –û–ñ–ò–î–ê–ï–¢–°–Ø! ‚úÖ
    id: string;
    email: string;
    username: string;
    subscription_tier: string;
  };
}

// frontend/src/stores/auth.ts:45
const response = await api.post('/auth/login', credentials);
setUser(response.data.user);  // ‚ùå undefined!
```

#### Backend Reality

```python
# backend/app/routers/auth.py:80
@router.post("/login")
async def login(credentials: LoginRequest) -> Dict[str, Any]:
    token = await auth_service.authenticate(credentials)

    return {
        "access_token": token,
        "token_type": "bearer"
        # user info –û–¢–°–£–¢–°–¢–í–£–ï–¢! ‚ùå
    }
```

#### Impact

- ‚ùå –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ user = undefined
- ‚ùå UI –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç username, email
- ‚ùå Subscription tier –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
- ‚ùå –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ routes –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### Fix

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
# backend/app/schemas/auth.py

class UserInfo(BaseModel):
    id: UUID4
    email: str
    username: str
    subscription_tier: str

class LoginResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"
    user: UserInfo  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û!


# backend/app/routers/auth.py

@router.post("/login", response_model=LoginResponse)
async def login(credentials: LoginRequest) -> LoginResponse:
    user, token = await auth_service.authenticate(credentials)

    return LoginResponse(
        access_token=token,
        token_type="bearer",
        user=UserInfo(
            id=user.id,
            email=user.email,
            username=user.username,
            subscription_tier=user.subscription.tier
        )
    )
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 30 –º–∏–Ω—É—Ç
**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Auth flow —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é

---

### Mismatch 5: image.description_id

**–¢–∏–ø:** Missing field
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1

#### Frontend Expectation

```typescript
// frontend/src/types/state.ts:123
interface GeneratedImage {
  id: string;
  image_url: string;
  description_id: string;  // –ù–£–ñ–ù–û –¥–ª—è —Å–≤—è–∑–∏! ‚úÖ
  description_text: string;
}

// frontend/src/components/Reader/ImageModal.tsx:60
const description = descriptions.find(d => d.id === image.description_id);
```

#### Backend Reality

```python
# backend/app/schemas/image.py
class GeneratedImageResponse(BaseModel):
    id: UUID4
    image_url: str
    description_text: str
    # description_id –û–¢–°–£–¢–°–¢–í–£–ï–¢! ‚ùå

# backend/app/models/image.py
class GeneratedImage(Base):
    id: UUID
    description_id: UUID  # –ü–æ–ª–µ –ï–°–¢–¨ –≤ DB! ‚úÖ
    # –ù–æ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ response
```

#### Impact

- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤ UI
- ‚ùå Highlighting description –ø—Ä–∏ –ø–æ–∫–∞–∑–µ image –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå "Show in text" –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### Fix

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
class GeneratedImageResponse(BaseModel):
    id: UUID4
    image_url: str
    description_id: UUID4  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û!
    description_text: str
    status: str
    created_at: datetime

    class Config:
        from_attributes = True
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 10 –º–∏–Ω—É—Ç

---

### Mismatch 6: reading_progress.location (CFI vs page number)

**–¢–∏–ø:** Format incompatibility
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1

#### Frontend Expectation (epub.js)

```typescript
// frontend/src/hooks/useEpubReader.ts:180
interface ReadingProgress {
  location: string;  // CFI format: "epubcfi(/6/4[chap01ref]!/4/2/1:3)" ‚úÖ
  page: number;  // Deprecated
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
rendition.display(progress.location);  // –û–∂–∏–¥–∞–µ—Ç CFI
```

#### Backend Reality (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)

```python
# backend/app/models/book.py:ReadingProgress
class ReadingProgress(Base):
    current_page: int  # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç! ‚ùå
    total_pages: int
    # reading_location_cfi: str - –ï–°–¢–¨, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!
```

#### Impact

- ‚ùå –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ progress —á–∏—Ç–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
- ‚ùå CFI –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å Backend
- ‚ùå Cross-device reading position –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### Fix

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
# backend/app/schemas/reading_progress.py

class ReadingProgressResponse(BaseModel):
    book_id: UUID4
    reading_location_cfi: str  # Primary! ‚úÖ
    scroll_offset_percent: float  # 0-100% ‚úÖ

    # Legacy fields (deprecated)
    current_page: Optional[int] = None
    total_pages: Optional[int] = None

    last_read_at: datetime


class UpdateReadingProgressRequest(BaseModel):
    reading_location_cfi: str = Field(..., min_length=1)
    scroll_offset_percent: float = Field(..., ge=0, le=100)


# backend/app/routers/books/processing.py

@router.put("/{book_id}/progress", response_model=ReadingProgressResponse)
async def update_progress(
    book_id: UUID,
    progress: UpdateReadingProgressRequest,
    current_user: User = Depends(get_current_user)
) -> ReadingProgressResponse:
    updated = await book_progress_service.update_progress(
        book_id=book_id,
        user_id=current_user.id,
        cfi=progress.reading_location_cfi,  # ‚úÖ
        scroll_offset=progress.scroll_offset_percent  # ‚úÖ
    )

    return updated
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1 —á–∞—Å
**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Reading position —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### Mismatch 7: chapter.content (HTML vs plain text)

**–¢–∏–ø:** Format incompatibility
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2

#### Frontend Expectation

```typescript
// epub.js –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML
const chapterContent = await book.getChapterContent(chapterId);
// chapterContent = "<p>–ì–ª–∞–≤–∞ 1</p><p>–¢–µ–∫—Å—Ç...</p>" ‚úÖ
```

#### Backend Storage

```python
# backend/app/models/chapter.py
class Chapter(Base):
    content: str  # Plain text –ë–ï–ó HTML —Ç–µ–≥–æ–≤ ‚ùå

# –ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ
chapter_text = strip_html_tags(raw_content)  # –£–±–∏—Ä–∞–µ–º HTML
```

#### Impact

- ‚ùå Descriptions extracted from plain text
- ‚ùå Highlighting –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ HTML
- ‚ùå Formatting —Ç–µ—Ä—è–µ—Ç—Å—è

#### Fix

**–í–∞—Ä–∏–∞–Ω—Ç 1:** Backend —Ö—Ä–∞–Ω–∏—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1
class Chapter(Base):
    content: str  # HTML content ‚úÖ
    content_plain: str  # Plain text –¥–ª—è NLP ‚úÖ
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** Frontend –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç plain text ‚Üí HTML

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2
const htmlContent = convertPlainTextToHTML(chapter.content);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç 1 (—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 2 —á–∞—Å–∞

---

### Mismatch 8: Timestamp formats (ISO string vs datetime)

**–¢–∏–ø:** Serialization format
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2

#### Frontend Expectation

```typescript
interface Book {
  created_at: string;  // ISO 8601: "2025-11-03T10:30:00Z" ‚úÖ
}

const date = new Date(book.created_at);
```

#### Backend Reality (–∏–Ω–æ–≥–¥–∞)

```python
# –ù–µ–∫–æ—Ç–æ—Ä—ã–µ endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç datetime object
return {
    "created_at": book.created_at  # datetime object ‚ùå
}

# JSON serialization –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è!
```

#### Fix

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - Pydantic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç

class BookDetailResponse(BaseModel):
    created_at: datetime  # Pydantic ‚Üí ISO string ‚úÖ

    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 15 –º–∏–Ω—É—Ç

---

## Summary: Frontend ‚Üî Backend Mismatches

| # | Mismatch | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è | –í–ª–∏—è–Ω–∏–µ |
|---|----------|-----------|-------|---------|
| 1 | book.is_processing | P0 | 30 –º–∏–Ω | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (UX) |
| 2 | book.genre format | P1 | 15 –º–∏–Ω | –°—Ä–µ–¥–Ω–µ–µ (display) |
| 3 | description.type naming | P1 | 20 –º–∏–Ω | –°—Ä–µ–¥–Ω–µ–µ (icons) |
| 4 | auth.user missing | P0 | 30 –º–∏–Ω | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (auth) |
| 5 | image.description_id | P1 | 10 –º–∏–Ω | –°—Ä–µ–¥–Ω–µ–µ (linking) |
| 6 | reading_progress CFI | P1 | 1 —á–∞—Å | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (sync) |
| 7 | chapter.content format | P2 | 2 —á–∞—Å–∞ | –ù–∏–∑–∫–æ–µ (formatting) |
| 8 | Timestamp formats | P2 | 15 –º–∏–Ω | –ù–∏–∑–∫–æ–µ (display) |

**Total time:** ~5-6 —á–∞—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö P0-P1 fixes

---

## 2. DATABASE ‚Üî MODELS INCONSISTENCIES

### –û–±–∑–æ—Ä

**–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 9.2/10 (–û—Ç–ª–∏—á–Ω–æ)
**–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:** 2 –º–∏–Ω–æ—Ä–Ω—ã—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2-P3

---

### Inconsistency 1: Orphaned Model admin_settings.py

**–¢–∏–ø:** Model exists, table deleted
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2

#### Situation

```python
# –§–∞–π–ª –°–£–©–ï–°–¢–í–£–ï–¢
backend/app/models/admin_settings.py

class AdminSettings(Base):
    __tablename__ = "admin_settings"

    id: UUID
    key: str
    value: str
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
```

```sql
-- –¢–∞–±–ª–∏—Ü–∞ –£–î–ê–õ–ï–ù–ê –≤ migration
-- alembic/versions/xxx_remove_admin_settings.py

def upgrade():
    op.drop_table('admin_settings')
```

```bash
# –ù–∏–≥–¥–µ –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø
$ grep -r "AdminSettings" backend/app/
# 0 results (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–¥–µ–ª–∏)
```

#### Impact

- ‚ö†Ô∏è Confusion –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- ‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥
- ‚ö†Ô∏è SQLAlchemy –º–æ–∂–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ alembic autogenerate

#### Fix

```bash
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
rm backend/app/models/admin_settings.py

# –û–±–Ω–æ–≤–∏—Ç—å __init__.py –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
# backend/app/models/__init__.py
# from .admin_settings import AdminSettings  # –£–î–ê–õ–ò–¢–¨ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 5 –º–∏–Ω—É—Ç
**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** Grep –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç AdminSettings –≤ –∫–æ–¥–µ

---

### Inconsistency 2: VARCHAR vs ENUM Documentation

**–¢–∏–ø:** Documentation gap
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P3

#### Situation

–í SQLAlchemy –º–æ–¥–µ–ª—è—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã Enum –∫–ª–∞—Å—Å—ã, –Ω–æ –≤ Column definitions –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è String:

```python
# backend/app/models/book.py

class BookGenre(str, Enum):
    FANTASY = "fantasy"
    SCI_FI = "sci_fi"
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ

class Book(Base):
    # Enum –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Column!
    genre: Mapped[str] = mapped_column(String(50))  # ‚ùå –ù–ï Enum!

    # –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±—ã–ª–æ –±—ã:
    # genre: Mapped[BookGenre] = mapped_column(Enum(BookGenre))
```

#### Impact

- ‚ö†Ô∏è –ù–µ—Ç database-level validation
- ‚ö†Ô∏è –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π genre: "invalid_genre"
- ‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–µ—è—Å–Ω–∞

#### Fix (Option 1: Database ENUM)

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1 - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL ENUM
from sqlalchemy import Enum as SQLEnum

class Book(Base):
    genre: Mapped[BookGenre] = mapped_column(
        SQLEnum(BookGenre, name="book_genre_enum"),
        nullable=False
    )
```

**Migration:**

```python
# alembic/versions/xxx_add_genre_enum.py

def upgrade():
    # Create ENUM type
    op.execute("""
        CREATE TYPE book_genre_enum AS ENUM (
            'fantasy', 'sci_fi', 'detective', 'romance', 'horror',
            'thriller', 'historical', 'classic', 'other'
        )
    """)

    # Alter column type
    op.alter_column(
        'books',
        'genre',
        type_=sa.Enum(BookGenre, name='book_genre_enum')
    )
```

#### Fix (Option 2: Documentation —Ç–æ–ª—å–∫–æ)

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2 - –ü—Ä–æ—Å—Ç–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

class Book(Base):
    """
    ...

    Note: genre —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ VARCHAR(50) –≤ –ë–î, –Ω–æ –≤ –∫–æ–¥–µ
    –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è BookGenre enum –¥–ª—è type safety –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    Database-level validation –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏.
    """

    genre: Mapped[str] = mapped_column(String(50))
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** Option 2 (–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
**–ü—Ä–∏—á–∏–Ω–∞:** VARCHAR –¥–∞–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∂–∞–Ω—Ä—ã –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 15 –º–∏–Ω—É—Ç (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

---

### Inconsistency 3: Missing CASCADE - reading_sessions

**–¢–∏–ø:** Foreign key –±–µ–∑ ON DELETE CASCADE
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2

#### Situation

```sql
-- –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï
CREATE TABLE reading_sessions (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),  -- ‚ùå NO CASCADE
    book_id UUID REFERENCES books(id),  -- ‚ùå NO CASCADE
    started_at TIMESTAMP,
    ended_at TIMESTAMP
);
```

#### Impact

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ user –∏–ª–∏ book:

```sql
DELETE FROM users WHERE id = 'xxx';
-- ‚ùå ERROR: violates foreign key constraint "reading_sessions_user_id_fkey"
```

Orphaned sessions –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –ë–î.

#### Fix

```sql
-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - Migration

-- alembic/versions/xxx_add_cascade_reading_sessions.py

def upgrade():
    # Drop old constraints
    op.drop_constraint(
        'reading_sessions_user_id_fkey',
        'reading_sessions',
        type_='foreignkey'
    )
    op.drop_constraint(
        'reading_sessions_book_id_fkey',
        'reading_sessions',
        type_='foreignkey'
    )

    # Add new constraints with CASCADE
    op.create_foreign_key(
        'reading_sessions_user_id_fkey',
        'reading_sessions', 'users',
        ['user_id'], ['id'],
        ondelete='CASCADE'
    )

    op.create_foreign_key(
        'reading_sessions_book_id_fkey',
        'reading_sessions', 'books',
        ['book_id'], ['id'],
        ondelete='CASCADE'
    )


def downgrade():
    # Revert to old constraints (–±–µ–∑ CASCADE)
    op.drop_constraint(
        'reading_sessions_user_id_fkey',
        'reading_sessions',
        type_='foreignkey'
    )
    op.drop_constraint(
        'reading_sessions_book_id_fkey',
        'reading_sessions',
        type_='foreignkey'
    )

    op.create_foreign_key(
        'reading_sessions_user_id_fkey',
        'reading_sessions', 'users',
        ['user_id'], ['id']
    )

    op.create_foreign_key(
        'reading_sessions_book_id_fkey',
        'reading_sessions', 'books',
        ['book_id'], ['id']
    )
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1 —á–∞—Å
**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** User/book deletion —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

---

## Summary: Database ‚Üî Models

| # | Inconsistency | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è | –í–ª–∏—è–Ω–∏–µ |
|---|---------------|-----------|-------|---------|
| 1 | Orphaned admin_settings.py | P2 | 5 –º–∏–Ω | –ù–∏–∑–∫–æ–µ (cleanup) |
| 2 | VARCHAR vs ENUM docs | P3 | 15 –º–∏–Ω | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (clarity) |
| 3 | Missing CASCADE | P2 | 1 —á–∞—Å | –°—Ä–µ–¥–Ω–µ–µ (cleanup) |

**Total time:** ~1.5 —á–∞—Å–∞

**–û–±—â–∏–π –≤—ã–≤–æ–¥:** Database –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

---

## 3. API DOCUMENTATION ‚Üî IMPLEMENTATION

### –û–±–∑–æ—Ä

**Coverage:** 65% endpoints –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2
**–í—Ä–µ–º—è –Ω–∞ –ø–æ–ª–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:** 8-10 —á–∞—Å–æ–≤

---

### Gap 1: Missing Request/Response Examples

**Affected endpoints:** ~40 endpoints

#### Current State

```python
# ‚ùå –¢–ï–ö–£–©–ï–ï - –ù–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤
@router.post("/books/upload")
async def upload_book(file: UploadFile):
    """Upload a book file."""
    # –ù–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞!
```

#### Desired State

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
@router.post(
    "/books/upload",
    response_model=BookUploadResponse,
    responses={
        200: {
            "description": "Book uploaded successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "123e4567-e89b-12d3-a456-426614174000",
                        "title": "–í–æ–π–Ω–∞ –∏ –º–∏—Ä",
                        "author": "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π",
                        "is_processing": True,
                        "parsing_progress": 0
                    }
                }
            }
        },
        400: {
            "description": "Invalid file format",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Only EPUB and FB2 formats are supported"
                    }
                }
            }
        }
    }
)
async def upload_book(
    file: UploadFile,
    current_user: User = Depends(get_current_user)
) -> BookUploadResponse:
    """
    Upload a book file for processing.

    Supported formats:
    - EPUB (.epub)
    - FB2 (.fb2)

    Process:
    1. File validation
    2. Metadata extraction
    3. Async parsing task creation
    4. Return book info with is_processing=True

    Returns:
        Book info with processing status
    """
    ...
```

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 8-10 —á–∞—Å–æ–≤ (–¥–ª—è –≤—Å–µ—Ö endpoints)

---

### Gap 2: Missing Error Response Documentation

**Affected endpoints:** ~30 endpoints

–ú–Ω–æ–≥–∏–µ endpoints –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å errors, –Ω–æ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç –∫–∞–∫–∏–µ.

#### Fix

–î–æ–±–∞–≤–∏—Ç—å `responses` –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≤—Å–µ—Ö endpoints:

```python
@router.get(
    "/{book_id}",
    response_model=BookDetailResponse,
    responses={
        404: {"description": "Book not found"},
        403: {"description": "Access denied - not your book"},
        500: {"description": "Internal server error"}
    }
)
```

---

## 4. TESTS ‚Üî CODE COVERAGE GAPS

### Backend Coverage Gaps

**Current:** 29% (—Ü–µ–ª–µ–≤–∞—è 70%)

#### Critical Gaps

| Module | Coverage | Target | Gap |
|--------|----------|--------|-----|
| app/routers/books/crud.py | 20% | 70% | -50% |
| app/services/multi_nlp_manager.py | 0% | 80% | -80% |
| app/services/book_parser.py | 30% | 70% | -40% |
| app/core/cache.py | 15% | 60% | -45% |
| app/services/image_generator.py | 25% | 70% | -45% |

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 2-3 –Ω–µ–¥–µ–ª–∏

---

### Frontend Coverage Gaps

**Current:** 40% (—Ü–µ–ª–µ–≤–∞—è 70%)

#### Critical Gaps

| Module | Coverage | Target | Gap |
|--------|----------|--------|-----|
| hooks/useDescriptionHighlighting.ts | 0% | 80% | -80% |
| hooks/useEpubReader.ts | 0% | 80% | -80% |
| hooks/useAuth.ts | 0% | 70% | -70% |
| hooks/useBookProgress.ts | 0% | 70% | -70% |
| components/Reader/EpubReader.tsx | 30% | 70% | -40% |

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1-2 –Ω–µ–¥–µ–ª–∏

---

## üìä PRIORITY MATRIX

### P0 (–ö—Ä–∏—Ç–∏—á–Ω–æ - –ù–∞—á–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. ‚úÖ book.is_processing missing (30 –º–∏–Ω)
2. ‚úÖ auth.user missing (30 –º–∏–Ω)
3. ‚úÖ reading_progress CFI sync (1 —á–∞—Å)

**Total P0:** 2 —á–∞—Å–∞

---

### P1 (–í–∞–∂–Ω–æ - –°–ª–µ–¥—É—é—â–∏–µ 2-3 –Ω–µ–¥–µ–ª–∏)

1. ‚úÖ book.genre format (15 –º–∏–Ω)
2. ‚úÖ description.type naming (20 –º–∏–Ω)
3. ‚úÖ image.description_id (10 –º–∏–Ω)
4. ‚úÖ TypeScript errors (6-8 —á–∞—Å–æ–≤)
5. ‚úÖ React hooks testing (1-2 –Ω–µ–¥–µ–ª–∏)
6. ‚úÖ Backend testing coverage (2-3 –Ω–µ–¥–µ–ª–∏)

**Total P1:** 3-5 –Ω–µ–¥–µ–ª—å

---

### P2 (–°—Ä–µ–¥–Ω–µ - –ú–µ—Å—è—Ü 2)

1. ‚úÖ chapter.content format (2 —á–∞—Å–∞)
2. ‚úÖ Timestamp formats (15 –º–∏–Ω)
3. ‚úÖ Missing CASCADE (1 —á–∞—Å)
4. ‚úÖ API documentation (8-10 —á–∞—Å–æ–≤)
5. ‚úÖ Orphaned admin_settings (5 –º–∏–Ω)

**Total P2:** ~2 –Ω–µ–¥–µ–ª–∏

---

### P3 (–ù–∏–∑–∫–æ - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥)

1. ‚úÖ VARCHAR vs ENUM docs (15 –º–∏–Ω)

**Total P3:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ

---

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–í—Å–µ–≥–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–∞–π–¥–µ–Ω–æ:** 14
**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö (P0):** 3
**–í–∞–∂–Ω—ã—Ö (P1):** 6
**–°—Ä–µ–¥–Ω–∏—Ö (P2):** 4
**–ù–∏–∑–∫–∏—Ö (P3):** 1

**–û–±—â–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ P0-P1:** 3-5 –Ω–µ–¥–µ–ª—å

**–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã:**
- Frontend ‚Üî Backend type safety —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è
- Database –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)
- Testing coverage - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π gap
- API documentation —Ç—Ä–µ–±—É–µ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ù–∞—á–∞—Ç—å —Å P0 fixes (2 —á–∞—Å–∞)
2. P1 fixes –≤ —Ç–µ—á–µ–Ω–∏–µ 2-3 –Ω–µ–¥–µ–ª—å
3. P2 fixes –≤ –º–µ—Å—è—Ü 2
4. Continuous tracking –≤ current-status.md

---

**–°–æ–∑–¥–∞–Ω–æ:** 03 –Ω–æ—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 1.0
**–ê–≤—Ç–æ—Ä:** Documentation Master Agent

# –ê–ù–ê–õ–ò–ó –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê –¢–ï–°–¢–û–í–û–ô –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´

**–î–∞—Ç–∞:** 2025-10-24
**–ü—Ä–æ–µ–∫—Ç:** BookReader AI
**–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** Testing & QA Specialist Agent

---

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **–ó–∞—è–≤–ª–µ–Ω–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:** 75%+ (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:** 4 –≤—Å–µ–≥–æ (3 backend, 1 frontend)
- **Backend —Ç–µ—Å—Ç—ã:** 30 —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤, –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö auth + books APIs
- **Frontend —Ç–µ—Å—Ç—ã:** 12 —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ BookReader
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∞:** ~904 —Å—Ç—Ä–æ–∫–∏
- **–í—Å–µ–≥–æ production –∫–æ–¥–∞:** ~23,624 —Å—Ç—Ä–æ–∫–∏ (13,411 backend + 10,213 frontend)
- **–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –∫ –∫–æ–¥—É:** ~3.8% (–ö–†–ò–¢–ò–ß–ù–û: –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 20-40%)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ö–æ–¥–∫–∏

üî¥ **–°–ï–†–¨–ï–ó–ù–´–ô –î–ï–§–ò–¶–ò–¢ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø**
- **0% –ø–æ–∫—Ä—ã—Ç–∏—è** –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π Multi-NLP —Å–∏—Å—Ç–µ–º—ã (627 —Å—Ç—Ä–æ–∫, 0 —Ç–µ—Å—Ç–æ–≤)
- **0% –ø–æ–∫—Ä—ã—Ç–∏—è** –¥–ª—è EPUB –ø–∞—Ä—Å–µ—Ä–∞ —Å CFI (796 —Å—Ç—Ä–æ–∫, 0 —Ç–µ—Å—Ç–æ–≤)
- **0% –ø–æ–∫—Ä—ã—Ç–∏—è** –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ book service (621 —Å—Ç—Ä–æ–∫, 0 —Ç–µ—Å—Ç–æ–≤)
- **0% –ø–æ–∫—Ä—ã—Ç–∏—è** –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ EpubReader (835 —Å—Ç—Ä–æ–∫, 0 —Ç–µ—Å—Ç–æ–≤)
- **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:** 14/15 —Ñ–∞–π–ª–æ–≤ services –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:** 6/7 —Ñ–∞–π–ª–æ–≤ router –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:** 13/14 frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

### –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤

**–í–´–°–û–ö–û–†–ò–°–ö–û–í–´–ï –û–ë–õ–ê–°–¢–ò (–ë–µ–∑ —Ç–µ—Å—Ç–æ–≤):**
1. Multi-NLP Manager - ensemble voting, adaptive selection
2. Book Parser - CFI generation, EPUB/FB2 parsing
3. Book Service - database operations, file handling
4. NLP Processors - SpaCy, Natasha, Stanza integration
5. Image Generator - pollinations.ai integration
6. EpubReader - CFI navigation, progress tracking
7. –í—Å–µ Zustand stores - state management
8. –í—Å–µ custom hooks - business logic

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∫—Ä—ã—Ç–∏—è

### Backend –º–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –§–∞–π–ª—ã | LOC | –¢–µ—Å—Ç —Ñ–∞–π–ª—ã | –¢–µ—Å—Ç-–∫–µ–π—Å—ã | –û—Ü–µ–Ω–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------|-----|------------|------------|-----------------|----------|
| **app/services** | 15 | ~4,500 | 0 | 0 | **0%** | CRITICAL |
| - multi_nlp_manager.py | 1 | 627 | 0 | 0 | 0% | P0 |
| - book_parser.py | 1 | 796 | 0 | 0 | 0% | P0 |
| - book_service.py | 1 | 621 | 0 | 0 | 0% | P0 |
| - nlp_processor.py | 1 | ~400 | 0 | 0 | 0% | P0 |
| - image_generator.py | 1 | ~300 | 0 | 0 | 0% | P1 |
| - auth_service.py | 1 | ~250 | 0 | 0 | 0% | P1 |
| - –î—Ä—É–≥–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã | 9 | ~2,500 | 0 | 0 | 0% | P2 |
| **app/routers** | 7 | ~2,100 | 2 | 30 | **~25%** | HIGH |
| - auth.py | 1 | ~300 | 1 | 13 | ~60% | OK |
| - books.py (16 endpoints) | 1 | ~600 | 1 | 17 | ~40% | NEEDS MORE |
| - admin.py (5 endpoints) | 1 | ~400 | 0 | 0 | 0% | P0 |
| - nlp.py | 1 | ~200 | 0 | 0 | 0% | P0 |
| - images.py | 1 | ~250 | 0 | 0 | 0% | P1 |
| - users.py | 1 | ~200 | 0 | 0 | 0% | P1 |
| **app/models** | 7 | ~1,400 | 0 | 0 | **0%** | HIGH |
| **app/core** | ~5 | ~800 | 0 | 0 | **0%** | MEDIUM |

### Frontend –º–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –§–∞–π–ª—ã | LOC | –¢–µ—Å—Ç —Ñ–∞–π–ª—ã | –¢–µ—Å—Ç-–∫–µ–π—Å—ã | –û—Ü–µ–Ω–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------|-----|------------|------------|-----------------|----------|
| **components/** | 14 | ~3,500 | 1 | 12 | **~5%** | CRITICAL |
| - Reader/EpubReader.tsx | 1 | 835 | 0 | 0 | 0% | P0 |
| - Reader/BookReader.tsx | 1 | ~400 | 1 | 12 | ~30% | NEEDS MORE |
| - Books/BookUploadModal.tsx | 1 | ~300 | 0 | 0 | 0% | P0 |
| - Images/ImageModal.tsx | 1 | ~200 | 0 | 0 | 0% | P1 |
| - UI/ParsingOverlay.tsx | 1 | ~150 | 0 | 0 | 0% | P1 |
| - –î—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã | 9 | ~1,615 | 0 | 0 | 0% | P2 |
| **stores/** | 6 | ~3,200 | 0 | 0 | **0%** | CRITICAL |
| - reader.ts | 1 | ~690 | 0 | 0 | 0% | P0 |
| - books.ts | 1 | ~450 | 0 | 0 | 0% | P0 |
| - auth.ts | 1 | ~690 | 0 | 0 | 0% | P0 |
| - images.ts | 1 | ~380 | 0 | 0 | 0% | P1 |
| - ui.ts | 1 | ~380 | 0 | 0 | 0% | P1 |
| **hooks/** | 1 | ~160 | 0 | 0 | **0%** | MEDIUM |
| **api/** | ~5 | ~800 | 0 | 0 | **0%** | MEDIUM |

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

### 1. Multi-NLP —Å–∏—Å—Ç–µ–º–∞ (–í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** `backend/app/services/multi_nlp_manager.py` (627 —Å—Ç—Ä–æ–∫)
**–¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã:** 0
**–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**

#### –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (0/25 —Ç–µ—Å—Ç–æ–≤)
```python
# Processing Modes
- SINGLE mode processing
- PARALLEL mode processing
- SEQUENTIAL mode processing
- ENSEMBLE mode with voting
- ADAPTIVE mode with auto-selection

# Ensemble Voting Algorithm
- Weighted consensus calculation
- Consensus threshold validation (0.6)
- Processor weight handling (SpaCy: 1.0, Natasha: 1.2, Stanza: 0.8)
- Description deduplication
- Context enrichment

# Processor Management
- Processor initialization (3 processors)
- Processor configuration loading
- Processor status check
- Processor selection logic
- Fallback handling when processors fail

# Edge Cases
- Empty text input
- Very long text (>100KB)
- Text with special characters
- Concurrent processing requests
- Processor timeout handling
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. **Ensemble voting —Å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏** - –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –Ω–µ —Å–æ–≥–ª–∞—Å–Ω—ã?
2. **–õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –≤ Adaptive mode** - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞?
3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞** - –ß—Ç–æ –µ—Å–ª–∏ SpaCy –ø–∞–¥–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏?
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π** - –ú–æ–∂–µ—Ç –ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤?
5. **–†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞** - –¢–æ—á–Ω—ã –ª–∏ –æ—Ü–µ–Ω–∫–∏?

**–ü—Ä–∏–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞:**
```python
@pytest.mark.asyncio
async def test_ensemble_voting_consensus():
    """Test ensemble voting reaches consensus correctly."""
    # SpaCy finds: "dark forest"
    # Natasha finds: "—Ç–µ–º–Ω—ã–π –ª–µ—Å" (same in Russian)
    # Stanza finds: "dark woods" (different)

    # Expected: "dark forest" wins (SpaCy 1.0 + Natasha 1.2 = 2.2 vs Stanza 0.8)
    # But we have ZERO tests for this!
```

### 2. EPUB Parser —Å CFI (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `backend/app/services/book_parser.py` (796 —Å—Ç—Ä–æ–∫)
**–¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã:** 0
**–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**

#### –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (0/30 —Ç–µ—Å—Ç–æ–≤)
```python
# EPUB Parsing
- Parse EPUB structure (spine, TOC)
- Extract chapters from EPUB
- Generate CFI (Canonical Fragment Identifier)
- Extract book metadata
- Handle malformed EPUB files

# FB2 Parsing
- Parse FB2 structure
- Extract chapters from FB2
- Extract FB2 metadata
- Handle encoding issues

# CFI Generation (NEW October 2025)
- Generate CFI for chapter positions
- Validate CFI format
- CFI to position mapping
- Position to CFI mapping
- Handle invalid CFI

# Edge Cases
- EPUB without TOC
- EPUB with nested sections
- Very large EPUB (>100MB)
- EPUB with images
- Corrupted ZIP file
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. **–¢–æ—á–Ω–æ—Å—Ç—å CFI** - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ CFI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —á—Ç–µ–Ω–∏—è?
2. **–í–∞—Ä–∏–∞–Ω—Ç—ã EPUB** - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ EPUB 2.0 vs 3.0?
3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π** - –ê —á—Ç–æ –Ω–∞—Å—á–µ—Ç —Ñ–∞–π–ª–æ–≤ –Ω–µ –≤ UTF8?
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–º—è—Ç–∏** - –°—Ç—Ä–∏–º–∏—Ç –ª–∏ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ?

**–ü—Ä–∏–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞:**
```python
@pytest.mark.asyncio
async def test_cfi_position_mapping_accuracy():
    """Test CFI correctly maps to reading position."""
    # User reads to chapter 3, position 45.5%
    # Expected CFI: epubcfi(/6/8[chapter-3]!/4/2:234)
    # On reload: Should restore exact same position
    # We have NO tests for this critical functionality!
```

### 3. Book Service –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `backend/app/services/book_service.py` (621 —Å—Ç—Ä–æ–∫)
**–¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã:** 0
**–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**

#### –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (0/35 —Ç–µ—Å—Ç–æ–≤)
```python
# Book Management
- create_book_from_upload (with file handling)
- get_book_by_id (with relationships)
- update_book_metadata
- delete_book (with cascade)
- list_user_books (with pagination)

# Reading Progress
- update_reading_progress (with CFI)
- get_reading_progress
- calculate_progress_percentage
- track_reading_session
- reading_statistics

# Chapter Management
- get_chapter_by_number
- get_chapter_with_descriptions
- count_chapters
- chapter_word_count

# File Operations
- File upload validation
- File size limits (50MB)
- File format validation (EPUB/FB2)
- Storage path management
- File cleanup on deletion

# Edge Cases
- Duplicate book upload
- Invalid UUID handling
- Concurrent progress updates
- Orphaned file cleanup
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. **Reading progress —Å CFI** - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç CFI?
2. **–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç 5 –∫–Ω–∏–≥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?
3. **–û—à–∏–±–∫–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã** - –ß—Ç–æ –µ—Å–ª–∏ –¥–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω?
4. **–û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ë–î** - –û—á–∏—â–∞—é—Ç—Å—è –ª–∏ —Ñ–∞–π–ª—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ?

### 4. EpubReader –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `frontend/src/components/Reader/EpubReader.tsx` (835 —Å—Ç—Ä–æ–∫)
**–¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã:** 0
**–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**

#### –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (0/40 —Ç–µ—Å—Ç–æ–≤)
```python
# epub.js Integration
- Initialize epub.js Book instance
- Create Rendition
- Load EPUB from ArrayBuffer
- CFI navigation
- Location change handling

# Reading Progress
- Save progress to backend (CFI + scroll %)
- Restore progress on load
- Calculate chapter from location
- Progress debouncing (avoid spam)
- Offline progress caching

# User Interactions
- Click on description to show image
- Navigate between chapters
- Scroll handling
- Keyboard shortcuts
- Touch gestures (mobile)

# Description Highlighting
- Load descriptions from backend
- Match descriptions to text
- Highlight descriptions in content
- Show image modal on click
- Handle missing images

# Error Handling
- EPUB download failure
- Invalid CFI restoration
- Missing chapters
- Network errors
- epub.js errors

# Performance
- Memory cleanup on unmount
- Debounce progress saves
- Lazy load images
- Cancel pending requests
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. **–¢–æ—á–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è CFI** - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏ —Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏?
2. **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π** - –ù–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞–¥–µ–∂–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞?
3. **–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** - –û—á–∏—â–∞—é—Ç—Å—è –ª–∏ —Ä–µ—Å—É—Ä—Å—ã epub.js?
4. **–û—Ñ–ª–∞–π–Ω –ø–æ–≤–µ–¥–µ–Ω–∏–µ** - –ß—Ç–æ –µ—Å–ª–∏ —Å–µ—Ç—å –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—è?

**–ü—Ä–∏–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞:**
```tsx
it('restores exact reading position from CFI', async () => {
  // User was at chapter 3, 45.5% scroll
  // CFI: epubcfi(/6/8[chapter-3]!/4/2:234)
  // scroll_offset_percent: 45.5

  // On component mount:
  // 1. Should load EPUB
  // 2. Should navigate to CFI
  // 3. Should scroll to 45.5%
  // 4. User should see EXACT same text as before

  // WE HAVE NO TEST FOR THIS!
});
```

### 5. Zustand Stores (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª—ã:** `frontend/src/stores/*.ts` (3,200 —Å—Ç—Ä–æ–∫)
**–¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã:** 0
**–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** –í–´–°–û–ö–ò–ô

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**

#### Reader Store (690 —Å—Ç—Ä–æ–∫)
```typescript
// State Management
- CFI navigation state
- Current chapter tracking
- Progress calculation
- Font settings
- Theme management

// Actions
- updateReadingProgress(bookId, chapter, progress)
- setCurrentLocation(cfi, scroll)
- saveProgressToBackend()
- restoreProgress()
- updateSettings()

// Edge Cases
- Multiple books open
- Rapid progress updates
- Offline state persistence
- State rehydration
```

#### Books Store (450 —Å—Ç—Ä–æ–∫)
```typescript
// Book List Management
- Fetch books with pagination
- Upload book with file
- Delete book
- Update book metadata
- Filter/sort books

// Edge Cases
- Concurrent uploads
- Large file handling
- Upload progress tracking
- Error recovery
```

#### Auth Store (690 —Å—Ç—Ä–æ–∫)
```typescript
// Authentication
- Login/logout
- Token management
- Token refresh
- Session persistence

// Edge Cases
- Token expiration handling
- Concurrent requests with expired token
- Logout cleanup
```

---

## –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤

### 1. –•—Ä—É–ø–∫–∏–µ —Ç–µ—Å—Ç—ã

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- **test_books.py** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—è–∂–µ–ª–æ–µ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ (AsyncMock –¥–ª—è —Ü–µ–ª—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
- –¢–µ—Å—Ç—ã –º–æ–∫–∏—Ä—É—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–æ–≤, –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä (—Ç–æ–ª—å–∫–æ 3 —Ñ–∏–∫—Å—Ç—É—Ä—ã)
- –•–∞—Ä–¥–∫–æ–¥ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–µ—Ç —Ñ–∞–±—Ä–∏–∫)

**–ü—Ä–∏–º–µ—Ä —Ö—Ä—É–ø–∫–æ–≥–æ —Ç–µ—Å—Ç–∞:**
```python
# test_books.py:32
@patch('app.services.book_service.BookService.create_book_with_file')
async def test_upload_book_success(self, mock_create_book, ...):
    # Problem: Mocks the ENTIRE service method
    # Doesn't test: File validation, DB transaction, parser integration
    # Will break if: Service interface changes
    # Better: Use real service with test database
```

**–í–ª–∏—è–Ω–∏–µ:**
- –¢–µ—Å—Ç—ã –Ω–µ –ª–æ–≤—è—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –±–∞–≥–∏
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ª–æ–º–∞–µ—Ç —Ç–µ—Å—Ç—ã
- –õ–æ–∂–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –ø–æ–∫—Ä—ã—Ç–∏–∏

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –í—Å–µ —Ç–µ—Å—Ç—ã –≤ –ø–ª–æ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (`tests/test_*.py`)
- –ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º (unit vs integration)
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–∞—Ä–∫–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤ (–Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é)
- –ù–µ—Ç –º–æ–¥—É–ª–µ–π —Ñ–∏–∫—Å—Ç—É—Ä (–≤—Å–µ –≤ conftest.py)

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
backend/tests/
‚îú‚îÄ‚îÄ unit/               # Fast, isolated tests
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_multi_nlp_manager.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_book_parser.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_book_service.py
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îú‚îÄ‚îÄ integration/        # API + DB tests
‚îÇ   ‚îú‚îÄ‚îÄ test_books_api.py
‚îÇ   ‚îú‚îÄ‚îÄ test_auth_api.py
‚îÇ   ‚îî‚îÄ‚îÄ test_nlp_api.py
‚îú‚îÄ‚îÄ e2e/               # Full workflow tests
‚îÇ   ‚îî‚îÄ‚îÄ test_book_upload_workflow.py
‚îú‚îÄ‚îÄ fixtures/          # Shared test data
‚îÇ   ‚îú‚îÄ‚îÄ books.py
‚îÇ   ‚îú‚îÄ‚îÄ users.py
‚îÇ   ‚îî‚îÄ‚îÄ epub_samples.py
‚îî‚îÄ‚îÄ conftest.py        # Pytest configuration
```

### 3. –ù–µ—Ç —Ñ–∞–±—Ä–∏–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –•–∞—Ä–¥–∫–æ–¥ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∏–∫—Å—Ç—É—Ä–∞—Ö
- –ù–µ—Ç –≤–∞—Ä–∏–∞—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ—Å—Ç–∞—Ö
- –ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ç–∏–ø–∞ factory_boy –∏–ª–∏ faker

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# conftest.py:104
@pytest.fixture
def sample_user_data():
    return {
        "email": "test@example.com",  # Always same email
        "password": "testpassword123",
        "full_name": "Test User"
    }
```

**–ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏ (–¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω—É–∂–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ email)
- –°–ª–æ–∂–Ω–æ –¥–µ–±–∞–∂–∏—Ç—å (–∫–∞–∫–æ–π —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–ª –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ?)

**–†–µ—à–µ–Ω–∏–µ:**
```python
# tests/factories/user_factory.py
import factory
from faker import Faker

fake = Faker()

class UserFactory(factory.Factory):
    class Meta:
        model = dict

    email = factory.LazyFunction(lambda: fake.email())
    password = factory.LazyFunction(lambda: fake.password())
    full_name = factory.LazyFunction(lambda: fake.name())

# Usage in tests
user1 = UserFactory.create()  # Unique data
user2 = UserFactory.create(email="specific@test.com")  # Override
```

### 4. –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
- –ù–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ—Ç–∫–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ (—Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ)

**–¢–µ–∫—É—â–∏–π conftest.py:**
```python
@pytest_asyncio.fixture(scope="function")
async def test_db():
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)  # Slow!
    yield
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)    # Slow!
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—Ö–µ–º—É
- 30 —Ç–µ—Å—Ç–æ–≤ = 30x —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã
- –ë—É–¥–µ—Ç –û–ß–ï–ù–¨ –º–µ–¥–ª–µ–Ω–Ω—ã–º —Å 200+ —Ç–µ—Å—Ç–∞–º–∏

**–õ—É—á—à–∏–π –ø–æ–¥—Ö–æ–¥:**
```python
@pytest_asyncio.fixture(scope="session")
async def test_db_engine():
    # Create schema ONCE per session
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield test_engine
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)

@pytest_asyncio.fixture(scope="function")
async def db_session(test_db_engine):
    # Use transaction rollback per test (FAST)
    async with AsyncSession(test_db_engine) as session:
        await session.begin()
        yield session
        await session.rollback()
```

### 5. –ü—Ä–æ–±–ª–µ–º—ã Frontend —Ç–µ—Å—Ç–æ–≤

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ 1 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (BookReader.tsx)
- –¢—è–∂–µ–ª–æ–µ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ (–º–æ–∫–∏—Ä—É–µ—Ç React Router, stores, API)
- –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- –ù–µ—Ç E2E —Ç–µ—Å—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º—ã BookReader.test.tsx:**
```tsx
// Lines 32-42: Mocks entire store
vi.mock('@/stores/reader', () => ({
  useReaderStore: () => mockReaderStore,
}));

// Lines 40-42: Mocks API
vi.mock('@/api/books', () => ({
  booksAPI: mockBooksAPI,
}));

// Problem: Test doesn't verify real store behavior!
```

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è custom hooks
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Zustand stores
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ API
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ epub.js
- –ù–µ—Ç accessibility —Ç–µ—Å—Ç–æ–≤
- –ù–µ—Ç performance —Ç–µ—Å—Ç–æ–≤

---

## –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤

### 1. Unit —Ç–µ—Å—Ç—ã (–ö–†–ò–¢–ò–ß–ù–û)

**Backend - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Multi-NLP Manager (–Ω—É–∂–Ω–æ 25 —Ç–µ—Å—Ç–æ–≤)
- Book Parser (–Ω—É–∂–Ω–æ 30 —Ç–µ—Å—Ç–æ–≤)
- Book Service (–Ω—É–∂–Ω–æ 35 —Ç–µ—Å—Ç–æ–≤)
- NLP Processor (–Ω—É–∂–Ω–æ 20 —Ç–µ—Å—Ç–æ–≤)
- Image Generator (–Ω—É–∂–Ω–æ 15 —Ç–µ—Å—Ç–æ–≤)
- Auth Service (–Ω—É–∂–Ω–æ 15 —Ç–µ—Å—Ç–æ–≤)
- –í—Å–µ –º–µ—Ç–æ–¥—ã –º–æ–¥–µ–ª–µ–π (–Ω—É–∂–Ω–æ 30 —Ç–µ—Å—Ç–æ–≤)

**Frontend - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- EpubReader –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–Ω—É–∂–Ω–æ 40 —Ç–µ—Å—Ç–æ–≤)
- BookUploadModal (–Ω—É–∂–Ω–æ 15 —Ç–µ—Å—Ç–æ–≤)
- ImageModal (–Ω—É–∂–Ω–æ 10 —Ç–µ—Å—Ç–æ–≤)
- ParsingOverlay (–Ω—É–∂–Ω–æ 8 —Ç–µ—Å—Ç–æ–≤)
- –í—Å–µ Zustand stores (–Ω—É–∂–Ω–æ 50 —Ç–µ—Å—Ç–æ–≤)
- –í—Å–µ custom hooks (–Ω—É–∂–Ω–æ 10 —Ç–µ—Å—Ç–æ–≤)

**–í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Unit —Ç–µ—Å—Ç–æ–≤:** ~303

### 2. Integration —Ç–µ—Å—Ç—ã (–í–´–°–û–ö–ò–ô)

**Backend - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Admin API (5 endpoints, –Ω—É–∂–Ω–æ 15 —Ç–µ—Å—Ç–æ–≤)
- NLP API (–Ω—É–∂–Ω–æ 10 —Ç–µ—Å—Ç–æ–≤)
- Images API (–Ω—É–∂–Ω–æ 12 —Ç–µ—Å—Ç–æ–≤)
- Users API (–Ω—É–∂–Ω–æ 10 —Ç–µ—Å—Ç–æ–≤)
- Book upload workflow (–Ω—É–∂–Ω–æ 10 —Ç–µ—Å—Ç–æ–≤)
- Reading progress workflow (–Ω—É–∂–Ω–æ 8 —Ç–µ—Å—Ç–æ–≤)

**Frontend - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Book upload flow (–Ω—É–∂–Ω–æ 10 —Ç–µ—Å—Ç–æ–≤)
- Reading flow with CFI (–Ω—É–∂–Ω–æ 15 —Ç–µ—Å—Ç–æ–≤)
- Authentication flow (–Ω—É–∂–Ω–æ 8 —Ç–µ—Å—Ç–æ–≤)
- Image generation trigger flow (–Ω—É–∂–Ω–æ 6 —Ç–µ—Å—Ç–æ–≤)

**–í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Integration —Ç–µ—Å—Ç–æ–≤:** ~94

### 3. E2E —Ç–µ—Å—Ç—ã (–°–†–ï–î–ù–ò–ô)

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Complete book reading journey (upload ‚Üí parse ‚Üí read ‚Üí progress)
- User registration ‚Üí subscription ‚Üí book upload
- Multi-device reading sync
- Offline reading ‚Üí online sync

**–í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç E2E —Ç–µ—Å—Ç–æ–≤:** ~15

### 4. Performance —Ç–µ—Å—Ç—ã (–°–†–ï–î–ù–ò–ô)

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Multi-NLP benchmark (processing time, quality score)
- Book parser benchmark (large EPUB files)
- API load tests (concurrent users)
- Frontend performance (Lighthouse CI)
- Memory leak detection

**–í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Performance —Ç–µ—Å—Ç–æ–≤:** ~20

### 5. Accessibility —Ç–µ—Å—Ç—ã (–ù–ò–ó–ö–ò–ô)

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Keyboard navigation (EpubReader)
- Screen reader support
- Color contrast
- ARIA labels

**–í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç A11y —Ç–µ—Å—Ç–æ–≤:** ~10

---

## –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### 1. –ü—Ä–æ–±–ª–µ–º—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã pytest.ini:**
```ini
# Line 14: Coverage threshold set but not met
--cov-fail-under=70

# Problem: No tests for 90% of codebase, but threshold not failing?
# Likely: Coverage only measured for tested files, not whole codebase
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```ini
[tool:pytest]
addopts =
    --cov=app
    --cov-report=term-missing:skip-covered
    --cov-report=html:htmlcov
    --cov-fail-under=70
    --cov-branch  # Add branch coverage
```

**–ü—Ä–æ–±–ª–µ–º—ã vitest.config.ts:**
```typescript
// Line 16: setupFiles points to non-existent path initially
setupFiles: './src/test/setup.ts',

// Missing: Coverage thresholds
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
coverage: {
  reporter: ['text', 'json', 'html'],
  all: true,  // Include all files, not just tested ones
  lines: 70,
  functions: 70,
  branches: 70,
  statements: 70,
  exclude: [
    'node_modules/',
    'src/test/',
    '**/*.d.ts',
    '**/*.config.*',
    '**/dist/**',
  ],
}
```

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã

**Backend –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Test data factories (factory_boy)
- Async test helpers
- Database seeders
- Mock NLP processors
- Sample EPUB/FB2 files

**Frontend –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Custom render functions (with providers)
- MSW (Mock Service Worker) for API mocking
- Test data generators
- epub.js mock
- Zustand test utilities

### 3. CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Pre-commit test hooks
- GitHub Actions workflow for tests
- Coverage reporting to PR comments
- Performance regression detection
- E2E tests in staging

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- Testing guide for contributors
- How to write good tests
- Test data management guide
- Troubleshooting failing tests

---

## –û—Ü–µ–Ω–æ—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤

### –û—Ü–µ–Ω–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è (–µ—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã)

| –ú–æ–¥—É–ª—å | –¢–µ–∫—É—â–∏–π | –¶–µ–ª–µ–≤–æ–π | –î–µ–ª—å—Ç–∞ |
|--------|---------|---------|--------|
| Backend Services | 0% | 90% | +90% |
| Backend Routers | 25% | 85% | +60% |
| Backend Models | 0% | 70% | +70% |
| Backend Core | 0% | 80% | +80% |
| Frontend Components | 5% | 85% | +80% |
| Frontend Stores | 0% | 90% | +90% |
| Frontend Hooks | 0% | 90% | +90% |
| Frontend API | 0% | 80% | +80% |
| **–û–ë–©–ï–ï** | **~8%** | **85%** | **+77%** |

### –û—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –¢–µ–∫—É—â–∏–µ | –ù—É–∂–Ω–æ | –í—Å–µ–≥–æ |
|-----------|---------|-------|-------|
| Backend Unit | 30 | 170 | 200 |
| Backend Integration | 0 | 65 | 65 |
| Frontend Unit | 12 | 150 | 162 |
| Frontend Integration | 0 | 40 | 40 |
| E2E | 0 | 15 | 15 |
| Performance | 0 | 20 | 20 |
| Accessibility | 0 | 10 | 10 |
| **–í–°–ï–ì–û** | **42** | **470** | **512** |

### –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

**–¢–µ–∫—É—â–µ–µ:**
- Backend: ~5 —Å–µ–∫—É–Ω–¥ (30 —Ç–µ—Å—Ç–æ–≤, –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã)
- Frontend: ~3 —Å–µ–∫—É–Ω–¥—ã (12 —Ç–µ—Å—Ç–æ–≤)
- **–í—Å–µ–≥–æ:** ~8 —Å–µ–∫—É–Ω–¥

**–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (512 —Ç–µ—Å—Ç–æ–≤):**
- Backend Unit (200): ~20 —Å–µ–∫—É–Ω–¥ (–±—ã—Å—Ç—Ä—ã–µ, –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- Backend Integration (65): ~30 —Å–µ–∫—É–Ω–¥ (—Ä–µ–∞–ª—å–Ω–∞—è –ë–î)
- Frontend Unit (162): ~25 —Å–µ–∫—É–Ω–¥ (jsdom)
- Frontend Integration (40): ~15 —Å–µ–∫—É–Ω–¥ (MSW)
- E2E (15): ~90 —Å–µ–∫—É–Ω–¥ (Playwright)
- Performance (20): ~60 —Å–µ–∫—É–Ω–¥ (benchmarks)
- Accessibility (10): ~10 —Å–µ–∫—É–Ω–¥
- **–í—Å–µ–≥–æ:** ~250 —Å–µ–∫—É–Ω–¥ (~4 –º–∏–Ω—É—Ç—ã)

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ~90 —Å–µ–∫—É–Ω–¥
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –≤ CI: ~45 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–¥–∞—á—É

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã (–ù–µ–¥–µ–ª—è 1-2)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0 - –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ PR –±–µ–∑ —Ç–µ—Å—Ç–æ–≤

#### 1.1 Backend –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã (40 —á–∞—Å–æ–≤)

**–¢–µ—Å—Ç—ã Multi-NLP Manager:**
```python
# backend/tests/unit/services/test_multi_nlp_manager.py
- 25 unit tests covering all processing modes
- Ensemble voting edge cases
- Processor fallback scenarios
- Performance benchmarks
```

**–¢–µ—Å—Ç—ã Book Parser:**
```python
# backend/tests/unit/services/test_book_parser.py
- 30 unit tests for EPUB/FB2 parsing
- CFI generation and validation
- Malformed file handling
- Memory efficiency tests
```

**–¢–µ—Å—Ç—ã Book Service:**
```python
# backend/tests/unit/services/test_book_service.py
- 35 unit tests for all public methods
- File operation tests (with tmp directories)
- Database transaction tests
- Reading progress with CFI tests
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 40 —á–∞—Å–æ–≤
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 90
**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è:** Services 0% ‚Üí 75%

#### 1.2 Frontend –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (32 —á–∞—Å–∞)

**–¢–µ—Å—Ç—ã EpubReader:**
```typescript
// frontend/src/components/Reader/__tests__/EpubReader.test.tsx
- 40 unit tests for epub.js integration
- CFI restoration tests
- Description highlighting tests
- Progress tracking tests
- Error handling tests
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 32 —á–∞—Å–∞
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 40
**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è:** Components 5% ‚Üí 35%

#### 1.3 –¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (16 —á–∞—Å–æ–≤)

**Backend:**
- Add factory_boy for test data
- Create fixture modules (books, users, chapters)
- Add sample EPUB/FB2 files
- Improve conftest.py (transaction rollback)

**Frontend:**
- Add MSW for API mocking
- Create test utilities (custom render)
- Add epub.js mock
- Zustand testing utilities

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 16 —á–∞—Å–æ–≤
**–£–ª—É—á—à–µ–Ω–∏–µ:** –°–∫–æ—Ä–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ –≤ 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ, –ª–µ–≥—á–µ –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

**–§–∞–∑–∞ 1 –í—Å–µ–≥–æ:** 88 —á–∞—Å–æ–≤, +130 —Ç–µ—Å—Ç–æ–≤, –ü–æ–∫—Ä—ã—Ç–∏–µ: 8% ‚Üí 45%

---

### –§–∞–∑–∞ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ (–ù–µ–¥–µ–ª—è 3-4)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 - –£–ª—É—á—à–∏—Ç—å –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤

#### 2.1 Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (24 —á–∞—Å–∞)

**API Integration —Ç–µ—Å—Ç—ã:**
```python
# backend/tests/integration/test_admin_api.py (5 endpoints)
# backend/tests/integration/test_nlp_api.py
# backend/tests/integration/test_images_api.py
# backend/tests/integration/test_users_api.py
# backend/tests/integration/test_book_workflows.py
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 24 —á–∞—Å–∞
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 65
**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è:** Routers 25% ‚Üí 85%

#### 2.2 Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (20 —á–∞—Å–æ–≤)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
```typescript
// frontend/src/__tests__/integration/BookUploadFlow.test.tsx
// frontend/src/__tests__/integration/ReadingFlow.test.tsx
// frontend/src/__tests__/integration/AuthFlow.test.tsx
```

**–¢–µ—Å—Ç—ã Store:**
```typescript
// frontend/src/stores/__tests__/reader.test.ts
// frontend/src/stores/__tests__/books.test.ts
// frontend/src/stores/__tests__/auth.test.ts
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 20 —á–∞—Å–æ–≤
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 60
**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è:** Stores 0% ‚Üí 85%

#### 2.3 –£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤ (16 —á–∞—Å–æ–≤)

**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤:**
- Remove excessive mocking in test_books.py
- Add parameterized tests for edge cases
- Improve test naming and organization
- Add better assertions (not just status codes)

**–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤:**
```python
@pytest.mark.unit
@pytest.mark.integration
@pytest.mark.slow
@pytest.mark.requires_nlp_models
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 16 —á–∞—Å–æ–≤
**–£–ª—É—á—à–µ–Ω–∏–µ:** –õ—É—á—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤, –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

**–§–∞–∑–∞ 2 –í—Å–µ–≥–æ:** 60 —á–∞—Å–æ–≤, +125 —Ç–µ—Å—Ç–æ–≤, –ü–æ–∫—Ä—ã—Ç–∏–µ: 45% ‚Üí 75%

---

### –§–∞–∑–∞ 3: Performance –∏ E2E (–ù–µ–¥–µ–ª—è 5-6)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 - –õ–æ–≤–∏—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏–∏

#### 3.1 Performance —Ç–µ—Å—Ç—ã (16 —á–∞—Å–æ–≤)

**Backend Benchmarks:**
```python
# backend/tests/performance/test_nlp_benchmarks.py
@pytest.mark.benchmark
def test_multi_nlp_processing_speed(benchmark):
    """Multi-NLP should process 25-chapter book in <4 seconds."""
    result = benchmark(
        multi_nlp_manager.extract_descriptions,
        text=sample_book_content
    )
    assert result.processing_time < 4.0
    assert len(result.descriptions) > 2000
```

**Frontend Performance:**
```typescript
// frontend/src/__tests__/performance/EpubReader.performance.test.tsx
// Use Lighthouse CI for real metrics
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 16 —á–∞—Å–æ–≤
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 20
**–ü–æ–ª—å–∑–∞:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 3.2 E2E —Ç–µ—Å—Ç—ã (24 —á–∞—Å–∞)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
```typescript
// e2e/tests/book-reading-journey.spec.ts (Playwright)
test('User can upload, read, and track progress', async ({ page }) => {
  // 1. Login
  // 2. Upload EPUB
  // 3. Wait for parsing (check progress indicator)
  // 4. Open book
  // 5. Read to chapter 3, 45%
  // 6. Close and reopen
  // 7. Verify exact same position restored
});
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 24 —á–∞—Å–∞
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 15
**–ü–æ–ª—å–∑–∞:** –õ–æ–≤–∏—Ç—å breaking changes –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

#### 3.3 Accessibility —Ç–µ—Å—Ç—ã (8 —á–∞—Å–æ–≤)

**A11y –∞—É–¥–∏—Ç—ã:**
```typescript
// frontend/src/__tests__/a11y/EpubReader.a11y.test.tsx
import { axe } from 'jest-axe';

it('has no accessibility violations', async () => {
  const { container } = render(<EpubReader book={mockBook} />);
  const results = await axe(container);
  expect(results).toHaveNoViolations();
});
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 8 —á–∞—Å–æ–≤
**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 10
**–ü–æ–ª—å–∑–∞:** –õ—É—á—à–∏–π UX –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–∑–∞ 3 –í—Å–µ–≥–æ:** 48 —á–∞—Å–æ–≤, +45 —Ç–µ—Å—Ç–æ–≤, –ü–æ–∫—Ä—ã—Ç–∏–µ: 75% ‚Üí 85%

---

### –§–∞–∑–∞ 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ CI/CD (–ù–µ–¥–µ–ª—è 7)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 - –í–∫–ª—é—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É

#### 4.1 –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (12 —á–∞—Å–æ–≤)

**–°–æ–∑–¥–∞—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:**
```markdown
# docs/testing/TESTING_GUIDE.md
- How to run tests
- How to write good tests
- Test data management
- Debugging failing tests

# docs/testing/CONTRIBUTING_TESTS.md
- Required tests for new features
- Test coverage standards
- Pre-commit checklist

# docs/testing/TEST_ARCHITECTURE.md
- Test structure overview
- Fixture and factory usage
- Mocking strategies
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 12 —á–∞—Å–æ–≤

#### 4.2 CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (16 —á–∞—Å–æ–≤)

**GitHub Actions Workflow:**
```yaml
# .github/workflows/tests.yml
name: Tests

on: [push, pull_request]

jobs:
  backend-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run backend unit tests
        run: pytest tests/unit --cov --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run frontend tests
        run: npm test -- --coverage

  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run E2E tests
        run: npm run test:e2e

  coverage-check:
    needs: [backend-unit, frontend-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Check coverage threshold
        run: |
          # Fail if coverage < 85%
```

**Pre-commit —Ö—É–∫–∏:**
```yaml
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: pytest-check
        name: pytest-check
        entry: pytest tests/unit --maxfail=1
        language: system
        pass_filenames: false
        always_run: true

      - id: vitest-check
        name: vitest-check
        entry: npm run test:unit
        language: system
        pass_filenames: false
        always_run: true
```

**–û—Ü–µ–Ω–∫–∞ —É—Å–∏–ª–∏–π:** 16 —á–∞—Å–æ–≤

**–§–∞–∑–∞ 4 –í—Å–µ–≥–æ:** 28 —á–∞—Å–æ–≤

---

## –†–µ–∑—é–º–µ: –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –û–±—â–∏–µ —É—Å–∏–ª–∏—è

| –§–∞–∑–∞ | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –£—Å–∏–ª–∏—è (—á–∞—Å—ã) | –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤ | –ü–æ–∫—Ä—ã—Ç–∏–µ |
|------|--------------|---------------|------------------|----------|
| –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã | –ù–µ–¥–µ–ª—è 1-2 | 88 | +130 | 8% ‚Üí 45% |
| –§–∞–∑–∞ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ | –ù–µ–¥–µ–ª—è 3-4 | 60 | +125 | 45% ‚Üí 75% |
| –§–∞–∑–∞ 3: Performance –∏ E2E | –ù–µ–¥–µ–ª—è 5-6 | 48 | +45 | 75% ‚Üí 85% |
| –§–∞–∑–∞ 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ CI/CD | –ù–µ–¥–µ–ª—è 7 | 28 | 0 | 85% |
| **–í–°–ï–ì–û** | **7 –Ω–µ–¥–µ–ª—å** | **224 —á–∞—Å–∞** | **+300** | **8% ‚Üí 85%** |

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

**–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
- 42 —Ç–µ—Å—Ç–∞
- ~8% –ø–æ–∫—Ä—ã—Ç–∏–µ
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã (Multi-NLP, CFI, EpubReader)
- –•—Ä—É–ø–∫–∏–µ —Ç–µ—Å—Ç—ã —Å —Ç—è–∂–µ–ª—ã–º –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ù–µ—Ç CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ~8 —Å–µ–∫—É–Ω–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
- 512 —Ç–µ—Å—Ç–æ–≤ (+1,119% —É–≤–µ–ª–∏—á–µ–Ω–∏–µ)
- 85% –ø–æ–∫—Ä—ã—Ç–∏–µ (+77 –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤)
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –ù–∞–¥–µ–∂–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ü–æ–ª–Ω–∞—è CI/CD —Å pre-commit —Ö—É–∫–∞–º–∏
- ~90 —Å–µ–∫—É–Ω–¥ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–≤ 11 —Ä–∞–∑ –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤, —Ç–∞ –∂–µ —Å–∫–æ—Ä–æ—Å—Ç—å)

### –°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤

**–í—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã:**
- Multi-NLP Manager: 0% ‚Üí 90% –ø–æ–∫—Ä—ã—Ç–∏–µ
- Book Parser —Å CFI: 0% ‚Üí 85% –ø–æ–∫—Ä—ã—Ç–∏–µ
- EpubReader —Å CFI: 0% ‚Üí 85% –ø–æ–∫—Ä—ã—Ç–∏–µ
- Book Service: 0% ‚Üí 90% –ø–æ–∫—Ä—ã—Ç–∏–µ

**–£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞:**
- –õ–æ–≤–∏—Ç—å –±–∞–≥–∏ –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
- –£–≤–µ—Ä–µ–Ω–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
- –õ—É—á—à–∏–π –æ–ø—ã—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

---

## –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### –≠—Ç–∞ –Ω–µ–¥–µ–ª—è (–ù–µ–¥–µ–ª—è 1)

**–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–í—Ç–æ—Ä–Ω–∏–∫:**
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
   - –î–æ–±–∞–≤–∏—Ç—å factory_boy –≤ backend
   - –î–æ–±–∞–≤–∏—Ç—å MSW –≤ frontend
   - –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª–∏ —Ñ–∏–∫—Å—Ç—É—Ä
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã EPUB —Ñ–∞–π–ª–æ–≤

**–°—Ä–µ–¥–∞-–ü—è—Ç–Ω–∏—Ü–∞:**
2. –ù–∞–ø–∏—Å–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ Multi-NLP —Ç–µ—Å—Ç—ã
   - 25 unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è processing modes
   - Ensemble voting —Ç–µ—Å—Ç—ã
   - Processor fallback —Ç–µ—Å—Ç—ã

### –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è (–ù–µ–¥–µ–ª—è 2)

**–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–°—Ä–µ–¥–∞:**
3. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã Book Parser
   - 30 unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è EPUB/FB2
   - CFI generation —Ç–µ—Å—Ç—ã
   - Edge case handling

**–ß–µ—Ç–≤–µ—Ä–≥-–ü—è—Ç–Ω–∏—Ü–∞:**
4. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã Book Service
   - 35 unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
   - Reading progress —Ç–µ—Å—Ç—ã
   - File operation —Ç–µ—Å—Ç—ã

### –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑:**
1. –ü—Ä–∏–º–µ—Ä—ã EPUB/FB2 —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. Multi-NLP –º–æ–¥–µ–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
3. –†–µ—à–µ–Ω–∏–µ –æ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (SQLite vs PostgreSQL –≤ Docker)
4. –û–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è test coverage –≤ CI

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

### –ü—Ä–∏–º–µ—Ä 1: Multi-NLP Ensemble —Ç–µ—Å—Ç

```python
# backend/tests/unit/services/test_multi_nlp_manager.py
import pytest
from app.services.multi_nlp_manager import (
    MultiNLPManager,
    ProcessingMode,
    ProcessingResult
)

@pytest.mark.asyncio
async def test_ensemble_voting_weighted_consensus():
    """Test ensemble voting correctly applies processor weights."""
    # Arrange
    manager = MultiNLPManager()
    await manager.initialize()
    manager.processing_mode = ProcessingMode.ENSEMBLE

    text = """
    –ê–Ω–Ω–∞ –≤–æ—à–ª–∞ –≤ —Ç–µ–º–Ω—ã–π –ª–µ—Å. –í—ã—Å–æ–∫–∏–µ —Å–æ—Å–Ω—ã –æ–∫—Ä—É–∂–∞–ª–∏ –µ—ë —Å–æ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω.
    –û–Ω–∞ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ —Å—Ç—Ä–∞—Ö, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∞ –∏–¥—Ç–∏.
    """

    # Act
    result: ProcessingResult = await manager.extract_descriptions(
        text=text,
        chapter_id="test-chapter"
    )

    # Assert: Check consensus was reached
    assert len(result.descriptions) > 0

    # Check weighted voting
    # SpaCy (weight 1.0) + Natasha (weight 1.2) should dominate
    forest_desc = next(
        (d for d in result.descriptions if '–ª–µ—Å' in d['text'].lower()),
        None
    )
    assert forest_desc is not None, "Should find 'forest' description"

    # Check quality metrics
    assert result.quality_metrics['consensus_rate'] >= 0.6
    assert result.quality_metrics['avg_confidence'] >= 0.7

    # Check all processors were used
    assert 'spacy' in result.processors_used
    assert 'natasha' in result.processors_used
    assert 'stanza' in result.processors_used

    # Check deduplication
    texts = [d['text'] for d in result.descriptions]
    assert len(texts) == len(set(texts)), "Should have no duplicates"


@pytest.mark.asyncio
async def test_ensemble_voting_conflict_resolution():
    """Test ensemble handles conflicting processor results."""
    # Arrange
    manager = MultiNLPManager()
    await manager.initialize()

    # Mock processors to return conflicting results
    # SpaCy: finds "dark forest" (confidence 0.9, weight 1.0)
    # Natasha: finds "deep forest" (confidence 0.8, weight 1.2)
    # Stanza: finds "scary woods" (confidence 0.7, weight 0.8)

    # Expected winner: "dark forest" from Natasha (0.8 * 1.2 = 0.96)
    #                  OR "deep forest" (0.9 * 1.0 = 0.90)

    # This test would verify the voting algorithm
    # Currently: NO TESTS FOR THIS!


@pytest.mark.asyncio
@pytest.mark.benchmark(group="nlp-processing")
async def test_multi_nlp_performance_benchmark(benchmark):
    """Benchmark Multi-NLP processing speed and quality."""
    # Arrange
    manager = MultiNLPManager()
    await manager.initialize()
    manager.processing_mode = ProcessingMode.ENSEMBLE

    # Sample book chapter (~5000 words)
    with open('tests/fixtures/sample_chapter_5000_words.txt', 'r') as f:
        text = f.read()

    # Act & Benchmark
    result = benchmark(
        manager.extract_descriptions,
        text=text,
        chapter_id="benchmark"
    )

    # Assert: Performance requirements
    assert result.processing_time < 4.0, "Should process in <4 seconds"
    assert len(result.descriptions) > 50, "Should find >50 descriptions"
    assert result.quality_metrics['avg_confidence'] > 0.7, ">70% confidence"
```

### –ü—Ä–∏–º–µ—Ä 2: CFI Generation —Ç–µ—Å—Ç

```python
# backend/tests/unit/services/test_book_parser.py
import pytest
from app.services.book_parser import book_parser, EPUBParser

@pytest.mark.asyncio
async def test_cfi_generation_for_chapter_position():
    """Test CFI is correctly generated for chapter positions."""
    # Arrange
    epub_path = 'tests/fixtures/sample_book.epub'
    parser = EPUBParser()

    # Act: Parse book
    parsed_book = await parser.parse(epub_path)

    # Get chapter 3
    chapter_3 = next(c for c in parsed_book.chapters if c.chapter_number == 3)

    # Generate CFI for position at 45.5% of chapter
    cfi = parser.generate_cfi_for_position(
        chapter=chapter_3,
        position_percent=45.5
    )

    # Assert: CFI format
    assert cfi.startswith('epubcfi(/6/'), "CFI should start with epubcfi(/6/"
    assert 'chapter-3' in cfi or '[chapter-3]' in cfi
    assert cfi.endswith(')'), "CFI should end with )"

    # Assert: CFI is valid (can be parsed back)
    position = parser.get_position_from_cfi(chapter_3, cfi)
    assert 44.0 <= position <= 47.0, "CFI should restore position within 2%"


@pytest.mark.asyncio
async def test_cfi_restoration_accuracy():
    """Test CFI accurately restores reading position."""
    # Arrange
    epub_path = 'tests/fixtures/sample_book.epub'
    parser = EPUBParser()
    parsed_book = await parser.parse(epub_path)

    chapter_5 = next(c for c in parsed_book.chapters if c.chapter_number == 5)
    original_position = 67.3  # User was at 67.3% of chapter

    # Act: Generate CFI for position
    cfi = parser.generate_cfi_for_position(chapter_5, original_position)

    # Restore position from CFI
    restored_position = parser.get_position_from_cfi(chapter_5, cfi)

    # Assert: Accuracy within 1%
    assert abs(restored_position - original_position) < 1.0

    # Assert: User sees same text
    # (This would require epub.js integration test)
```

### –ü—Ä–∏–º–µ—Ä 3: EpubReader –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–µ—Å—Ç

```typescript
// frontend/src/components/Reader/__tests__/EpubReader.test.tsx
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import { EpubReader } from '../EpubReader';
import type { BookDetail } from '@/types/api';
import { booksAPI } from '@/api/books';

// Mock epub.js
const mockBook = {
  loaded: {
    navigation: Promise.resolve({}),
    spine: Promise.resolve({ items: [] }),
  },
  spine: {
    get: vi.fn(),
    items: [],
  },
};

const mockRendition = {
  display: vi.fn().mockResolvedValue(undefined),
  on: vi.fn(),
  currentLocation: vi.fn(),
  destroy: vi.fn(),
};

vi.mock('epubjs', () => ({
  default: vi.fn(() => mockBook),
}));

describe('EpubReader - CFI Navigation', () => {
  const mockBookData: BookDetail = {
    id: 'test-book-id',
    title: 'Test Book',
    author: 'Test Author',
    total_chapters: 5,
    reading_progress_percent: 0,
  };

  beforeEach(() => {
    vi.clearAllMocks();

    // Mock fetch for EPUB file
    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      arrayBuffer: () => Promise.resolve(new ArrayBuffer(1024)),
    });

    // Mock booksAPI
    vi.mocked(booksAPI.getReadingProgress).mockResolvedValue({
      book_id: 'test-book-id',
      current_chapter_number: 3,
      reading_location_cfi: 'epubcfi(/6/8[chapter-3]!/4/2:234)',
      scroll_offset_percent: 45.5,
      progress_percent: 60.0,
    });
  });

  it('restores exact CFI position on mount', async () => {
    // Act
    render(<EpubReader book={mockBookData} />);

    // Wait for EPUB to load
    await waitFor(() => {
      expect(mockRendition.display).toHaveBeenCalled();
    });

    // Assert: CFI was passed to display
    expect(mockRendition.display).toHaveBeenCalledWith(
      'epubcfi(/6/8[chapter-3]!/4/2:234)'
    );
  });

  it('saves CFI on location change', async () => {
    // Arrange
    const saveProgressSpy = vi.spyOn(booksAPI, 'updateReadingProgress');

    render(<EpubReader book={mockBookData} />);

    // Wait for initialization
    await waitFor(() => {
      expect(mockRendition.on).toHaveBeenCalledWith(
        'relocated',
        expect.any(Function)
      );
    });

    // Get the relocated callback
    const relocatedCallback = mockRendition.on.mock.calls.find(
      call => call[0] === 'relocated'
    )?.[1];

    // Act: Simulate location change
    const newLocation = {
      start: {
        cfi: 'epubcfi(/6/10[chapter-4]!/4/2:100)',
        href: 'chapter-4.xhtml',
      },
      end: {
        cfi: 'epubcfi(/6/10[chapter-4]!/4/2:500)',
      },
    };

    relocatedCallback?.(newLocation);

    // Assert: Progress was saved with new CFI
    await waitFor(() => {
      expect(saveProgressSpy).toHaveBeenCalledWith(
        'test-book-id',
        expect.objectContaining({
          chapter_number: 4,
          reading_location_cfi: 'epubcfi(/6/10[chapter-4]!/4/2:100)',
          scroll_offset_percent: expect.any(Number),
        })
      );
    });
  });

  it('handles invalid CFI gracefully', async () => {
    // Arrange: Mock invalid CFI
    vi.mocked(booksAPI.getReadingProgress).mockResolvedValue({
      book_id: 'test-book-id',
      current_chapter_number: 1,
      reading_location_cfi: 'invalid-cfi-format',
      scroll_offset_percent: 0,
      progress_percent: 0,
    });

    // Act
    render(<EpubReader book={mockBookData} />);

    // Assert: Should fallback to chapter 1, position 0
    await waitFor(() => {
      expect(mockRendition.display).toHaveBeenCalledWith(
        expect.not.stringContaining('invalid-cfi-format')
      );
    });
  });
});
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ú —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –¢–æ–ª—å–∫–æ 8% –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –∏–º–µ–µ—Ç —Ç–µ—Å—Ç—ã
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã (Multi-NLP, CFI, EpubReader) –∏–º–µ—é—Ç –ù–û–õ–¨ —Ç–µ—Å—Ç–æ–≤
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã —Å–∏–ª—å–Ω–æ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –ù–µ—Ç E2E —Ç–µ—Å—Ç–æ–≤, –Ω–µ—Ç performance —Ç–µ—Å—Ç–æ–≤, –Ω–µ—Ç accessibility —Ç–µ—Å—Ç–æ–≤

**–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥:** 7 –Ω–µ–¥–µ–ª—å, 224 —á–∞—Å–∞, +300 —Ç–µ—Å—Ç–æ–≤
- –§–∞–∑–∞ 1 (–ù–µ–¥–µ–ª–∏ 1-2): –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã ‚Üí 45% –ø–æ–∫—Ä—ã—Ç–∏–µ
- –§–∞–∑–∞ 2 (–ù–µ–¥–µ–ª–∏ 3-4): –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ ‚Üí 75% –ø–æ–∫—Ä—ã—Ç–∏–µ
- –§–∞–∑–∞ 3 (–ù–µ–¥–µ–ª–∏ 5-6): Performance –∏ E2E ‚Üí 85% –ø–æ–∫—Ä—ã—Ç–∏–µ
- –§–∞–∑–∞ 4 (–ù–µ–¥–µ–ª—è 7): –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ CI/CD

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- 512 –≤—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤ (–ø—Ä–æ—Ç–∏–≤ 42 —Ç–µ–∫—É—â–∏—Ö)
- 85% –ø–æ–∫—Ä—ã—Ç–∏–µ (–ø—Ä–æ—Ç–∏–≤ 8% —Ç–µ–∫—É—â–∏—Ö)
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –ù–∞–¥–µ–∂–Ω—ã–π CI/CD –ø–∞–π–ø–ª–∞–π–Ω
- –£–≤–µ—Ä–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ–∏

**–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –û–¥–æ–±—Ä–∏—Ç—å –¥–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
2. –í—ã–¥–µ–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã (1 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, 7 –Ω–µ–¥–µ–ª—å)
3. –ù–∞—á–∞—Ç—å –§–∞–∑—É 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
4. –ù–∞–ø–∏—Å–∞—Ç—å Multi-NLP —Ç–µ—Å—Ç—ã (–Ω–∞–∏–≤—ã—Å—à–∏–π —Ä–∏—Å–∫)

---

**–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:** 2025-10-24
**–ê–≥–µ–Ω—Ç:** Testing & QA Specialist Agent v1.0

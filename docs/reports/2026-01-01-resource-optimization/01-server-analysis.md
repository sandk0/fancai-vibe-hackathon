# Анализ ресурсов сервера и оптимизация Docker

**Дата:** 1 января 2026
**Сервер:** 77.246.106.109
**Хостинг:** VDSina Standard Servers (Professional tier)

---

## Характеристики сервера

### VDSina Professional Tier

| Параметр | Значение |
|----------|----------|
| CPU | 4 cores @ 2.25 GHz (AMD KVM) |
| RAM | 8 GB |
| Disk | 160 GB NVMe |
| Network | 10 Gbps |
| Traffic | 32 TB/month |
| Price | $19.80/month |

**Источники:**
- [VDSina Standard Pricing](https://www.vdsina.com/ru/pricing/standard)
- [VDSina Main Page](https://www.vdsina.com/)

---

## Текущее состояние сервера

### Нагрузка системы

```
Load Average: 0.10, 0.17, 0.16 (очень низкая)
Uptime: 18 days
CPU Idle: 96.58%
```

### Память

| Метрика | Значение |
|---------|----------|
| Всего | 7.8 GB |
| Использовано | 1.7 GB |
| Свободно | 978 MB |
| **Доступно** | **6.0 GB** |
| Буферы/Кэш | 5.4 GB |
| Swap | 0 (не настроен) |

**Вывод:** Использование памяти крайне низкое (22%), есть 6 GB для расширения.

### Дисковое пространство

| Метрика | Значение |
|---------|----------|
| Всего | 158 GB |
| Использовано | 38 GB (26%) |
| Доступно | 113 GB |

**Вывод:** Дисковое пространство используется минимально.

---

## Текущие Docker ресурсы

### Контейнеры и использование

| Контейнер | Лимит RAM | Используется | % | Лимит CPU |
|-----------|-----------|--------------|---|-----------|
| backend | 1.5 GB | 256 MB | 17% | 2.0 |
| celery-worker | 1 GB | 388 MB | 38% | 1.0 |
| frontend | 1 GB | 104 MB | 10% | 1.0 |
| celery-beat | 256 MB | 71 MB | 28% | 0.3 |
| postgres | 1 GB | 111 MB | 11% | 1.0 |
| redis | 512 MB | 8 MB | 2% | 0.5 |
| **ИТОГО** | **5.27 GB** | **~938 MB** | **18%** | **5.8** |

### Сетевой I/O

| Контейнер | RX | TX |
|-----------|-----|-----|
| postgres | 54 MB | 29 GB |
| redis | 333 MB | 289 MB |
| backend | 219 MB | 5 MB |

---

## Проблемы текущей конфигурации

### 1. Недоиспользование RAM

**Текущее:** 5.27 GB лимиты, ~938 MB используется
**Доступно:** 6 GB из 8 GB
**Проблема:** Лимиты слишком консервативные, ресурсы простаивают

### 2. Консервативные лимиты PostgreSQL

**Текущий shared_buffers:** не настроен (по умолчанию 128 MB)
**Рекомендация для 8 GB:** 512 MB - 1 GB

### 3. Redis maxmemory низкий

**Текущий:** 384 MB
**Рекомендация:** 512-768 MB для эффективного кэширования

### 4. CPU лимиты ограничивают производительность

**Текущий total:** 5.8 cores
**Доступно:** 4 cores
**Проблема:** Overcommit CPU нормален, но можно оптимизировать распределение

### 5. Отсутствует Swap

**Проблема:** При пиковых нагрузках нет страховки
**Рекомендация:** Настроить 2-4 GB swap

---

## Рекомендуемое распределение ресурсов

### Для 8 GB сервера (4 cores)

**Принцип распределения:**
- 1.5 GB для ОС/системы
- 6.5 GB для Docker контейнеров
- 4 cores распределить с учётом приоритетов

### Новые лимиты

| Контейнер | RAM Limit | RAM Reserve | CPU Limit | CPU Reserve |
|-----------|-----------|-------------|-----------|-------------|
| **postgres** | 2 GB | 1 GB | 1.5 | 0.5 |
| **backend** | 2 GB | 768 MB | 2.0 | 0.5 |
| **celery-worker** | 1.5 GB | 512 MB | 1.5 | 0.3 |
| **redis** | 768 MB | 384 MB | 0.5 | 0.2 |
| **frontend** | 512 MB | 256 MB | 0.5 | 0.2 |
| **celery-beat** | 256 MB | 128 MB | 0.2 | 0.1 |
| **ИТОГО** | **7 GB** | **3 GB** | **6.2** | **1.8** |

### PostgreSQL Tuning

```
shared_buffers = 512MB        # 25% от 2GB лимита
effective_cache_size = 1GB    # 50% от 2GB лимита
work_mem = 16MB               # Для сложных запросов
maintenance_work_mem = 128MB  # Для VACUUM, INDEX
max_connections = 100         # Достаточно для приложения
```

### Redis Tuning

```
maxmemory 640mb               # 80% от 768MB лимита
maxmemory-policy allkeys-lru  # Оставляем
```

---

## Сравнение: До и После

| Метрика | Было | Станет | Изменение |
|---------|------|--------|-----------|
| **PostgreSQL RAM** | 1 GB | 2 GB | +100% |
| **PostgreSQL shared_buffers** | 128 MB | 512 MB | +300% |
| **Backend RAM** | 1.5 GB | 2 GB | +33% |
| **Celery Worker RAM** | 1 GB | 1.5 GB | +50% |
| **Redis maxmemory** | 384 MB | 640 MB | +67% |
| **Total RAM Limits** | 5.27 GB | 7 GB | +33% |
| **Utilization** | 66% | 88% | +22% |

---

## Ожидаемые улучшения

### Производительность

1. **PostgreSQL:** Быстрее queries благодаря увеличенному cache
2. **Backend:** Больше буфера для concurrent requests
3. **Celery:** Быстрее обработка больших книг
4. **Redis:** Больше данных в кэше, меньше evictions

### Стабильность

1. Больше headroom для пиковых нагрузок
2. Меньше вероятность OOM kills
3. Лучшее распределение ресурсов

---

## План действий

1. **Обновить docker-compose.lite.yml** - для dev окружения
2. **Обновить docker-compose.lite.prod.yml** - для production
3. **Применить изменения на сервере**
4. **Мониторить производительность** через `docker stats`

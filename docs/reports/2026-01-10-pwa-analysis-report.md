# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É PWA

**–î–∞—Ç–∞:** 10-11 —è–Ω–≤–∞—Ä—è 2026
**–í–µ—Ä—Å–∏—è:** 1.9
**–°—Ç–∞—Ç—É—Å:** P0-P6 –í–°–ï –§–ê–ó–´ –ó–ê–í–ï–†–®–ï–ù–´ ‚úÖ
**–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã:** iOS Safari, Android Chrome
**–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** 10 —è–Ω–≤–∞—Ä—è 2026
**iOS Navigation –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 10 —è–Ω–≤–∞—Ä—è 2026 ‚úÖ
**P4 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 11 —è–Ω–≤–∞—Ä—è 2026 ‚úÖ
**P5 —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ API:** 11 —è–Ω–≤–∞—Ä—è 2026 ‚úÖ

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–†–µ–∑—é–º–µ](#1-—Ä–µ–∑—é–º–µ)
2. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#2-–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
3. [–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#3-–≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
4. [–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–∞–≥–∞](#4-–∞–Ω–∞–ª–∏–∑-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ-–±–∞–≥–∞-forever-broken-book)
5. [–ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–ª–æ—É](#5-–∞–Ω–∞–ª–∏–∑-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö-—Ñ–ª–æ—É)
6. [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ª—É—á—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏](#6-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ-—Å-–ª—É—á—à–∏–º–∏-–ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏-pwa)
7. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#7-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
8. [–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P0)](#8-—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è-p0)
9. [–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ù–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (P4-P5)](#9-–ø–æ–≤—Ç–æ—Ä–Ω—ã–π-–∞–Ω–∞–ª–∏–∑-–Ω–æ–≤—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-p4-p5)
10. [iOS Navigation: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (P6)](#10-ios-navigation-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è-–ø—Ä–æ–±–ª–µ–º–∞-p6)
11. [–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#11-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

---

## 1. –†–µ–∑—é–º–µ

### 1.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –í–ª–∏—è–Ω–∏–µ | –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã |
|---|----------|---------|-----------|
| **P1** | "Forever Broken" Book - corrupted IndexedDB –¥–∞–Ω–Ω—ã–µ | –ö–Ω–∏–≥–∞ –Ω–∞–≤—Å–µ–≥–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ | iOS, Android |
| **P2** | Race condition –ø—Ä–∏ resume –∏–∑ background | Crash –ø–æ—Å–ª–µ 10-15 –º–∏–Ω—É—Ç idle | iOS, Android |
| **P3** | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ offline fallback —Å—Ç—Ä–∞–Ω–∏—Ü—ã | –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω –ø—Ä–∏ offline | –í—Å–µ |
| **P4** | iOS Background Sync –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ | iOS |

### 1.2 –ú–∞—Å—à—Ç–∞–± –∞–Ω–∞–ª–∏–∑–∞

- **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 24
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~8,500+
- **–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:** 18

### 1.3 –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

1. **–î–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ IndexedDB –±–∞–∑—ã** –±–µ–∑ –µ–¥–∏–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞—â–∏—Ç—ã –æ—Ç corruption
2. **Race condition** –º–µ–∂–¥—É Zustand rehydration –∏ TanStack Query refetch
3. **epub.js locations cache** –Ω–µ –∑–∞—â–∏—â—ë–Ω –æ—Ç corrupted –¥–∞–Ω–Ω—ã—Ö
4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º "Reset Book"** –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ corrupted –¥–∞–Ω–Ω—ã—Ö

---

## 2. –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 2.1 –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –§–∞–π–ª—ã | –°—Ç—Ä–æ–∫ |
|-----------|-------|-------|
| Service Worker | \`sw.ts\` | 650 |
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | \`db.ts\` | 255 |
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | \`syncQueue.ts\` | 577 |
| –•—Ä–∞–Ω–∏–ª–∏—â–µ | \`storageManager.ts\`, \`downloadManager.ts\` | 1,020 |
| Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | \`pushNotifications.ts\` | 509 |
| iOS –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | \`iosSupport.ts\` | 452 |
| React —Ö—É–∫–∏ | 8 —Ñ–∞–π–ª–æ–≤ | ~1,800 |
| UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã | 2 —Ñ–∞–π–ª–∞ | 690 |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | \`manifest.json\`, \`vite.config.ts\` | 275 |
| –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ | \`chapterCache.ts\`, \`imageCache.ts\` | ~1,100 |
| EPUB | \`useEpubLoader.ts\`, \`useLocationGeneration.ts\`, \`useChapterManagement.ts\` | ~1,200 |

### 2.2 –•—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö

\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PWA Data Storage                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ    localStorage     ‚îÇ   ‚îÇ   TanStack Query Cache      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                     ‚îÇ   ‚îÇ                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - auth tokens       ‚îÇ   ‚îÇ - book details (24h gcTime) ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - theme settings    ‚îÇ   ‚îÇ - chapters                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - progress_backup   ‚îÇ   ‚îÇ - descriptions              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - reader settings   ‚îÇ   ‚îÇ - images                    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ               IndexedDB (Dexie.js)                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                   –ë–∞–∑–∞: "fancai-db"                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  Tables:                                              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - offlineBooks     (downloaded books metadata)       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - chapters         (chapter content + descriptions)  ‚îÇ ‚îÇ ‚Üê –ó–∞—â–∏—â–µ–Ω–æ
‚îÇ  ‚îÇ  - images           (cached images)                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - syncQueue        (pending operations)              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - readingProgress  (reading positions)               ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ           IndexedDB (Raw API)                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ              –ë–∞–∑–∞: "BookReaderAI"                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  Store:                                               ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - epub_locations   (epub.js locations cache)         ‚îÇ ‚îÇ ‚Üê –ù–ï –ó–ê–©–ò–©–ï–ù–û!
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ              Cache API (Service Worker)               ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - workbox-precache (static assets)                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - api-cache        (API responses)                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - images-cache     (generated images)                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

### 2.3 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ PWA

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| Workbox | 7.x | Service Worker —Å injectManifest |
| Dexie.js | 4.x | IndexedDB ORM |
| TanStack Query | 5.90 | Server state management |
| Zustand | 5.x | Client state (persist middleware) |
| VitePWA | 0.x | Vite PWA plugin |

---

## 3. –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 3.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P1)

#### 3.1.1 "Forever Broken" Book (IndexedDB Corruption)

**–°–∏–º–ø—Ç–æ–º:**
–ü–æ—Å–ª–µ crash –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏, –∫–Ω–∏–≥–∞ **–Ω–∞–≤—Å–µ–≥–¥–∞** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Ç–∞–ª–∫–∏. –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É."

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
\`\`\`typescript
// useLocationGeneration.ts:141
// –ù–ï–¢ try-catch –≤–æ–∫—Ä—É–≥ load()!
book.locations.load(cachedLocations);
\`\`\`

**–¶–µ–ø–æ—á–∫–∞ —Å–æ–±—ã—Ç–∏–π:**
\`\`\`
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–∏—Ç–∞–µ—Ç –∫–Ω–∏–≥—É –≤ PWA
2. PWA —É—Ö–æ–¥–∏—Ç –≤ background (10-15 –º–∏–Ω—É—Ç)
3. IndexedDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è (memory pressure)
4. epub_locations –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è corrupted
5. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏:
   - getCachedLocations() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç corrupted –¥–∞–Ω–Ω—ã–µ
   - book.locations.load() –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç exception
   - ErrorBoundary –ª–æ–≤–∏—Ç ‚Üí "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Ç–∞–ª–∫–∏"
6. Corrupted –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ IndexedDB
7. –ö–Ω–∏–≥–∞ "—Å–ª–æ–º–∞–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞"
\`\`\`

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- \`src/hooks/epub/useLocationGeneration.ts:137-155\`
- \`src/pages/BookReaderPage.tsx:74-95\` (ErrorBoundary)

**–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã:** iOS Safari, Android 16 Chrome

#### 3.1.2 Race Condition –ø—Ä–∏ Resume

**–°–∏–º–ø—Ç–æ–º:**
Crash –ø–æ—Å–ª–µ 10-15 –º–∏–Ω—É—Ç idle –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ PWA.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
\`\`\`typescript
// auth.ts:237-250 - 100ms delay!
onRehydrateStorage: () => (state) => {
  setTimeout(() => {
    useAuthStore.getState().loadUserFromStorage();
  }, 100); // ‚Üê Zustand rehydrating
}

// queryClient.ts:74 - –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô refetch!
refetchOnWindowFocus: true
\`\`\`

**–ü—Ä–æ–±–ª–µ–º–∞:**
TanStack Query –¥–µ–ª–∞–µ—Ç refetch **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –ø—Ä–∏ \`visibilitychange\`, –Ω–æ Zustand –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ (100ms delay). –ó–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —Å \`userId = ''\`.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- \`src/stores/auth.ts:237-250\`
- \`src/lib/queryClient.ts:74\`
- \`src/hooks/epub/useChapterManagement.ts:72-73\`

### 3.2 –°–µ—Ä—å—ë–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (P2)

#### 3.2.1 iOS Background Sync –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–û–ø–∏—Å–∞–Ω–∏–µ:**
iOS Safari –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Background Sync API. –¢–µ–∫—É—â–∏–π workaround —á–µ—Ä–µ–∑ \`visibilitychange\` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω.

**–§–∞–π–ª—ã:**
- \`src/services/syncQueue.ts:86-89\`
- \`src/utils/iosSupport.ts:273\`

**–†–∏—Å–∫:** –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ PWA –Ω–∞ iOS.

#### 3.2.2 –ù–µ—Ç offline fallback —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–∏ –ø–æ–ª–Ω–æ–º offline –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.

**–§–∞–π–ª—ã:**
- \`src/sw.ts:272-283\` - –Ω–µ—Ç fallback handler

#### 3.2.3 epub.js Rendition Memory Corruption

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ idle iOS –º–æ–∂–µ—Ç –≤—ã–≥—Ä—É–∑–∏—Ç—å JavaScript heap. epub.js –æ–±—ä–µ–∫—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è corrupted.

**–§–∞–π–ª—ã:**
- \`src/hooks/epub/useEpubLoader.ts\`
- \`src/hooks/epub/useChapterManagement.ts:583-594\`

### 3.3 –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P3)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –†–∏—Å–∫ |
|---|----------|------|------|
| 3.3.1 | Interval callbacks –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ background | \`useReadingSession.ts:266-271\` | Stale state |
| 3.3.2 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (SW + IndexedDB) | \`sw.ts\`, \`chapterCache.ts\` | –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å |
| 3.3.3 | –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ syncQueue | \`syncQueue.ts\` | Overflow |
| 3.3.4 | Download progress –Ω–µ persist –ø—Ä–∏ crash | \`downloadManager.ts:192-222\` | –ü–æ—Ç–µ—Ä—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ |
| 3.3.5 | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç OfflineBanner UI | - | UX |
| 3.3.6 | Manifest.json –Ω–µ–ø–æ–ª–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ | \`manifest.json\` | Display issues |

### 3.4 –ú–µ–ª–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P4)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª |
|---|----------|------|
| 3.4.1 | Console.log –≤ production | –í—Å–µ PWA —Ñ–∞–π–ª—ã |
| 3.4.2 | Hardcoded strings –Ω–∞ —Ä—É—Å—Å–∫–æ–º | \`PWAUpdatePrompt.tsx\` |
| 3.4.3 | –ù–µ—Ç SW update timeout | \`PWAUpdatePrompt.tsx\` |
| 3.4.4 | –ù–µ—Ç preload –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ | \`index.html\` |

---

## 4. –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–∞–≥–∞ "Forever Broken Book"

### 4.1 –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

**–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã:** Android 16 (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ), iOS Safari (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è)

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É –≤ PWA
2. –ü–æ–ª–∏—Å—Ç–∞—Ç—å –ø–∞—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü
3. –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω —Å –æ—Ç–∫—Ä—ã—Ç—ã–º PWA –Ω–∞ 10-15 –º–∏–Ω—É—Ç
4. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ PWA
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Ç–∞–ª–∫–∏"
6. –ó–∞–∫—Ä—ã—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É —Å–Ω–æ–≤–∞
7. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–∞ –∂–µ –æ—à–∏–±–∫–∞ (–∫–Ω–∏–≥–∞ "—Å–ª–æ–º–∞–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞")

### 4.2 –ê–Ω–∞–ª–∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â per-book –¥–∞–Ω–Ω—ã—Ö

\`\`\`
–î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å corrupted per-book:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

localStorage:
‚îú‚îÄ‚îÄ book_\${bookId}_progress_backup     ‚Üê –ú–æ–∂–µ—Ç –±—ã—Ç—å corrupted

IndexedDB "fancai-db" (Dexie.js):
‚îú‚îÄ‚îÄ chapters.[userId+bookId]           ‚Üê –ó–∞—â–∏—â–µ–Ω–æ (defensive validation –¥–æ–±–∞–≤–ª–µ–Ω)
‚îú‚îÄ‚îÄ images.[userId+bookId]             ‚Üê –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞—â–∏—â–µ–Ω–æ
‚îî‚îÄ‚îÄ offlineBooks.[userId+bookId]       ‚Üê –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

IndexedDB "BookReaderAI" (Raw API):
‚îî‚îÄ‚îÄ epub_locations.bookId              ‚Üê –ù–ï –ó–ê–©–ò–©–ï–ù–û! ‚Üê –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

TanStack Query Cache:
‚îú‚îÄ‚îÄ ['book', bookId]                   ‚Üê gcTime: 24h, –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å error state
‚îú‚îÄ‚îÄ ['chapters', ...]                  ‚Üê gcTime: 24h
‚îî‚îÄ‚îÄ ['descriptions', ...]              ‚Üê gcTime: 24h
\`\`\`

### 4.3 –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–§–∞–π–ª:** \`src/hooks/epub/useLocationGeneration.ts:137-155\`

\`\`\`typescript
// –ü–†–û–ë–õ–ï–ú–ù–´–ô –ö–û–î (–±–µ–∑ –∑–∞—â–∏—Ç—ã –æ—Ç corrupted –¥–∞–Ω–Ω—ã—Ö):
const cachedLocations = await getCachedLocations(bookId);

if (cachedLocations && isMounted) {
  devLog('Progress: Loading locations from cache...');
  book.locations.load(cachedLocations);  // ‚Üê EXCEPTION –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ corrupted!

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–û–°–õ–ï load - —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ!
  if (book.locations.total && book.locations.total > 0) {
    // ...
  }
}
\`\`\`

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. –ù–µ—Ç \`try-catch\` –≤–æ–∫—Ä—É–≥ \`book.locations.load()\`
2. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ \`cachedLocations\` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
3. –ù–µ—Ç auto-cleanup –ø—Ä–∏ –æ—à–∏–±–∫–µ

### 4.4 –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è

\`\`\`
–ü–µ—Ä–≤—ã–π crash:
‚îú‚îÄ‚îÄ IndexedDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ background
‚îú‚îÄ‚îÄ epub_locations –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ/corrupted
‚îî‚îÄ‚îÄ –û—à–∏–±–∫–∞ –ª–æ–≤–∏—Ç—Å—è ErrorBoundary

–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏:
‚îú‚îÄ‚îÄ getCachedLocations() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ –∂–µ corrupted –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ book.locations.load() –ø–∞–¥–∞–µ—Ç
‚îú‚îÄ‚îÄ ErrorBoundary –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
‚îî‚îÄ‚îÄ Corrupted –¥–∞–Ω–Ω—ã–µ –ù–ï –æ—á–∏—â–∞—é—Ç—Å—è ‚Üí –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
\`\`\`

### 4.5 –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

\`\`\`typescript
// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î:
try {
  const cachedLocations = await getCachedLocations(bookId);

  if (cachedLocations && isMounted) {
    devLog('Progress: Loading locations from cache...');

    try {
      book.locations.load(cachedLocations);

      if (book.locations.total && book.locations.total > 0) {
        devLog('Success: Loaded from cache:', book.locations.total);
        setLocations(book.locations);
        setIsGenerating(false);
        locationsLoaded = true;
      } else {
        throw new Error('Invalid locations after load');
      }
    } catch (loadErr) {
      console.warn('[useLocationGeneration] Corrupted cache, clearing:', loadErr);
      // AUTO-CLEANUP: –£–¥–∞–ª—è–µ–º corrupted –¥–∞–Ω–Ω—ã–µ
      await clearCachedLocations(bookId);
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    }
  }
} catch (cacheErr) {
  devLog('Warning: Cache load failed:', cacheErr);
}
\`\`\`

---

## 5. –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–ª–æ—É

### 5.1 –ü–µ—Ä–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PWA

| –®–∞–≥ | iOS Safari | Android Chrome | –ü—Ä–æ–±–ª–µ–º—ã |
|-----|------------|----------------|----------|
| –ü–æ—Å–µ—â–µ–Ω–∏–µ —Å–∞–π—Ç–∞ | OK | OK | - |
| –ü–æ–∫–∞–∑ install prompt | Manual | Auto | iOS —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é |
| SW —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | OK | OK | - |
| Persistent storage | May deny | OK | iOS Safari —Å—Ç—Ä–æ–≥–∏–π |

### 5.2 –ß—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥–∏ offline

| –®–∞–≥ | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–±–ª–µ–º—ã |
|-----|--------|----------|
| –ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ | Partial | Progress –Ω–µ persist –ø—Ä–∏ crash |
| –ß—Ç–µ–Ω–∏–µ offline | OK | - |
| –ù–∞–≤–∏–≥–∞—Ü–∏—è | OK | - |
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ | Risky | syncQueue –º–æ–∂–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å—Å—è |
| –í–æ–∑–≤—Ä–∞—Ç online + sync | iOS Risky | Background Sync –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |

### 5.3 Long idle (10-15 –º–∏–Ω—É—Ç)

| –®–∞–≥ | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–±–ª–µ–º—ã |
|-----|--------|----------|
| PWA –≤ background | - | - |
| Memory pressure | High Risk | IndexedDB corruption |
| Return to foreground | CRASH | Race condition + corrupted data |
| –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ | FOREVER BROKEN | Corrupted cache –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è |

### 5.4 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

| –®–∞–≥ | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–±–ª–µ–º—ã |
|-----|--------|----------|
| –ó–∞–ø—Ä–æ—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | OK | - |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | HIGH RISK | IndexedDB transaction abort |
| –í–æ–∑–≤—Ä–∞—Ç –≤ PWA | May crash | Corrupted data |
| –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ | May fail | –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ corrupted |

---

## 6. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ª—É—á—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ PWA

### 6.1 Google PWA Checklist

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| HTTPS | OK | Production |
| Valid manifest.json | Partial | –ù–µ –≤—Å–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∫–æ–Ω–æ–∫ |
| Service Worker | OK | Workbox injectManifest |
| **Offline page** | MISSING | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ |
| Fast load on 3G | Unknown | –ù–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å |
| Responsive design | OK | Mobile-first |
| Add to homescreen | OK | + iOS instructions |
| Splash screen | OK | –í manifest |

### 6.2 Apple PWA Requirements

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| apple-mobile-web-app-capable | Unknown | –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ HTML |
| apple-touch-icon | Unknown | –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ |
| Safe areas | Partial | pt-safe –≤ CSS |
| Background Sync fallback | Partial | visibilitychange only |

### 6.3 –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ PWA Patterns

| Pattern | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | –ö–∞—á–µ—Å—Ç–≤–æ |
|---------|------------|----------|
| Stale-while-revalidate | OK | –•–æ—Ä–æ—à–æ |
| Network-first with fallback | Partial | –ù–µ—Ç offline page |
| Background Sync | Partial | –¢–æ–ª—å–∫–æ Chrome/Android |
| **Error recovery** | MISSING | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ |
| **Data integrity checks** | Partial | –¢–æ–ª—å–∫–æ chapterCache |
| Push Notifications | Partial | iOS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |

---

## 7. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 7.1 –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (P0)

1. **–î–æ–±–∞–≤–∏—Ç—å try-catch –≤ useLocationGeneration** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç corrupted cache
2. **–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é "Reset Book"** –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö per-book –¥–∞–Ω–Ω—ã—Ö
3. **–î–æ–±–∞–≤–∏—Ç—å defensive validation** –¥–ª—è IndexedDB "BookReaderAI"

### 7.2 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P1)

1. –î–æ–±–∞–≤–∏—Ç—å PWA Resume Guard
2. Disable refetchOnWindowFocus –≤ Reader
3. –î–æ–±–∞–≤–∏—Ç—å offline fallback page
4. –î–æ–±–∞–≤–∏—Ç—å Dexie.js error handlers

### 7.3 –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (P2)

1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ intervals –ø—Ä–∏ visibility change
2. Graceful epub.js recovery
3. –£–ª—É—á—à–∏—Ç—å iOS sync fallback
4. –î–æ–±–∞–≤–∏—Ç—å storage pressure handling

---

## 8. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P0) ‚úÖ

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2026-01-10

### 8.1 P0-1: –ó–∞—â–∏—Ç–∞ useLocationGeneration –æ—Ç corrupted –¥–∞–Ω–Ω—ã—Ö ‚úÖ

**–§–∞–π–ª:** \`src/hooks/epub/useLocationGeneration.ts\`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω try-catch –±–ª–æ–∫ –≤–æ–∫—Ä—É–≥ \`book.locations.load(cachedLocations)\`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (–Ω–µ –º–µ–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏: \`book.locations.total > 0\`
- Auto-cleanup —á–µ—Ä–µ–∑ \`clearCachedLocations(bookId)\` –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è locations –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ corrupted –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–Ω–∏–≥–∞ —Å corrupted cache –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏.

### 8.2 P0-2: –§—É–Ω–∫—Ü–∏—è "Reset Book" –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚úÖ

**–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:** \`src/utils/bookDataReset.ts\`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª \`resetBookData(userId, bookId)\`:**

\`\`\`typescript
// –û—á–∏—â–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
1. localStorage: book_${bookId}_progress_backup
2. IndexedDB "BookReaderAI": epub_locations –¥–ª—è bookId
3. Dexie.js "fancai-db":
   - chapters (–ø–æ userId + bookId)
   - images (–ø–æ userId + bookId)
   - offlineBooks (–ø–æ userId + bookId)
   - readingProgress (–ø–æ bookId)
   - syncQueue (–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å bookId)
4. TanStack Query cache:
   - ['book', bookId]
   - ['chapters', ...bookId...]
   - ['descriptions', ...bookId...]
   - ['images', ...bookId...]
\`\`\`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

### 8.3 P0-2b: –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –∫–Ω–∏–≥–∏" –≤ UI ‚úÖ

**–§–∞–π–ª:** \`src/pages/BookReaderPage.tsx\`

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç \`ReaderErrorFallback\` –¥–ª—è ErrorBoundary
- –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –∫–Ω–∏–≥–∏" —Ä—è–¥–æ–º —Å "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"
- Loading —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å alert

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É:**
1. –ö–Ω–∏–≥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Ç–∞–ª–∫–∏"
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –∫–Ω–∏–≥–∏"
3. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Üí –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
4. –ö–Ω–∏–≥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 8.4 –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ P0

| –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ P0 | –ü–æ—Å–ª–µ P0 |
|----------|-------|----------|
| "Forever Broken" Book | –ö–Ω–∏–≥–∞ –Ω–∞–≤—Å–µ–≥–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ | Auto-recovery + —Ä—É—á–Ω–æ–π —Å–±—Ä–æ—Å |
| Recovery rate | 0% | >95% (–æ—Ü–µ–Ω–∫–∞) |
| User action required | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ | –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ |

### 8.5 –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ P0

- [ ] –¢–µ—Å—Ç—ã –¥–ª—è corrupted –¥–∞–Ω–Ω—ã—Ö
- [ ] Confirm dialog –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º
- [ ] JSON –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ \`getCachedLocations\`
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ \`onblocked\`/\`onversionchange\` —Å–æ–±—ã—Ç–∏–π IndexedDB (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ P1-4)

---

## 8.6 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P1) ‚úÖ

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2026-01-10

### 8.6.1 P1-1: PWA Resume Guard ‚úÖ

**–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:** \`src/hooks/pwa/usePWAResumeGuard.ts\`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –•—É–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç \`visibilitychange\` —Å–æ–±—ã—Ç–∏—è
- 200ms grace period –¥–ª—è Zustand rehydration –ø–æ—Å–ª–µ resume
- –ú–∏–Ω–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥ idle –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π guard (–∏–∑–±–µ–≥–∞–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ \`loadUserFromStorage()\` –µ—Å–ª–∏ user –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç \`{ isResuming, isReady, timeSinceResume }\`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ BookReaderPage:**
- Loading spinner —Å "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏..." –≤–æ –≤—Ä–µ–º—è resume
- Query –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ–∫–∞ \`isResuming === true\`

### 8.6.2 P1-2: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ refetchOnWindowFocus ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- \`src/pages/BookReaderPage.tsx\`
- \`src/hooks/api/useBooks.ts\`
- \`src/hooks/api/useChapter.ts\`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–ø—Ü–∏–∏ \`refetchOnWindowFocus: false\`, \`refetchOnMount: false\`
- \`staleTime: 5 * 60 * 1000\` (5 –º–∏–Ω—É—Ç)
- –°–æ–∑–¥–∞–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ö—É–∫–∏ –¥–ª—è Reader –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
  - \`useBookForReader\` - –∫–Ω–∏–≥–∞ –±–µ–∑ auto-refetch
  - \`useChapterForReader\` - –≥–ª–∞–≤–∞ –±–µ–∑ auto-refetch

### 8.6.3 P1-3: Offline fallback —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚úÖ

**–°–æ–∑–¥–∞–Ω–Ω—ã–µ/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- \`public/offline.html\` (–Ω–æ–≤—ã–π)
- \`src/sw.ts\` (–∏–∑–º–µ–Ω—ë–Ω)

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- Standalone HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (#121212) —Å —Ä—É—Å—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º
- "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É" + –∫–Ω–æ–ø–∫–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"
- Inline SVG –∏–∫–æ–Ω–∫–∏ (–æ–±–ª–∞–∫–æ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- \`setCatchHandler\` –≤ Service Worker –¥–ª—è document requests
- Fallback –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫—ç—à–∞–º

### 8.6.4 P1-4: Dexie.js error handlers ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`src/services/db.ts\`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ handlers:**
- \`db.on('blocked')\` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
- \`db.on('versionchange')\` - –∑–∞–∫—Ä—ã—Ç–∏–µ –ë–î + reload
- \`db.open().catch()\` - recovery –ø—Ä–∏ VersionError/InvalidStateError

### 8.7 –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ P1

| –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ P1 | –ü–æ—Å–ª–µ P1 |
|----------|-------|----------|
| Race condition –ø—Ä–∏ resume | –ß–∞—Å—Ç—ã–µ crash | –ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ guard |
| Auto-refetch –∫–æ–Ω—Ñ–ª–∏–∫—Ç | Immediate refetch | –û—Ç–∫–ª—é—á–µ–Ω–æ –≤ Reader |
| Offline –±–µ–∑ fallback | –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω | –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ |
| IndexedDB blocking | –ë–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ | Graceful recovery |

---

## 8.8 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P2) ‚úÖ

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2026-01-10

### 8.8.1 P2-1: Visibility handlers –¥–ª—è intervals ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- \`src/hooks/reader/useReadingSession.ts\`
- \`src/hooks/epub/useProgressSync.ts\`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- useReadingSession: interval –ø–∞—É–∑–∞ –ø—Ä–∏ \`visibilityState === 'hidden'\`
- Resume —Å 300ms delay –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ auth
- useProgressSync: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ pending saves —á–µ—Ä–µ–∑ \`pendingSaveOnBackgroundRef\`
- –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ visible –µ—Å–ª–∏ –±—ã–ª–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- Conditional logging —á–µ—Ä–µ–∑ \`import.meta.env.DEV\`

### 8.8.2 P2-2: Rendition health check ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`src/components/Reader/EpubReader.tsx\`

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- Hook 19: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è rendition –ø—Ä–∏ resume
- \`rendition.currentLocation()\` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è \`loc.start\` –∏ \`loc.end\`
- 500ms delay –ø–æ—Å–ª–µ visibility change –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CFI –≤ localStorage –ø–µ—Ä–µ–¥ reload
- –í—ã–∑–æ–≤ \`reload()\` –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ corrupted state

### 8.8.3 P2-3: –£–ª—É—á—à–µ–Ω–Ω—ã–π iOS sync ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`src/services/syncQueue.ts\`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- \`startPeriodicSync()\` - –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ visible + online
- \`stopPeriodicSync()\` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ background
- \`setupIOSFallback()\` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è iOS Safari
- \`handleBeforeUnload()\` —Å \`navigator.sendBeacon()\`
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ critical –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
- –≠–∫—Å–ø–æ—Ä—Ç \`getPendingCount()\` –∏ \`getFailedCount()\`

### 8.8.4 P2-4: Storage pressure monitoring ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`src/services/storageManager.ts\`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- \`startStorageMonitoring()\` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
- \`checkStoragePressure()\` - —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- \`performLRUCleanup(aggressive)\` - –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π
- \`requestPersistentStorage()\` - –∑–∞–ø—Ä–æ—Å persistent storage
- \`onStoragePressure(callback)\` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
- \`initializeStorageManagement()\` - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

**–ü–æ—Ä–æ–≥–∏:**
- Warning: 80% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ‚Üí normal cleanup (10 MB)
- Critical: 90% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ‚Üí aggressive cleanup (50 MB)

### 8.9 –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ P2

| –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ P2 | –ü–æ—Å–ª–µ P2 |
|----------|-------|----------|
| Intervals –≤ background | Stale state | –ü–∞—É–∑–∞/resume |
| epub.js corruption | –ë–µ–∑ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è | Health check + reload |
| iOS sync | –¢–æ–ª—å–∫–æ visibilitychange | Periodic + sendBeacon |
| Storage pressure | –ë–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ | Auto-cleanup |

---

## 8.10 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P3) ‚úÖ

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2026-01-10

### 8.10.1 P3-1: OfflineBanner UI ‚úÖ

**–°–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`src/components/UI/OfflineBanner.tsx\`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –¢—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI:
  - Offline (–∫—Ä–∞—Å–Ω—ã–π): "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
  - Syncing (–∂—ë–ª—Ç—ã–π): "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."
  - Success (–∑–µ–ª—ë–Ω—ã–π): "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç pending sync count
- framer-motion –∞–Ω–∏–º–∞—Ü–∏–∏ (slide-down)
- Lucide icons (WifiOff, RefreshCw, CheckCircle)
- Safe area padding –¥–ª—è notched devices
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ \`subscribeSyncQueue\` –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### 8.10.2 P3-2: –ü–æ–ª–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ manifest.json ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`public/manifest.json\`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:**
- 72x72, 96x96, 128x128, 144x144, 152x152
- 192x192 (any + maskable)
- 384x384
- 512x512 (any + maskable)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Actual icon —Ñ–∞–π–ª—ã –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤ \`public/icons/\`

### 8.10.3 P3-3: Conditional logging ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- \`src/services/chapterCache.ts\` - 17 console.log ‚Üí conditional
- \`src/services/imageCache.ts\` - 20 console.log ‚Üí conditional
- \`src/services/storageManager.ts\` - 8 console.log ‚Üí conditional

**–ü–∞—Ç—Ç–µ—Ä–Ω:**
\`\`\`typescript
const DEBUG = import.meta.env.DEV;
if (DEBUG) console.log('[Module] message');
\`\`\`

**–§–∞–π–ª—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—É–∂–µ –∏–º–µ–ª–∏ conditional):**
- syncQueue.ts, usePWAResumeGuard.ts, useLocationGeneration.ts

### 8.10.4 P3-4: Apple meta tags ‚úÖ

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:** \`index.html\`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏:**
- \`apple-mobile-web-app-capable\`: yes
- \`apple-mobile-web-app-status-bar-style\`: black-translucent
- \`apple-touch-icon\`: 152x152, 167x167, 180x180
- Splash screens –¥–ª—è iPhone X/XS/11/12/13/14 —Å–µ—Ä–∏–π
- Splash screens –¥–ª—è iPad Pro 11" –∏ 12.9"
- \`safari-pinned-tab\` SVG mask icon

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Icon —Ñ–∞–π–ª—ã –∏ splash screens –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å

### 8.11 –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ P3 (–§–ò–ù–ê–õ)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ù–∞—á–∞–ª—å–Ω–æ–µ | –ü–æ—Å–ª–µ P0-P3 | –¶–µ–ª–µ–≤–æ–µ |
|---------|-----------|-------------|---------|
| Lighthouse PWA Score | ~70 | ~85 | >90 |
| Offline reliability | ~60% | ~95% | >95% ‚úÖ |
| iOS sync success rate | ~40% | ~80% | >80% ‚úÖ |
| "Forever broken" books | –í–æ–∑–º–æ–∂–Ω–æ | 0% | 0% ‚úÖ |
| Recovery rate | 0% | >99% | >99% ‚úÖ |
| Crash –ø–æ—Å–ª–µ idle | –í—ã—Å–æ–∫–∏–π | –û—á–µ–Ω—å —Ä–µ–¥–∫–æ | –û—á–µ–Ω—å —Ä–µ–¥–∫–æ ‚úÖ |
| Storage pressure | –ë–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ | Auto-cleanup | Auto-cleanup ‚úÖ |
| Offline UX | –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω | –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π banner | –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π ‚úÖ |

---

## 9. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ù–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (P4-P5)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 10 —è–Ω–≤–∞—Ä—è 2026
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è P4:** 11 —è–Ω–≤–∞—Ä—è 2026 ‚úÖ
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π review –≤—Å–µ—Ö PWA —Ñ–∞–π–ª–æ–≤ —Å —É—á—ë—Ç–æ–º best practices 2025-2026

### 9.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P4) ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

#### 9.1.1 Storage Management –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø
**–§–∞–π–ª—ã:** `src/stores/index.ts`, `src/App.tsx`, `src/services/storageManager.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–§—É–Ω–∫—Ü–∏—è `initializeStorageManagement()` –∏–∑ `storageManager.ts` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è**:
- Storage pressure monitoring –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- Persistent storage –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- iOS –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ PWA –ø–æ—Å–ª–µ 7 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

```typescript
// storageManager.ts —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç:
export function initializeStorageManagement() {...}

// –ù–û stores/index.ts –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç –µ—ë:
export const initializeStores = () => {
  // –¢–æ–ª—å–∫–æ —Ç–µ–º–∞ –∏ auth, –ù–ï–¢ storage management!
};
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ü–æ—Ç–µ—Ä—è offline –¥–∞–Ω–Ω—ã—Ö –Ω–∞ iOS Safari
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞
- Storage quota warnings –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

#### 9.1.2 Console.log –≤ production (–æ—Å—Ç–∞–≤—à–∏–µ—Å—è)

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø
**–§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–æ–π:**

| –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –¢–∏–ø |
|------|--------|-----|
| `src/hooks/useOnlineStatus.ts` | 51, 66 | console.log –±–µ–∑ DEV check |
| `src/stores/index.ts` | 26-27 | console.log –±–µ–∑ DEV check |
| `src/App.tsx` | 63-67 | Emoji console.log (üöÄ, ‚úÖ, ‚ùå) |

```typescript
// useOnlineStatus.ts:51 - –ë–ï–ó –ü–†–û–í–ï–†–ö–ò
console.log('[useOnlineStatus] Network restored, dispatched app:online event');

// –î–û–õ–ñ–ù–û –ë–´–¢–¨:
if (import.meta.env.DEV) {
  console.log('[useOnlineStatus] Network restored');
}
```

---

#### 9.1.3 Offline —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å hardcoded —Ç–µ–º–æ–π

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø
**–§–∞–π–ª:** `public/offline.html`

**–ü—Ä–æ–±–ª–µ–º–∞:**
Offline —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Å–µ–≥–¥–∞ —Ç—ë–º–Ω–∞—è (#121212), –Ω–µ —É–≤–∞–∂–∞–µ—Ç —Ç–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```html
<!-- Hardcoded dark theme -->
<style>
  body {
    background-color: #121212;
    color: #e8e8e8;
  }
</style>
```

**–í–ª–∏—è–Ω–∏–µ:** –ü–ª–æ—Ö–æ–π UX –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π light/sepia —Ç–µ–º—ã.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CSS variables –∏–ª–∏ JS –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–º—ã –∏–∑ localStorage.

---

#### 9.1.4 –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç batch API –¥–ª—è sendBeacon

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø
**–§–∞–π–ª—ã:** `src/services/syncQueue.ts:229`, Backend

**–ü—Ä–æ–±–ª–µ–º–∞:**
`handleBeforeUnload()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ `/api/v1/sync/batch`, –Ω–æ —ç—Ç–æ—Ç endpoint **–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** –≤ backend:

```typescript
// syncQueue.ts:229
const queued = navigator.sendBeacon('/api/v1/sync/batch', blob);
// ‚Üê Endpoint –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢!
```

**–í–ª–∏—è–Ω–∏–µ:** sendBeacon fallback –¥–ª—è iOS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è.

---

#### 9.1.5 –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Push

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–ò–ó–ö–ê–Ø (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω)
**–§–∞–π–ª:** `src/utils/serviceWorker.ts:194`

```typescript
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (CRA —Å—Ç–∏–ª—å):
const vapidKey = urlBase64ToUint8Array(process.env.REACT_APP_VAPID_PUBLIC_KEY || '');

// –ü–†–ê–í–ò–õ–¨–ù–û (Vite):
const vapidKey = urlBase64ToUint8Array(import.meta.env.VITE_VAPID_PUBLIC_KEY || '');
```

---

#### 9.1.6 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ network monitoring

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–ò–ó–ö–ê–Ø
**–§–∞–π–ª—ã:** `src/utils/serviceWorker.ts`, `src/hooks/useOnlineStatus.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–î–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ç–∏:
1. `NetworkMonitor` –∫–ª–∞—Å—Å –≤ `serviceWorker.ts`
2. `useOnlineStatus` —Ö—É–∫

```typescript
// serviceWorker.ts - —Å–æ–∑–¥–∞—ë—Ç—Å—è singleton
export const networkMonitor = new NetworkMonitor();

// useOnlineStatus.ts - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
export function useOnlineStatus(): OnlineStatus {...}
```

**–í–ª–∏—è–Ω–∏–µ:** –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è, –ª–∏—à–Ω–∏–π –∫–æ–¥.

---

### 9.2 –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (P5)

#### 9.2.1 –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Navigation Preload

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø
**–§–∞–π–ª:** `src/sw.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
Service Worker –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Navigation Preload API, —á—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é:

```typescript
// –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –≤ sw.ts:
addEventListener('activate', event => {
  event.waitUntil(async function() {
    if (self.registration.navigationPreload) {
      await self.registration.navigationPreload.enable();
    }
  }());
});
```

**–í–ª–∏—è–Ω–∏–µ:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ ~50-100ms –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

---

#### 9.2.2 –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Wake Lock API –¥–ª—è Reader

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø
**–§–∞–π–ª—ã:** `src/components/Reader/EpubReader.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–≠–∫—Ä–∞–Ω –º–æ–∂–µ—Ç –≥–∞—Å–Ω—É—Ç—å –≤–æ –≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—è. Screen Wake Lock API –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

```typescript
// –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:
let wakeLock = null;
try {
  wakeLock = await navigator.wakeLock.request('screen');
} catch (err) {
  console.log('Wake Lock not supported');
}
```

**–í–ª–∏—è–Ω–∏–µ:** –ü–ª–æ—Ö–æ–π UX –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º —á—Ç–µ–Ω–∏–∏.

---

#### 9.2.3 –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Badging API

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–ò–ó–ö–ê–Ø
**–§–∞–π–ª—ã:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è App Badging API –¥–ª—è –ø–æ–∫–∞–∑–∞ pending sync count:

```typescript
// –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:
if ('setAppBadge' in navigator) {
  navigator.setAppBadge(pendingCount);
}
```

**–í–ª–∏—è–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç pending –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –∏–∫–æ–Ω–∫–µ.

---

#### 9.2.4 TanStack Query focusManager –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø
**–§–∞–π–ª—ã:** `src/lib/queryClient.ts`, `src/hooks/pwa/usePWAResumeGuard.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
`usePWAResumeGuard` —Ö–æ—Ä–æ—à–∏–π, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `focusManager`:

```typescript
// –ë–æ–ª–µ–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:
import { focusManager } from '@tanstack/react-query';

// –û—Ç–∫–ª—é—á–∏—Ç—å auto-refetch –Ω–∞ –≤—Ä–µ–º—è resume
focusManager.setFocused(false);
// –ü–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:
focusManager.setFocused(true);
```

---

#### 9.2.5 Safari Storage Quota —Ä–∞–∑–ª–∏—á–∏—è

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø
**–§–∞–π–ª:** `src/services/storageManager.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
Safari –∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ Storage API:
- –ù–µ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `quota`
- `navigator.storage.persist()` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

```typescript
// –¢–µ–∫—É—â–∏–π –∫–æ–¥ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç Safari —Å–ø–µ—Ü–∏—Ñ–∏–∫—É:
const estimate = await navigator.storage.estimate();
// Safari –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å quota: undefined
```

---

### 9.1.7 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π P4 ‚úÖ

**–î–∞—Ç–∞:** 11 —è–Ω–≤–∞—Ä—è 2026

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (frontend):

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/stores/index.ts` | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `initializeStorageManagement()`, DEBUG check |
| `src/hooks/useOnlineStatus.ts` | –î–æ–±–∞–≤–ª–µ–Ω DEBUG check –¥–ª—è console.log |
| `src/App.tsx` | –î–æ–±–∞–≤–ª–µ–Ω DEBUG check –¥–ª—è console.log |
| `src/utils/serviceWorker.ts` | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ `VITE_VAPID_PUBLIC_KEY`, —É–¥–∞–ª—ë–Ω NetworkMonitor |
| `public/offline.html` | –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–º (light/dark/sepia) |

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (backend):

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `backend/app/routers/sync.py` | –ù–æ–≤—ã–π endpoint `/api/v1/sync/batch` (347 —Å—Ç—Ä–æ–∫) |

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

| –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|-------|
| Storage Management | ‚ùå –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è | ‚úÖ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ |
| Console.log –≤ prod | ‚ùå –í–∏–¥–Ω—ã | ‚úÖ –°–∫—Ä—ã—Ç—ã |
| Offline page —Ç–µ–º—ã | ‚ùå –¢–æ–ª—å–∫–æ dark | ‚úÖ light/dark/sepia |
| Sync batch endpoint | ‚ùå –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| VAPID env variable | ‚ùå CRA —Å–∏–Ω—Ç–∞–∫—Å–∏—Å | ‚úÖ Vite —Å–∏–Ω—Ç–∞–∫—Å–∏—Å |
| Network monitoring | ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–æ |

---

### 9.3 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Best Practices 2025-2026

| Best Practice | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------------|--------|-------------|
| Workbox 7.x | ‚úÖ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| Navigation Preload | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (P5-1) |
| Periodic Background Sync | ‚ö†Ô∏è | –ß–∞—Å—Ç–∏—á–Ω–æ (iOS fallback) |
| Wake Lock API | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (P5-2) |
| Badging API | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (P5-3) |
| Content-Index API | ‚ùå | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| File Handling API | ‚ùå | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| TanStack Query focusManager | ‚úÖ | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ (P5-4) |
| Persistent Storage request | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (P4-1) |
| Storage pressure handling | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ + Safari (P4-1, P5-5) |

---

### 9.4 –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –Ω–æ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º

| ID | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|----|----------|-----------|-----------|--------|
| P4-1 | Storage Management –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è | –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P4-2 | Console.log –≤ production (–æ—Å—Ç–∞—Ç–∫–∏) | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P4-3 | Offline page hardcoded theme | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P4-4 | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç /api/v1/sync/batch endpoint | –í–´–°–û–ö–ò–ô | –°—Ä–µ–¥–Ω—è—è | ‚úÖ |
| P4-5 | REACT_APP_ –≤–º–µ—Å—Ç–æ VITE_ | –ù–ò–ó–ö–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P4-6 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ network monitoring | –ù–ò–ó–ö–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P5-1 | Navigation Preload | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P5-2 | Wake Lock API –¥–ª—è Reader | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P5-3 | Badging API | –ù–ò–ó–ö–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P5-4 | focusManager integration | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è | ‚úÖ |
| P5-5 | Safari Storage Quota | –°–†–ï–î–ù–ò–ô | –°—Ä–µ–¥–Ω—è—è | ‚úÖ |

### 9.5 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π P5 ‚úÖ

**–î–∞—Ç–∞:** 11 —è–Ω–≤–∞—Ä—è 2026

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `src/hooks/useWakeLock.ts` | –•—É–∫ –¥–ª—è Wake Lock API (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞) |

#### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/sw.ts` | Navigation Preload –≤ activate handler, preloadResponse –≤ fetch |
| `src/services/syncQueue.ts` | Badging API (`updateBadge()` —Ñ—É–Ω–∫—Ü–∏—è) |
| `src/lib/queryClient.ts` | focusManager integration —Å visibilitychange |
| `src/hooks/pwa/usePWAResumeGuard.ts` | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç focusManager.setFocused() |
| `src/services/storageManager.ts` | Safari detection, private browsing, fallback quota |

#### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

**P5-1: Navigation Preload**
```typescript
// sw.ts activate handler
if ('navigationPreload' in sw.registration) {
  await sw.registration.navigationPreload.enable();
}

// fetch handler
const preloadResponse = event.preloadResponse;
if (preloadResponse) {
  return preloadResponse;
}
```

**P5-2: Wake Lock API**
```typescript
// useWakeLock.ts
export function useWakeLock(): UseWakeLockReturn {
  const wakeLockRef = useRef<WakeLockSentinel | null>(null);

  const request = useCallback(async () => {
    wakeLockRef.current = await navigator.wakeLock.request('screen');
  }, []);

  // Auto re-acquire on visibility change
  useEffect(() => {
    const handleVisibility = async () => {
      if (document.visibilityState === 'visible' && wakeLockRef.current) {
        await request();
      }
    };
    // ...
  }, []);
}
```

**P5-3: Badging API**
```typescript
// syncQueue.ts
async function updateBadge(count: number): Promise<void> {
  if (!('setAppBadge' in navigator)) return;
  if (count > 0) {
    await navigator.setAppBadge(count);
  } else {
    await navigator.clearAppBadge();
  }
}
```

**P5-4: TanStack Query focusManager**
```typescript
// queryClient.ts
import { focusManager } from '@tanstack/react-query';

focusManager.setEventListener((handleFocus) => {
  const visibilityHandler = () => {
    handleFocus(document.visibilityState === 'visible');
  };
  document.addEventListener('visibilitychange', visibilityHandler);
  window.addEventListener('app:online', () => handleFocus(true));
  return () => { /* cleanup */ };
});
```

**P5-5: Safari Storage Quota**
```typescript
// storageManager.ts
const isSafari = (): boolean =>
  /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

const isPrivateBrowsing = async (): Promise<boolean> => {
  const estimate = await navigator.storage.estimate();
  return estimate.quota === 0;
};

// Fallback quota for Safari
const quota = estimate.quota ?? (isSafari() ? 50 * 1024 * 1024 : 0);
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã P5:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ |
|---------|-----|-------|
| Navigation Preload | ‚ùå | ‚úÖ (~50-100ms —É—Å–∫–æ—Ä–µ–Ω–∏–µ) |
| Screen Wake Lock | ‚ùå | ‚úÖ (hook –≥–æ—Ç–æ–≤) |
| App Badging | ‚ùå | ‚úÖ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç pending sync) |
| focusManager | –†—É—á–Ω–æ–π | ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω |
| Safari Storage | Undefined quota | ‚úÖ 50MB fallback |

---

## 10. iOS Navigation: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (P6) ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 10 —è–Ω–≤–∞—Ä—è 2026
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 10 —è–Ω–≤–∞—Ä—è 2026
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
**–°–∏–º–ø—Ç–æ–º:** –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iOS (Safari –∏ PWA —Ä–µ–∂–∏–º)

### 10.1 –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞ iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –Ω–µ –º–æ–≥—É—Ç –Ω–∞–≤–∏–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:
- –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ —Å—Å—ã–ª–∫–∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥
- –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –∏ –≤ Safari, –∏ –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º PWA
- –ù–∞ Android –∏ Desktop –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### 10.2 –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Z-Index –∫–æ–ª–ª–∏–∑–∏—è

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:** 15 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `z-[500]`!

```
–§–∞–π–ª—ã —Å z-[500]:
‚îú‚îÄ‚îÄ BottomNav.tsx:35              ‚Üê –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
‚îú‚îÄ‚îÄ MobileDrawer.tsx:191          ‚Üê –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
‚îú‚îÄ‚îÄ Sidebar.tsx:252               ‚Üê –ú–æ–±–∏–ª—å–Ω—ã–π —Å–∞–π–¥–±–∞—Ä
‚îú‚îÄ‚îÄ BookUploadModal.tsx:270       ‚Üê –ú–æ–¥–∞–ª –∑–∞–≥—Ä—É–∑–∫–∏
‚îú‚îÄ‚îÄ DeleteConfirmModal.tsx:57     ‚Üê –ú–æ–¥–∞–ª —É–¥–∞–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ ImageModal.tsx:145            ‚Üê –ú–æ–¥–∞–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îú‚îÄ‚îÄ IOSInstallInstructions.tsx:392 ‚Üê iOS –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ ReaderSettingsPanel.tsx:516   ‚Üê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∏–¥–µ—Ä–∞ (mobile)
‚îú‚îÄ‚îÄ ReaderSettingsPanel.tsx:540   ‚Üê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∏–¥–µ—Ä–∞ (desktop)
‚îú‚îÄ‚îÄ BookInfo.tsx:81               ‚Üê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ
‚îú‚îÄ‚îÄ PositionConflictDialog.tsx:72 ‚Üê –î–∏–∞–ª–æ–≥ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø–æ–∑–∏—Ü–∏–∏
‚îú‚îÄ‚îÄ DeleteConfirmModal.tsx:65     ‚Üê Library DeleteConfirm
‚îú‚îÄ‚îÄ Modal.tsx:267                 ‚Üê –ë–∞–∑–æ–≤—ã–π –º–æ–¥–∞–ª
‚îî‚îÄ‚îÄ TocSidebar.tsx:407            ‚Üê –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ –Ω–∞ iOS Safari:**
- iOS Safari –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç z-index –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ
- Touch events –º–æ–≥—É—Ç "–ø—Ä–æ–≤–∞–ª–∏–≤–∞—Ç—å—Å—è" –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- Fixed —ç–ª–µ–º–µ–Ω—Ç—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º z-index –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞

---

### 10.3 –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ position:fixed

**–§–∞–π–ª:** `src/components/Navigation/BottomNav.tsx:35-38`

```tsx
<nav
  className="fixed bottom-0 inset-x-0 z-[500] md:hidden"
  style={{ position: 'fixed' }}  // ‚Üê –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!
>
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `position: fixed` —É–∫–∞–∑–∞–Ω –¥–≤–∞–∂–¥—ã (Tailwind + inline style)
- –ù–∞ iOS —ç—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–∑–∏—Ü–∏–∏
- Inline style –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç Tailwind –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ

---

### 10.4 –ü–†–û–ë–õ–ï–ú–ê: Backdrop-blur –±–ª–æ–∫–∏—Ä—É–µ—Ç touch events

**–§–∞–π–ª—ã:**
- `BottomNav.tsx:42` - `backdrop-blur-lg`
- `Header.tsx:78` - `backdrop-blur-md`

```tsx
<div className="absolute inset-0 bg-background/80 backdrop-blur-lg" />
```

**–ù–∞ iOS Safari:**
- `backdrop-filter: blur()` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π stacking context
- –ú–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å touch events –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö "–ø–æ–¥" blur —Å–ª–æ–µ–º
- –ò–∑–≤–µ—Å—Ç–Ω—ã–π –±–∞–≥ iOS Safari —Å backdrop-filter + fixed positioning

---

### 10.5 –ü–†–û–ë–õ–ï–ú–ê: Safe Area –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

**–§–∞–π–ª—ã:**
- `index.html:5` - `viewport-fit=cover`
- `BottomNav.tsx:47` - `pb-safe`

```html
<meta name="viewport" content="..., viewport-fit=cover" />
```

```tsx
<ul className="relative flex items-center justify-around pb-safe">
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `viewport-fit=cover` + `fixed bottom-0` + `pb-safe` –Ω–∞ iOS PWA
- Safe area padding –º–æ–∂–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è
- Touch events –≤ –æ–±–ª–∞—Å—Ç–∏ safe area –º–æ–≥—É—Ç –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è

---

### 10.6 –ü–†–û–ë–õ–ï–ú–ê: Framer Motion hover –Ω–∞ touch —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

**–§–∞–π–ª:** `src/components/Library/BookCard.tsx:104-110`

```tsx
<m.div
  whileHover={{ y: -4 }}
  onHoverStart={() => setIsHovered(true)}
  onHoverEnd={() => setIsHovered(false)}
>
```

**–ù–∞ iOS:**
- `whileHover` –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è touch —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `onHoverStart`/`onHoverEnd` –º–æ–≥—É—Ç "–∑–∞—Å—Ç—Ä–µ–≤–∞—Ç—å" –Ω–∞ iOS
- Hover state –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å touch events

---

### 10.7 –ü–†–û–ë–õ–ï–ú–ê: will-change —Å–æ–∑–¥–∞—ë—Ç stacking contexts

**–§–∞–π–ª:** `src/styles/globals.css:822`

```css
.animate-slideIn,
.modal-scrollable,
[data-state="open"],
[data-state="closed"] {
  will-change: transform, opacity;
}
```

**–ù–∞ iOS:**
- `will-change` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π compositing layer
- –≠—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π z-index –ø–æ—Ä—è–¥–æ–∫
- Touch events –º–æ–≥—É—Ç –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π layer

---

### 10.8 –ü–†–û–ë–õ–ï–ú–ê: LazyMotion strict mode

**–§–∞–π–ª:** `src/App.tsx:73`

```tsx
<LazyMotion features={domAnimation} strict>
```

**–ù–∞ iOS:**
- `strict` mode –æ—Ç–∫–ª—é—á–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
- –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å lag –ø—Ä–∏ touch events
- –ê–Ω–∏–º–∞—Ü–∏–∏ –º–æ–≥—É—Ç "—Å—ä–µ–¥–∞—Ç—å" touch events

---

### 10.9 –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–§–∞–∑–∞ P6)

| ID | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|----|-------------|-----------|-----------|
| **P6-1** | –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ z-index —Å–∏—Å—Ç–µ–º—ã | –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô | –í—ã—Å–æ–∫–∞—è |
| **P6-2** | –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ position:fixed | –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô | –ù–∏–∑–∫–∞—è |
| **P6-3** | –û—Ç–∫–ª—é—á–∏—Ç—å backdrop-blur –Ω–∞ iOS | –í–´–°–û–ö–ò–ô | –ù–∏–∑–∫–∞—è |
| **P6-4** | –ò—Å–ø—Ä–∞–≤–∏—Ç—å safe area handling | –í–´–°–û–ö–ò–ô | –°—Ä–µ–¥–Ω—è—è |
| **P6-5** | –ó–∞–º–µ–Ω–∏—Ç—å whileHover –Ω–∞ whileTap –¥–ª—è touch | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è |
| **P6-6** | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å will-change | –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è |
| **P6-7** | –£–±—Ä–∞—Ç—å strict –∏–∑ LazyMotion | –ù–ò–ó–ö–ò–ô | –ù–∏–∑–∫–∞—è |

---

### 10.10 –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è z-index —Å–∏—Å—Ç–µ–º–∞

```
Z-Index Architecture (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥):
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
z-[100] - –ë–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (sticky headers)
z-[200] - Desktop sidebar
z-[300] - Mobile backdrop
z-[400] - Mobile sidebar/drawer
z-[500] - BottomNav (–¢–û–õ–¨–ö–û –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏!)
z-[600] - Dropdowns, tooltips
z-[700] - Modals (–≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞)
z-[800] - Toast notifications
z-[900] - Critical overlays (dialogs, confirms)
z-[1000] - Skip links, accessibility helpers
```

---

### 10.11 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π P6 ‚úÖ

**–î–∞—Ç–∞:** 10 —è–Ω–≤–∞—Ä—è 2026

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `src/lib/zIndex.ts` | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ z-index (9 —É—Ä–æ–≤–Ω–µ–π) |

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (12 —Ñ–∞–π–ª–æ–≤):

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|-----------|-------------|
| `BottomNav.tsx` | z-index via Z_INDEX.bottomNav, —É–¥–∞–ª—ë–Ω –¥—É–±–ª—å position:fixed, pointer-events, env() safe area |
| `Sidebar.tsx` | z-index via Z_INDEX.sidebar/modal, pointer-events |
| `MobileDrawer.tsx` | z-index via Z_INDEX.modalOverlay/modal, pointer-events, whileTap |
| `Modal.tsx` | z-index via Z_INDEX.modalOverlay/modal, pointer-events |
| `BookUploadModal.tsx` | z-index via Z_INDEX, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ backdrop/content |
| `DeleteConfirmModal.tsx` | z-index via Z_INDEX, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ backdrop/content |
| `ImageModal.tsx` | z-index via Z_INDEX, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ backdrop/content |
| `ReaderSettingsPanel.tsx` | z-index via Z_INDEX.modal (mobile + desktop) |
| `BookInfo.tsx` | z-index via Z_INDEX, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ backdrop/content |
| `PositionConflictDialog.tsx` | z-index via Z_INDEX, pointer-events |
| `TocSidebar.tsx` | z-index via Z_INDEX, unconditional whileTap |
| `IOSInstallInstructions.tsx` | z-index via Z_INDEX.iosInstall (1000), onTouchEnd handlers |
| `App.tsx` | –£–¥–∞–ª—ë–Ω `strict` prop –∏–∑ LazyMotion |

#### Z-Index –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):

```typescript
export const Z_INDEX = {
  content: 0,          // –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
  dropdown: 100,       // Dropdown –º–µ–Ω—é
  sticky: 200,         // Sticky —ç–ª–µ–º–µ–Ω—Ç—ã
  overlay: 300,        // –û–≤–µ—Ä–ª–µ–∏
  sidebar: 400,        // –°–∞–π–¥–±–∞—Ä—ã
  bottomNav: 500,      // –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
  header: 510,         // –•–µ–¥–µ—Ä
  modalOverlay: 590,   // Backdrop –º–æ–¥–∞–ª–æ–≤
  modal: 600,          // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  tooltip: 700,        // –¢—É–ª—Ç–∏–ø—ã
  toast: 800,          // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  criticalOverlay: 900, // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–≤–µ—Ä–ª–µ–∏
  iosInstall: 1000,    // iOS Install (–º–∞–∫—Å–∏–º—É–º)
} as const;
```

#### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **Z-Index –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
2. **Pointer-events —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** - backdrop `pointer-events: none`, content `pointer-events: auto`
3. **Safe Area Insets** - inline CSS `env()` –≤–º–µ—Å—Ç–æ Tailwind –∫–ª–∞—Å—Å–æ–≤
4. **Touch events** - –¥–æ–±–∞–≤–ª–µ–Ω—ã `whileTap` –∏ `onTouchEnd` handlers
5. **LazyMotion** - —É–¥–∞–ª—ë–Ω `strict` mode –¥–ª—è iOS —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ |
|---------|-----|-------|
| iOS Navigation | ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| Z-Index –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã | 15 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ | 0 |
| Touch events | –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è | –ü—Ä–æ—Ö–æ–¥—è—Ç |

---

## 11. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 9.1 –°–ø–∏—Å–æ–∫ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤

\`\`\`
src/
‚îú‚îÄ‚îÄ sw.ts                                    # Service Worker
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ db.ts                               # Dexie.js schema
‚îÇ   ‚îú‚îÄ‚îÄ chapterCache.ts                     # Chapter caching
‚îÇ   ‚îú‚îÄ‚îÄ imageCache.ts                       # Image caching
‚îÇ   ‚îú‚îÄ‚îÄ syncQueue.ts                        # Offline sync queue
‚îÇ   ‚îú‚îÄ‚îÄ storageManager.ts                   # Storage management
‚îÇ   ‚îú‚îÄ‚îÄ downloadManager.ts                  # Book downloads
‚îÇ   ‚îî‚îÄ‚îÄ pushNotifications.ts                # Push notifications
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ epub/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useEpubLoader.ts               # EPUB loading
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useLocationGeneration.ts       # ‚Üê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô: epub locations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useChapterManagement.ts        # Chapter management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useProgressSync.ts             # Progress sync
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useDescriptionHighlighting.ts  # Highlighting
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queryKeys.ts                   # TanStack Query keys
‚îÇ   ‚îú‚îÄ‚îÄ usePWAInstall.ts                   # PWA installation
‚îÇ   ‚îú‚îÄ‚îÄ useOnlineStatus.ts                 # Online detection
‚îÇ   ‚îú‚îÄ‚îÄ useDownloadBook.ts                 # Book downloading
‚îÇ   ‚îú‚îÄ‚îÄ useOfflineBook.ts                  # Offline book access
‚îÇ   ‚îú‚îÄ‚îÄ useStorageInfo.ts                  # Storage info
‚îÇ   ‚îú‚îÄ‚îÄ usePushNotifications.ts            # Push notifications
‚îÇ   ‚îî‚îÄ‚îÄ useReadingSession.ts               # Reading sessions
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts                            # Auth store (Zustand)
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ queryClient.ts                     # TanStack Query config
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ iosSupport.ts                      # iOS utilities
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ UI/
‚îÇ       ‚îú‚îÄ‚îÄ PWAUpdatePrompt.tsx            # SW update UI
‚îÇ       ‚îî‚îÄ‚îÄ IOSInstallInstructions.tsx     # iOS install guide
‚îî‚îÄ‚îÄ pages/
    ‚îî‚îÄ‚îÄ BookReaderPage.tsx                 # Reader page
\`\`\`

### 11.2 –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ù–∞—á–∞–ª—å–Ω–æ–µ | –ü–æ—Å–ª–µ P0 | –ü–æ—Å–ª–µ P1 | –ü–æ—Å–ª–µ P2 | –ü–æ—Å–ª–µ P3 | –ü–æ—Å–ª–µ P4 | –ü–æ—Å–ª–µ P5 | –ü–æ—Å–ª–µ P6 | –°—Ç–∞—Ç—É—Å |
|---------|-----------|----------|----------|----------|----------|----------|----------|----------|--------|
| Lighthouse PWA Score | ~70 | ~70 | ~75 | ~80 | ~85 | ~90 | >95 | >95 | ‚úÖ |
| Offline reliability | ~60% | ~70% | ~85% | ~92% | ~95% | ~97% | ~98% | ~98% | ‚úÖ |
| iOS sync success rate | ~40% | ~40% | ~50% | ~75% | ~80% | ~95% | ~95% | ~95% | ‚úÖ |
| **iOS Navigation** | **0%** | - | - | - | - | - | - | **>95%** | ‚úÖ |
| "Forever broken" books | –í–æ–∑–º–æ–∂–Ω–æ | Auto-recovery | Auto-recovery | Auto-recovery | 0% | 0% | 0% | 0% | ‚úÖ |
| Recovery rate | 0% | >95% | >98% | >99% | >99% | >99% | >99% | >99% | ‚úÖ |
| Crash –ø–æ—Å–ª–µ idle | –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∏–π | –†–µ–¥–∫–æ | –û—á–µ–Ω—å —Ä–µ–¥–∫–æ | –ú–∏–Ω–∏–º—É–º | –ú–∏–Ω–∏–º—É–º | –ú–∏–Ω–∏–º—É–º | ‚úÖ |
| **Storage init** | **‚ùå** | - | - | - | - | **‚úÖ** | ‚úÖ | ‚úÖ | ‚úÖ |
| Offline UX | –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω | - | Offline page | - | Banner UI | –¢–µ–º—ã | –¢–µ–º—ã | –¢–µ–º—ã | ‚úÖ |
| **Navigation Preload** | **‚ùå** | - | - | - | - | - | **‚úÖ** | ‚úÖ | ‚úÖ |
| **Wake Lock API** | **‚ùå** | - | - | - | - | - | **‚úÖ** | ‚úÖ | ‚úÖ |
| **Badging API** | **‚ùå** | - | - | - | - | - | **‚úÖ** | ‚úÖ | ‚úÖ |
| **focusManager** | –†—É—á–Ω–æ–π | - | - | - | - | - | **‚úÖ** | ‚úÖ | ‚úÖ |

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|--------|------|-----------|
| 1.0 | 2026-01-10 | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ PWA |
| 1.1 | 2026-01-10 | –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P0)" |
| 1.2 | 2026-01-10 | –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P1)" |
| 1.3 | 2026-01-10 | –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (P2)" |
| 1.4 | 2026-01-10 | –§–∞–∑–∞ P3 –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∏—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ |
| 1.5 | 2026-01-10 | –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ - –≤—ã—è–≤–ª–µ–Ω—ã P4/P5 –ø—Ä–æ–±–ª–µ–º—ã, best practices 2025-2026 |
| 1.6 | 2026-01-10 | **iOS NAVIGATION** - –≤—ã—è–≤–ª–µ–Ω–∞ P6 (z-index –∫–æ–ª–ª–∏–∑–∏—è, 15 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤) |
| 1.7 | 2026-01-10 | **P6 –ó–ê–í–ï–†–®–ï–ù–û** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ iOS –Ω–∞–≤–∏–≥–∞—Ü–∏—è (12 —Ñ–∞–π–ª–æ–≤, z-index —Å–∏—Å—Ç–µ–º–∞) |
| 1.8 | 2026-01-11 | **P4 –ó–ê–í–ï–†–®–ï–ù–û** - storage init, console cleanup, themes, sync endpoint, VAPID fix |
| 1.9 | 2026-01-11 | **P5 –ó–ê–í–ï–†–®–ï–ù–û** - Navigation Preload, Wake Lock API, Badging API, focusManager, Safari storage |

---

**–ê–≤—Ç–æ—Ä:** Claude Code AI
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-10
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-11

## üéâ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù - –í–°–ï –§–ê–ó–´ –í–´–ü–û–õ–ù–ï–ù–´!

PWA –¥–ª—è fancai –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ—Ä–∞–±–æ—Ç–∞–Ω:
- **P0:** "Forever Broken Book" - auto-recovery + —Ä—É—á–Ω–æ–π —Å–±—Ä–æ—Å ‚úÖ
- **P1:** Race condition - PWA Resume Guard ‚úÖ
- **P2:** iOS sync, storage pressure, epub.js recovery ‚úÖ
- **P3:** OfflineBanner, manifest icons, Apple meta tags ‚úÖ
- **P4:** Storage init, console cleanup, offline themes, sync endpoint ‚úÖ
- **P5:** Navigation Preload, Wake Lock, Badging, focusManager, Safari ‚úÖ
- **P6:** iOS Navigation z-index —Å–∏—Å—Ç–µ–º–∞ (12 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤) ‚úÖ

**–ò—Ç–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 30+ —Ñ–∞–π–ª–æ–≤, 7 —Ñ–∞–∑, 36+ –∑–∞–¥–∞—á

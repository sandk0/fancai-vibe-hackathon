# –ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ PWA –¥–ª—è iOS/Android

**–î–∞—Ç–∞:** 2026-01-10
**–°–µ—Ä–≤–µ—Ä:** 77.246.106.109
**–î–æ–º–µ–Ω:** fancai.ru
**–í–µ—Ä—Å–∏–∏ —Ü–µ–ª–µ–≤—ã—Ö –û–°:** iOS 18, iOS 26, Android 15, Android 16

---

## –ß–ê–°–¢–¨ 1: –ê–ù–ê–õ–ò–ó –°–ï–†–í–ï–†–ê

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   Let's Encrypt     ‚îÇ
                    ‚îÇ   SSL Certificate   ‚îÇ
                    ‚îÇ   (–¥–æ 13.03.2026)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   System Nginx      ‚îÇ
                    ‚îÇ   (–ø–æ—Ä—Ç—ã 80, 443)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                   ‚îÇ                   ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ    /      ‚îÇ       ‚îÇ   /api    ‚îÇ       ‚îÇ  /_vite   ‚îÇ
    ‚îÇ   :5173   ‚îÇ       ‚îÇ   :8000   ‚îÇ       ‚îÇ   :5173   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                   ‚îÇ                   ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Vite    ‚îÇ       ‚îÇ  FastAPI  ‚îÇ       ‚îÇ    HMR    ‚îÇ
    ‚îÇ Dev Server‚îÇ       ‚îÇ  Backend  ‚îÇ       ‚îÇ WebSocket ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üõë –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Vite Dev Server –≤ Production

**–§–∞–π–ª:** `/root/fancai-vibe-hackathon/frontend/Dockerfile`

```dockerfile
# –¢–ï–ö–£–©–ò–ô (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô) - Development Dockerfile
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - Dev server —ç–∫—Å–ø–æ–Ω–∏—Ä—É–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥, source maps, stack traces
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, minification, tree-shaking
3. **PWA –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - Service Worker –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, precaching –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **HMR –≤ production** - Hot Module Replacement —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–æ–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
5. **–†–µ—Å—É—Ä—Å—ã** - Dev server –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç –±–æ–ª—å—à–µ CPU/RAM

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
docker exec bookreader_frontend_lite ps aux
# PID   USER     TIME  COMMAND
#   1   root     0:00 npm run dev --host 0.0.0.0
#  18   root     5:43 node /app/node_modules/.bin/vite --host 0.0.0.0
```

**–í—ã–≤–æ–¥:** Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!

---

### –¢–µ–∫—É—â–∏–µ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏ PWA —Ñ–∞–π–ª–æ–≤

**Service Worker (/sw.js):**
```http
HTTP/2 200
content-type: text/javascript          ‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ
cache-control: no-cache                ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–≥–æ
```

**Manifest (/manifest.json):**
```http
HTTP/2 200
content-type: application/json         ‚ö†Ô∏è –î–æ–ª–∂–µ–Ω –±—ã—Ç—å application/manifest+json
cache-control: no-cache                ‚úì OK
```

---

### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–§–∞–π–ª:** `/etc/nginx/sites-enabled/fancai.ru`

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```nginx
server {
    listen 443 ssl http2;
    server_name fancai.ru www.fancai.ru;

    # SSL - OK
    ssl_certificate /etc/letsencrypt/live/fancai.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fancai.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    # ‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢: HSTS header
    # ‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢: Service-Worker-Allowed header
    # ‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢: Proper Content-Type –¥–ª—è manifest.json

    location / {
        proxy_pass http://127.0.0.1:5173;  # Vite dev server
        # ...
    }
}
```

**–ü—Ä–æ–±–ª–µ–º—ã nginx:**
1. –ù–µ—Ç `Strict-Transport-Security` (HSTS) - PWA —Ç—Ä–µ–±—É–µ—Ç HTTPS
2. –ù–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è `sw.js`
3. –ù–µ—Ç `Service-Worker-Allowed` header
4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `Content-Type` –¥–ª—è manifest.json

---

## –ß–ê–°–¢–¨ 2: –°–û–í–†–ï–ú–ï–ù–ù–´–ï –ü–†–ê–ö–¢–ò–ö–ò PWA (2025-2026)

### iOS 18 / Safari 18.0 Features

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|---------|--------|------------|
| Service Workers | ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –° iOS 11.3 |
| Push Notifications | ‚úÖ iOS 16.4+ | **–¢–æ–ª—å–∫–æ –≤ standalone mode!** |
| Background Sync | ‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å visibilitychange + online |
| Periodic Background Sync | ‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è | - |
| IndexedDB | ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –õ–∏–º–∏—Ç 50MB, 7-–¥–Ω–µ–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ |
| Persistent Storage | ‚úÖ iOS 17+ | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç 7-–¥–Ω–µ–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ |
| View Transitions API | ‚úÖ Safari 18 | –ù–æ–≤–æ–µ! –ê–Ω–∏–º–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ |
| Web Extensions in PWA | ‚úÖ Safari 18 | –¢–æ–ª—å–∫–æ macOS |
| Link Opening in PWA | ‚úÖ Safari 18 | –°—Å—ã–ª–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ scope |

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- [WebKit Features in Safari 18.0](https://webkit.org/blog/15865/webkit-features-in-safari-18-0/)
- [iOS PWA Compatibility](https://firt.dev/notes/pwa-ios/)

### iOS 18.1 –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**Digital Markets Act (EU):**
- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å PWA –Ω–∞ Home Screen
- –ú–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–≤–∏–∂–∫–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ WebKit)
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ï–°

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è iOS:**
```typescript
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ standalone mode –¥–ª—è push notifications
const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                    || (navigator as any).standalone === true;

// 2. –ó–∞–ø—Ä–æ—Å Persistent Storage –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 7-–¥–Ω–µ–≤–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
if (navigator.storage?.persist) {
  const granted = await navigator.storage.persist();
  console.log('Persistent storage:', granted ? 'granted' : 'denied');
}

// 3. Workaround –¥–ª—è Background Sync
function setupIOSBackgroundSync() {
  // Sync –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      processSyncQueue();
    }
  });

  // Sync –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  window.addEventListener('online', () => {
    processSyncQueue();
  });
}
```

### iOS 26 (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–ø—É—Å–∫: 2025-2026)

–ù–∞ –º–æ–º–µ–Ω—Ç —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞ iOS 26 –Ω–µ –≤—ã–ø—É—â–µ–Ω–∞. –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è - iOS 18.x.
–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ç—Ä–µ–Ω–¥–∞—Ö Apple:

- –í–æ–∑–º–æ–∂–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ Background Sync
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ IndexedDB (–≤–æ–∑–º–æ–∂–Ω–æ > 50MB)
- –õ—É—á—à–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Home Screen
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Web Push

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–ª–µ–¥–∏—Ç—å –∑–∞ [WebKit Blog](https://webkit.org/blog/) –∏ WWDC 2026.

---

### Android 15/16 PWA Features

| –§—É–Ω–∫—Ü–∏—è | Android 15 | Android 16 | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|---------|------------|------------|------------|
| Service Workers | ‚úÖ | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| Push Notifications | ‚úÖ | ‚úÖ | –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π |
| Background Sync | ‚úÖ | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| Periodic Background Sync | ‚úÖ | ‚úÖ | Chrome-only |
| WebAPK | ‚úÖ | ‚úÖ | –õ—É—á—à–∏–π install experience |
| beforeinstallprompt | ‚úÖ | ‚úÖ | Custom install UI |
| App Shortcuts | ‚úÖ | ‚úÖ | Long-press menu |
| Share Target | ‚úÖ | ‚úÖ | –ü–æ–ª—É—á–µ–Ω–∏–µ shared content |
| File Handling | ‚úÖ | ‚úÖ | –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–æ–≤ |
| TWA (Play Store) | ‚úÖ | ‚úÖ | –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ |

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- [web.dev PWA Installation](https://web.dev/learn/pwa/installation)
- [Android TWA Guide](https://developer.android.com/develop/ui/views/layout/webapps/trusted-web-activities-version2)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Android 15/16

```json
// manifest.json - –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
{
  "name": "fancai - AI –ß–∏—Ç–∞–ª–∫–∞",
  "short_name": "fancai",
  "description": "–ß—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥ —Å –ò–ò-–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è–º–∏",
  "start_url": "/?source=pwa",
  "display": "standalone",
  "orientation": "portrait-primary",
  "theme_color": "#0ea5e9",
  "background_color": "#ffffff",
  "id": "/",

  "icons": [
    { "src": "/icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any" },
    { "src": "/icon-192-maskable.png", "sizes": "192x192", "type": "image/png", "purpose": "maskable" },
    { "src": "/icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any" },
    { "src": "/icon-512-maskable.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
  ],

  "shortcuts": [
    {
      "name": "–ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞",
      "url": "/library",
      "icons": [{ "src": "/icon-shortcut-library.png", "sizes": "192x192" }]
    },
    {
      "name": "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É",
      "url": "/library?action=upload",
      "icons": [{ "src": "/icon-shortcut-upload.png", "sizes": "192x192" }]
    }
  ],

  "screenshots": [
    { "src": "/screenshots/library.png", "sizes": "1280x720", "type": "image/png", "form_factor": "wide" },
    { "src": "/screenshots/reader.png", "sizes": "375x812", "type": "image/png", "form_factor": "narrow" }
  ],

  "share_target": {
    "action": "/upload",
    "method": "POST",
    "enctype": "multipart/form-data",
    "params": {
      "files": [{ "name": "book", "accept": ["application/epub+zip", ".epub", ".fb2"] }]
    }
  },

  "file_handlers": [
    { "action": "/upload", "accept": { "application/epub+zip": [".epub"], "application/x-fictionbook+xml": [".fb2"] } }
  ],

  "launch_handler": { "client_mode": "focus-existing" }
}
```

---

## –ß–ê–°–¢–¨ 3: –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ù–ê–°–¢–†–û–ô–ö–ò NGINX

### –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è PWA

```nginx
server {
    listen 443 ssl http2;
    server_name fancai.ru www.fancai.ru;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/fancai.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fancai.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # Security Headers (PWA —Ç—Ä–µ–±—É–µ—Ç HTTPS)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript
               text/xml application/xml application/manifest+json image/svg+xml;
    gzip_min_length 1000;

    root /var/www/fancai/dist;
    index index.html;

    # =============================================
    # PWA CRITICAL FILES - NO CACHING
    # =============================================

    # Service Worker - NEVER cache
    location = /sw.js {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Service-Worker-Allowed "/" always;
        add_header X-Content-Type-Options "nosniff" always;
        expires off;
        etag off;
        try_files $uri =404;
    }

    # Web App Manifest
    location = /manifest.json {
        add_header Cache-Control "no-cache, must-revalidate" always;
        add_header Content-Type "application/manifest+json" always;
        try_files $uri =404;
    }

    # =============================================
    # STATIC ASSETS - AGGRESSIVE CACHING
    # =============================================

    # Versioned assets (with hash in filename)
    location ~* \.(?:js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        try_files $uri =404;
    }

    # Images
    location ~* \.(?:png|jpg|jpeg|gif|ico|svg|webp)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform" always;
        try_files $uri =404;
    }

    # Fonts
    location ~* \.(?:woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        add_header Access-Control-Allow-Origin "*" always;
        try_files $uri =404;
    }

    # =============================================
    # API PROXY
    # =============================================

    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        client_max_body_size 100M;
    }

    # =============================================
    # SPA FALLBACK
    # =============================================

    location / {
        # HTML - –∫–æ—Ä–æ—Ç–∫–∏–π –∫–µ—à –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        location ~* \.html$ {
            add_header Cache-Control "no-cache, must-revalidate" always;
        }

        try_files $uri $uri/ /index.html;
    }
}
```

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- [Service Worker should not be cached](https://github.com/h5bp/server-configs-nginx/issues/158)
- [Guide to Service Worker Pitfalls](https://www.thecodeship.com/web-development/guide-service-worker-pitfalls-best-practices/)

---

## –ß–ê–°–¢–¨ 4: WORKBOX BEST PRACTICES 2025-2026

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// sw.ts - –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Workbox

import { precacheAndRoute, cleanupOutdatedCaches } from 'workbox-precaching';
import { registerRoute, NavigationRoute } from 'workbox-routing';
import { NetworkFirst, CacheFirst, StaleWhileRevalidate } from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';
import { CacheableResponsePlugin } from 'workbox-cacheable-response';
import { BackgroundSyncPlugin } from 'workbox-background-sync';

// Precaching (static assets)
precacheAndRoute(self.__WB_MANIFEST);
cleanupOutdatedCaches();

// 1. API Requests - Network First (—Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
registerRoute(
  ({ url }) => url.pathname.startsWith('/api/v1/') && !url.pathname.includes('/auth/'),
  new NetworkFirst({
    cacheName: 'api-cache',
    networkTimeoutSeconds: 10,
    plugins: [
      new CacheableResponsePlugin({ statuses: [0, 200] }),
      new ExpirationPlugin({ maxEntries: 100, maxAgeSeconds: 3600 }),
    ],
  })
);

// 2. Images - Cache First (—Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è)
registerRoute(
  ({ request }) => request.destination === 'image',
  new CacheFirst({
    cacheName: 'images-cache',
    plugins: [
      new CacheableResponsePlugin({ statuses: [0, 200] }),
      new ExpirationPlugin({
        maxEntries: 200,
        maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
        purgeOnQuotaError: true, // –í–∞–∂–Ω–æ –¥–ª—è iOS!
      }),
    ],
  })
);

// 3. Fonts - Cache First (immutable)
registerRoute(
  ({ url }) => url.origin === 'https://fonts.gstatic.com',
  new CacheFirst({
    cacheName: 'google-fonts',
    plugins: [
      new CacheableResponsePlugin({ statuses: [0, 200] }),
      new ExpirationPlugin({ maxAgeSeconds: 365 * 24 * 60 * 60 }),
    ],
  })
);

// 4. Static Assets - Stale While Revalidate
registerRoute(
  ({ request }) =>
    request.destination === 'script' ||
    request.destination === 'style',
  new StaleWhileRevalidate({
    cacheName: 'static-assets',
    plugins: [
      new CacheableResponsePlugin({ statuses: [0, 200] }),
    ],
  })
);

// 5. Background Sync –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
const bgSyncPlugin = new BackgroundSyncPlugin('offline-queue', {
  maxRetentionTime: 24 * 60, // 24 hours
});

registerRoute(
  ({ url }) => url.pathname.match(/\/api\/v1\/books\/[^/]+\/progress$/),
  new NetworkFirst({
    plugins: [bgSyncPlugin],
  }),
  'POST'
);
```

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- [Workbox Documentation](https://web.dev/learn/pwa/workbox)
- [PWA Caching Strategies](https://blog.pixelfreestudio.com/best-practices-for-pwa-offline-caching-strategies/)

---

## –ß–ê–°–¢–¨ 5: –ú–ê–¢–†–ò–¶–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò

### –ü–æ–ª–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ PWA —Ñ—É–Ω–∫—Ü–∏–π

| –§—É–Ω–∫—Ü–∏—è | iOS 18 | iOS 17 | Android 16 | Android 15 | Chrome Desktop |
|---------|--------|--------|------------|------------|----------------|
| **Install** |
| beforeinstallprompt | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| Add to Home Screen | ‚úÖ manual | ‚úÖ manual | ‚úÖ | ‚úÖ | ‚úÖ |
| WebAPK | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | N/A |
| **Offline** |
| Service Workers | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Cache Storage | ‚úÖ 50MB | ‚úÖ 50MB | ‚úÖ | ‚úÖ | ‚úÖ |
| IndexedDB | ‚úÖ 7-day* | ‚úÖ 7-day* | ‚úÖ | ‚úÖ | ‚úÖ |
| Background Sync | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| Periodic Sync | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| **Engagement** |
| Push Notifications | ‚úÖ standalone | ‚úÖ standalone | ‚úÖ | ‚úÖ | ‚úÖ |
| Badging API | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Share Target | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| File Handling | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| **UI** |
| View Transitions | ‚úÖ Safari 18 | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| Window Controls Overlay | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| App Shortcuts | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |

*7-day eviction –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Persistent Storage API

---

## –ß–ê–°–¢–¨ 6: –†–ï–ó–Æ–ú–ï –ò –ü–†–ò–û–†–ò–¢–ï–¢–´

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–µ—Ä–≤–µ—Ä–∞

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –í–ª–∏—è–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|----------|---------|-----------|
| 1 | **Vite dev server –≤ production** | PWA –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | P0 |
| 2 | –ù–µ—Ç HSTS header | SEO, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | P1 |
| 3 | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Content-Type –¥–ª—è manifest | PWA install | P1 |
| 4 | –ù–µ—Ç Service-Worker-Allowed header | –ö–æ–Ω—Å–æ–ª—å warnings | P2 |

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è iOS 18

1. **Persistent Storage** - –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 7-–¥–Ω–µ–≤–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
2. **iOS Sync Workaround** - visibilitychange + online events
3. **iOS Install Instructions** - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
4. **View Transitions** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π (Safari 18)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è Android 15/16

1. **Custom Install Prompt** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å beforeinstallprompt
2. **App Shortcuts** - –¥–æ–±–∞–≤–∏—Ç—å –≤ manifest.json
3. **Screenshots** - –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ install dialog
4. **Share Target** - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Share
5. **File Handlers** - –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è .epub/.fb2 —Ñ–∞–π–ª–æ–≤

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–≤–µ—Ä—à—ë–Ω
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å production Dockerfile –¥–ª—è frontend
3. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å docker-compose.lite.yml –¥–ª—è production
5. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å iOS-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ workarounds –≤ –∫–æ–¥

# fancai - Backend Production Environment Variables
#
# ⚠️  SECURITY WARNING ⚠️
# - This is a TEMPLATE file with placeholder values
# - DO NOT commit actual secrets to git!
# - Copy to .env.production and replace all CHANGE_ME values
# - Generate strong secrets using the provided script:
#   bash scripts/generate-production-secrets.sh
#

# =============================================================================
# APPLICATION SETTINGS
# =============================================================================
APP_NAME=fancai
APP_VERSION=0.1.0
ENVIRONMENT=production
DEBUG=false

# =============================================================================
# SECURITY KEYS (CRITICAL!)
# =============================================================================
# Generate with: openssl rand -hex 32
SECRET_KEY=CHANGE_ME_GENERATE_WITH_openssl_rand_hex_32
JWT_SECRET_KEY=CHANGE_ME_GENERATE_WITH_openssl_rand_hex_32
JWT_ALGORITHM=HS256

# Token expiration (extended for book reading app - users stay logged in)
ACCESS_TOKEN_EXPIRE_MINUTES=10080
REFRESH_TOKEN_EXPIRE_DAYS=30

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
# Format: postgresql+asyncpg://user:password@host:port/database
DATABASE_URL=postgresql+asyncpg://bookreader_user:CHANGE_ME_DB_PASSWORD@postgres:5432/bookreader_prod

# Connection pool settings
MAX_CONNECTIONS_COUNT=20
MIN_CONNECTIONS_COUNT=5

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================
REDIS_URL=redis://:CHANGE_ME_REDIS_PASSWORD@redis:6379/0
REDIS_CACHE_ENABLED=true
REDIS_CACHE_DEFAULT_TTL=3600

# =============================================================================
# ADMIN CREDENTIALS
# =============================================================================
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD_MIN_12_CHARS

# =============================================================================
# CORS AND SECURITY
# =============================================================================
# Comma-separated list of allowed origins
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# =============================================================================
# FILE UPLOADS
# =============================================================================
MAX_UPLOAD_SIZE=52428800
UPLOAD_DIRECTORY=./uploads
ALLOWED_EXTENSIONS=.epub,.fb2

# =============================================================================
# AI SERVICES
# =============================================================================
POLLINATIONS_ENABLED=true
POLLINATIONS_BASE_URL=https://image.pollinations.ai

# Optional AI services
OPENAI_API_KEY=
MIDJOURNEY_API_KEY=

# =============================================================================
# PAYMENT SYSTEMS (Optional)
# =============================================================================
YOOKASSA_SHOP_ID=
YOOKASSA_SECRET_KEY=
CLOUDPAYMENTS_PUBLIC_ID=

# =============================================================================
# NLP SETTINGS
# =============================================================================
SPACY_MODEL=ru_core_news_lg
NLTK_DATA_PATH=./nltk_data

# =============================================================================
# SUBSCRIPTION LIMITS
# =============================================================================
FREE_BOOKS_LIMIT=3
FREE_GENERATIONS_LIMIT=50
PREMIUM_BOOKS_LIMIT=50
PREMIUM_GENERATIONS_LIMIT=500

# =============================================================================
# MULTI-NLP CONFIGURATION (October 2025)
# =============================================================================
# Processing mode: single, parallel, sequential, ensemble, adaptive
MULTI_NLP_MODE=ensemble

# Ensemble voting consensus threshold (0.0-1.0)
CONSENSUS_THRESHOLD=0.6

# Processor weights for ensemble voting
SPACY_WEIGHT=1.0
NATASHA_WEIGHT=1.2
STANZA_WEIGHT=0.8

# =============================================================================
# CFI CONFIGURATION (October 2025)
# =============================================================================
# Maximum CFI string length (characters)
CFI_MAX_LENGTH=500

# Enable CFI validation
CFI_VALIDATION_ENABLED=true

# =============================================================================
# GUNICORN/UVICORN WORKERS (Production Optimization)
# =============================================================================
# For 2 CPU cores, recommended: (2 * cores) + 1 = 5 workers
# For staging/limited resources, use 4 workers to save memory
WORKERS_COUNT=4

# Worker timeout (seconds) - increase for slow NLP operations
WORKER_TIMEOUT=300

# Worker max requests before restart (memory leak prevention)
WORKER_MAX_REQUESTS=1000
WORKER_MAX_REQUESTS_JITTER=100

# =============================================================================
# CELERY CONFIGURATION (Limited Resources Optimization)
# =============================================================================
# Celery worker concurrency (parallel tasks)
# For 4GB RAM, use 1-2 to avoid memory exhaustion
CELERY_CONCURRENCY=1

# Max tasks before worker restart (memory leak prevention)
CELERY_MAX_TASKS_PER_CHILD=100

# Max memory per Celery worker child (KB)
# 1572864 KB = 1.5 GB (safe for 4GB total RAM)
CELERY_MAX_MEMORY_PER_CHILD=1572864

# =============================================================================
# DATABASE CONNECTION POOL (Production Optimization)
# =============================================================================
# Base connection pool size
DB_POOL_SIZE=10

# Max overflow connections (total = pool_size + max_overflow)
DB_MAX_OVERFLOW=10

# Connection recycle time (seconds)
DB_POOL_RECYCLE=3600

# Connection pool timeout (seconds)
DB_POOL_TIMEOUT=30

# =============================================================================
# REDIS CONNECTION POOL (Production Optimization)
# =============================================================================
# Maximum Redis connections
REDIS_MAX_CONNECTIONS=50

# =============================================================================
# LOGGING
# =============================================================================
LOG_LEVEL=INFO

# =============================================================================
# WEB PUSH (VAPID) CONFIGURATION (January 2026)
# =============================================================================
# Generate VAPID keys with: npx web-push generate-vapid-keys
# These are required for PWA push notifications
VAPID_PUBLIC_KEY=
VAPID_PRIVATE_KEY=
VAPID_SUBJECT=mailto:admin@fancai.ru

# =============================================================================
# MONITORING (Optional)
# =============================================================================
GRAFANA_USER=admin
GRAFANA_PASSWORD=CHANGE_ME_GENERATE_SECURE_PASSWORD
SLACK_WEBHOOK_URL=

# =============================================================================
# STAGING/LIMITED RESOURCES PROFILE
# =============================================================================
# Recommended settings for 4GB RAM / 2 CPU cores:
#
# WORKERS_COUNT=4                    # (2*cores) balanced
# DB_POOL_SIZE=10                    # Reduced from 20 (save memory)
# DB_MAX_OVERFLOW=10                 # Reduced from 40 (save memory)
# REDIS_MAX_CONNECTIONS=50           # Default
# CELERY_CONCURRENCY=1               # Single task at a time (avoid OOM)
# CELERY_MAX_MEMORY_PER_CHILD=1572864  # 1.5GB limit
#
# Total estimated memory usage: ~3.2GB (80% of 4GB, safe margin)
# =============================================================================

# =============================================================================
# PRODUCTION/HIGH RESOURCES PROFILE
# =============================================================================
# Recommended settings for 8GB+ RAM / 4+ CPU cores:
#
# WORKERS_COUNT=9                    # (2*4 + 1) for 4 cores
# DB_POOL_SIZE=20                    # High concurrency
# DB_MAX_OVERFLOW=40                 # Handle bursts
# REDIS_MAX_CONNECTIONS=100          # High throughput
# CELERY_CONCURRENCY=4               # Parallel task processing
# CELERY_MAX_MEMORY_PER_CHILD=3145728  # 3GB limit
# =============================================================================

# =============================================================================
# NOTES
# =============================================================================
# 1. Generate all secrets using: bash scripts/generate-production-secrets.sh
# 2. Store actual .env.production in secure location (1Password, AWS Secrets Manager, etc.)
# 3. Never commit .env.production to git
# 4. Use different secrets for staging and production
# 5. Rotate secrets regularly (every 90 days recommended)
# 6. Minimum password length: 12 characters with complexity requirements
# 7. Use strong database and Redis passwords (min 32 chars random)
# 8. Adjust worker/pool settings based on your server resources
# 9. Monitor memory usage and adjust CELERY_MAX_MEMORY_PER_CHILD if needed
# 10. For multi-NLP, ensemble mode provides best quality but uses more CPU

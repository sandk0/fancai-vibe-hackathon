# Архитектура Multi-NLP системы

## Текущая архитектура (As-Is)

```
┌─────────────────────────────────────────────────────────────┐
│                    MULTI-NLP MANAGER                        │
│                    (627 строк - GOD OBJECT)                 │
├─────────────────────────────────────────────────────────────┤
│ Ответственность:                                            │
│  • Инициализация процессоров                                │
│  • Загрузка конфигурации                                    │
│  • Роутинг режимов (SINGLE/PARALLEL/SEQUENTIAL/ENSEMBLE/ADAPTIVE)│
│  • Логика ensemble voting                                   │
│  • Адаптивный выбор процессора                             │
│  • Отслеживание статистики                                  │
│  • Расчет метрик качества                                   │
└─────────────────────────────────────────────────────────────┘
                        │
                        ├─────────────┬─────────────┬─────────────┐
                        ▼             ▼             ▼             ▼
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │   SPACY      │ │   NATASHA    │ │   STANZA     │
            │ PROCESSOR    │ │  PROCESSOR   │ │  PROCESSOR   │
            │ (610 строк)  │ │ (486 строк)  │ │ (519 строк)  │
            └──────────────┘ └──────────────┘ └──────────────┘
                    │                │                │
                    ▼                ▼                ▼
            ┌──────────────────────────────────────────────┐
            │   ДУБЛИРОВАННЫЙ КОД ВО ВСЕХ ПРОЦЕССОРАХ      │
            │  • _clean_text() - 100% дубликат             │
            │  • _filter_and_*() - 80% дубликат            │
            │  • Маппинг типов - 85% дубликат              │
            │  • Оценка качества - 70% дубликат            │
            └──────────────────────────────────────────────┘
```

### Проблемы:
- **God Object:** Manager имеет слишком много ответственности
- **Дублирование кода:** ~40% дублирования между процессорами
- **Жесткая обработка режимов:** Жестко закодированные switch statements
- **Плохая тестируемость:** Сложные зависимости, сложно мокировать
- **Тесная связанность:** Процессоры тесно связаны с manager

---

## Целевая архитектура (To-Be)

```
┌─────────────────────────────────────────────────────────────────┐
│                     MULTI-NLP MANAGER                           │
│                       (<300 строк)                              │
├─────────────────────────────────────────────────────────────────┤
│ Основная ответственность:                                       │
│  • Оркестрация потока обработки                                │
│  • Делегирование стратегиям                                    │
│  • Сбор и возврат результатов                                  │
└─────────────────────────────────────────────────────────────────┘
          │              │                │              │
          │              │                │              │
          ▼              ▼                ▼              ▼
    ┌─────────┐   ┌─────────┐   ┌──────────────┐   ┌──────────┐
    │PROCESSOR│   │PROCESSOR│   │   STRATEGY   │   │ SHARED   │
    │REGISTRY │   │ CONFIG  │   │   FACTORY    │   │UTILITIES │
    │ (Plugin)│   │ LOADER  │   │  (Modes)     │   │          │
    └─────────┘   └─────────┘   └──────────────┘   └──────────┘
          │              │                │              │
          │              │                │              │
          ▼              │                ▼              ▼
    ┌─────────┐         │     ┌────────────────┐  ┌────────────┐
    │ SpaCy   │         │     │   STRATEGIES   │  │ TEXT       │
    │ Plugin  │         │     ├────────────────┤  │ CLEANER    │
    │         │         │     │ • Single       │  └────────────┘
    ├─────────┤         │     │ • Parallel     │  ┌────────────┐
    │ Natasha │         │     │ • Sequential   │  │DESCRIPTION │
    │ Plugin  │         │     │ • Ensemble ────┼──▶ FILTER    │
    │         │         │     │ • Adaptive     │  └────────────┘
    ├─────────┤         │     └────────────────┘  ┌────────────┐
    │ Stanza  │         │              │          │   TYPE     │
    │ Plugin  │         │              ▼          │  MAPPER    │
    │         │         │     ┌────────────────┐  └────────────┘
    └─────────┘         │     │   ENSEMBLE     │  ┌────────────┐
          │             │     │    VOTER       │  │  QUALITY   │
          │             │     │ • Weighted     │  │  SCORER    │
          │             │     │ • Consensus    │  └────────────┘
          │             │     │ • Threshold    │  ┌────────────┐
          │             │     └────────────────┘  │DEDUPLICATOR│
          │             │                         └────────────┘
          ▼             ▼
    ┌─────────────────────────────────────────┐
    │      PROCESSORS (Plugins)               │
    │  ┌────────────┐ ┌────────────┐ ┌────────────┐
    │  │   SpaCy    │ │  Natasha   │ │  Stanza    │
    │  │ Processor  │ │ Processor  │ │ Processor  │
    │  │(~400 строк)│ │(~350 строк)│ │(~400 строк)│
    │  └────────────┘ └────────────┘ └────────────┘
    │     Используют общие утилиты, без дублирования
    └─────────────────────────────────────────┘
```

### Преимущества:
- **Единая ответственность:** Каждый компонент имеет одну четкую цель
- **Без дублирования:** Общие утилиты используются всеми процессорами
- **Open/Closed:** Легко добавлять новые процессоры (plugins) и режимы (strategies)
- **Тестируемость:** Каждый компонент может быть протестирован изолированно
- **Слабая связанность:** Процессоры независимы от manager

---

## Диаграммы потока обработки

### Поток режима Single

```
Запрос пользователя
    │
    ▼
┌────────────────┐
│ Multi-NLP      │
│ Manager        │
└────────────────┘
    │
    ▼
┌────────────────┐
│ Single         │
│ Strategy       │
└────────────────┘
    │
    ▼
┌────────────────┐      ┌────────────┐
│ Text Cleaner   │─────▶│ Clean Text │
└────────────────┘      └────────────┘
    │
    ▼
┌────────────────┐      ┌────────────┐
│ SpaCy          │─────▶│Descriptions│
│ Processor      │      └────────────┘
└────────────────┘
    │
    ▼
┌────────────────┐      ┌────────────┐
│ Description    │─────▶│ Filtered   │
│ Filter         │      │Descriptions│
└────────────────┘      └────────────┘
    │
    ▼
Возврат пользователю
```

### Поток режима Parallel

```
Запрос пользователя
    │
    ▼
┌────────────────┐
│ Multi-NLP      │
│ Manager        │
└────────────────┘
    │
    ▼
┌────────────────┐
│ Parallel       │
│ Strategy       │
└────────────────┘
    │
    ▼
┌────────────────┐      ┌────────────┐
│ Text Cleaner   │─────▶│ Clean Text │
└────────────────┘      └────────────┘
    │
    ├─────────────┬─────────────┬─────────────┐
    ▼             ▼             ▼
┌─────────┐  ┌─────────┐  ┌─────────┐
│ SpaCy   │  │ Natasha │  │ Stanza  │
│Processor│  │Processor│  │Processor│
└─────────┘  └─────────┘  └─────────┘
    │             │             │
    └─────────────┴─────────────┘
                  │
                  ▼
         ┌────────────────┐      ┌────────────┐
         │ Deduplicator   │─────▶│  Unique    │
         │                │      │Descriptions│
         └────────────────┘      └────────────┘
                  │
                  ▼
         ┌────────────────┐      ┌────────────┐
         │ Description    │─────▶│  Filtered  │
         │ Filter         │      │Descriptions│
         └────────────────┘      └────────────┘
                  │
                  ▼
         Возврат пользователю
```

### Поток режима Ensemble

```
Запрос пользователя
    │
    ▼
┌────────────────┐
│ Multi-NLP      │
│ Manager        │
└────────────────┘
    │
    ▼
┌────────────────┐
│ Ensemble       │
│ Strategy       │
└────────────────┘
    │
    ▼
┌────────────────┐      ┌────────────┐
│ Text Cleaner   │─────▶│ Clean Text │
└────────────────┘      └────────────┘
    │
    ├─────────────┬─────────────┬─────────────┐
    ▼             ▼             ▼
┌─────────┐  ┌─────────┐  ┌─────────┐
│ SpaCy   │  │ Natasha │  │ Stanza  │
│  w=1.0  │  │  w=1.2  │  │  w=0.8  │
└─────────┘  └─────────┘  └─────────┘
    │             │             │
    └─────────────┴─────────────┘
                  │
                  ▼
         ┌────────────────┐
         │ Ensemble Voter │
         │ • Группировка  │
         │ • Применение   │
         │   весов        │
         │ • Consensus >0.6│
         └────────────────┘
                  │
                  ▼
         ┌────────────────┐      ┌────────────┐
         │ Description    │─────▶│    Best    │
         │ Filter         │      │Descriptions│
         └────────────────┘      └────────────┘
                  │
                  ▼
         Возврат пользователю
```

### Поток режима Adaptive

```
Запрос пользователя (text)
    │
    ▼
┌────────────────┐
│ Multi-NLP      │
│ Manager        │
└────────────────┘
    │
    ▼
┌────────────────┐
│ Adaptive       │
│ Strategy       │
└────────────────┘
    │
    ▼
┌────────────────────────────────┐
│ Анализ текста                  │
│ • Проверка длины (>1000 слов)  │
│ • Проверка имен (regex)        │
│ • Проверка локаций (keywords)  │
│ • Оценка сложности (0.0-1.0)   │
└────────────────────────────────┘
    │
    ├──────────────────┬──────────────────┐
    │                  │                  │
    ▼                  ▼                  ▼
Сложный текст   Средний текст     Простой текст
(сложность>0.8)  (2 процессора)   (1 процессор)
    │                  │                  │
    ▼                  ▼                  ▼
┌─────────┐      ┌─────────┐      ┌─────────┐
│ENSEMBLE │      │PARALLEL │      │ SINGLE  │
│  MODE   │      │  MODE   │      │  MODE   │
└─────────┘      └─────────┘      └─────────┘
    │                  │                  │
    └──────────────────┴──────────────────┘
                       │
                       ▼
              Возврат пользователю
```

---

## Plugin архитектура

```
┌──────────────────────────────────────────┐
│     PROCESSOR PLUGIN REGISTRY            │
├──────────────────────────────────────────┤
│ register(plugin)                         │
│ get_plugin(name) → ProcessorPlugin       │
│ list_plugins() → List[str]               │
└──────────────────────────────────────────┘
                  │
                  ├────────────┬────────────┬────────────┐
                  ▼            ▼            ▼            ▼
         ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
         │ SpaCy Plugin │ │Natasha Plugin│ │ Stanza Plugin│
         ├──────────────┤ ├──────────────┤ ├──────────────┤
         │ name: "spacy"│ │name:"natasha"│ │ name:"stanza"│
         │ version: 1.0 │ │ version: 1.0 │ │ version: 1.0 │
         ├──────────────┤ ├──────────────┤ ├──────────────┤
         │create_       │ │create_       │ │create_       │
         │processor()   │ │processor()   │ │processor()   │
         └──────────────┘ └──────────────┘ └──────────────┘
                  │            │            │
                  ▼            ▼            ▼
         ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
         │   SpaCy      │ │   Natasha    │ │   Stanza     │
         │  Processor   │ │  Processor   │ │  Processor   │
         └──────────────┘ └──────────────┘ └──────────────┘

Преимущества:
• Легко добавлять новые процессоры без изменения core кода
• Поддержка сторонних процессоров
• Управление версиями для каждого процессора
• Четкое разделение ответственности
```

---

## Strategy Pattern для режимов

```
┌──────────────────────────────────────────┐
│         STRATEGY FACTORY                 │
├──────────────────────────────────────────┤
│ register(mode, strategy)                 │
│ get(mode) → ProcessingStrategy           │
└──────────────────────────────────────────┘
                  │
                  ├────────┬────────┬────────┬────────┐
                  ▼        ▼        ▼        ▼        ▼
          ┌─────────┐┌─────────┐┌──────────┐┌─────────┐┌─────────┐
          │ Single  ││Parallel ││Sequential││Ensemble ││Adaptive │
          │Strategy ││Strategy ││ Strategy ││Strategy ││Strategy │
          └─────────┘└─────────┘└──────────┘└─────────┘└─────────┘
               │          │          │          │          │
               └──────────┴──────────┴──────────┴──────────┘
                                     │
                   Все реализуют интерфейс ProcessingStrategy:
                   • process(text, processors) → ProcessingResult
                   • estimate_processing_time(text_length) → float

Преимущества:
• Принцип Open/Closed: Добавляем новые режимы без изменения manager
• Каждая стратегия изолирована и тестируема
• Легко проводить A/B тестирование разных стратегий
• Четкое разделение логики режимов
```

---

## Архитектура общих утилит

```
┌──────────────────────────────────────────────────────────┐
│                  SHARED UTILITIES                        │
└──────────────────────────────────────────────────────────┘
    │
    ├─────────────┬─────────────┬─────────────┬─────────────┐
    ▼             ▼             ▼             ▼             ▼
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│  TEXT   │  │DESC.    │  │  TYPE   │  │QUALITY  │  │DEDUPLI- │
│ CLEANER │  │ FILTER  │  │ MAPPER  │  │ SCORER  │  │ CATOR   │
└─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘
    │             │             │             │             │
    ▼             ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────┐
│            Используется ВСЕМИ процессорами                  │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│  │  SpaCy   │    │ Natasha  │    │  Stanza  │             │
│  │Processor │    │Processor │    │Processor │             │
│  └──────────┘    └──────────┘    └──────────┘             │
└─────────────────────────────────────────────────────────────┘

Преимущества:
• Отсутствие дублирования кода (с 40% до <10%)
• Консистентное поведение между всеми процессорами
• Единый источник истины
• Легче поддерживать и тестировать
• Сокращение ~400 строк кода
```

---

## Поток данных: Обработка книги

```
┌──────────────────────────────────────────────────────────┐
│              ПОЛЬЗОВАТЕЛЬ ЗАГРУЖАЕТ КНИГУ                │
└──────────────────────────────────────────────────────────┘
                          │
                          ▼
              ┌────────────────────┐
              │   BOOK PARSER      │
              │ • Извлечение глав  │
              │ • Извлечение       │
              │   метаданных       │
              └────────────────────┘
                          │
                          ▼
              ┌────────────────────┐
              │   ГЛАВЫ            │
              │ Глава 1: "..."     │
              │ Глава 2: "..."     │
              │ ...                │
              └────────────────────┘
                          │
                          ▼
              ┌────────────────────────────┐
              │   MULTI-NLP MANAGER        │
              │ Режим: ENSEMBLE            │
              │ Процессоры: SpaCy, Natasha │
              └────────────────────────────┘
                          │
            ┌─────────────┴─────────────┐
            ▼                           ▼
    ┌──────────────┐            ┌──────────────┐
    │ Глава 1      │            │ Глава 2      │
    │ Обработка    │            │ Обработка    │
    └──────────────┘            └──────────────┘
            │                           │
            ▼                           ▼
    ┌──────────────┐            ┌──────────────┐
    │Описания      │            │Описания      │
    │• 127 описаний│            │• 105 описаний│
    │• 4.2s        │            │• 3.8s        │
    └──────────────┘            └──────────────┘
            │                           │
            └─────────────┬─────────────┘
                          ▼
              ┌────────────────────┐
              │ PRIORITY QUEUE     │
              │ (Генерация         │
              │  изображений)      │
              └────────────────────┘
                          │
                          ▼
              ┌────────────────────┐
              │   GENERATED        │
              │   IMAGES           │
              │ • pollinations.ai  │
              └────────────────────┘
                          │
                          ▼
              ┌────────────────────┐
              │   READER UI        │
              │ • Текст + Images   │
              │ • Modal по клику   │
              └────────────────────┘
```

---

## Точки оптимизации производительности

```
┌────────────────────────────────────────────────────────┐
│        ВОЗМОЖНОСТИ ДЛЯ ОПТИМИЗАЦИИ                     │
└────────────────────────────────────────────────────────┘

1. ПАРАЛЛЕЛЬНАЯ ЗАГРУЗКА МОДЕЛЕЙ (-50% времени инициализации)
   ┌─────────────────────────────────────┐
   │ Сейчас: Последовательно (6-10 сек)  │
   │ SpaCy  ████ 3s                      │
   │ Natasha ██ 2s                       │
   │ Stanza  █████ 5s                    │
   │ Всего: 10s                          │
   └─────────────────────────────────────┘

   ┌─────────────────────────────────────┐
   │ Оптимизировано: Parallel (3-5 сек)  │
   │ SpaCy  ████                         │
   │ Natasha ██                          │
   │ Stanza  █████                       │
   │ Всего: 5s (max из трех)             │
   └─────────────────────────────────────┘

2. ОБЩАЯ ПРЕДОБРАБОТКА ТЕКСТА (-10% обработки)
   ┌─────────────────────────────────────┐
   │ Сейчас: 3x очистка текста           │
   │ Clean → SpaCy                       │
   │ Clean → Natasha                     │
   │ Clean → Stanza                      │
   └─────────────────────────────────────┘

   ┌─────────────────────────────────────┐
   │ Оптимизировано: 1x очистка текста   │
   │ Clean → Все процессоры              │
   └─────────────────────────────────────┘

3. ОПТИМИЗИРОВАННАЯ ДЕДУПЛИКАЦИЯ (-5% обработки)
   ┌─────────────────────────────────────┐
   │ Сейчас: O(n²) сравнение             │
   │ Сравнение каждого описания со всеми │
   └─────────────────────────────────────┘

   ┌─────────────────────────────────────┐
   │ Оптимизировано: O(n) на основе set  │
   │ Дедупликация на основе hash         │
   └─────────────────────────────────────┘

4. КЭШИРОВАНИЕ РЕЗУЛЬТАТОВ (Переменное улучшение)
   ┌─────────────────────────────────────┐
   │ Ключ кэша: text_hash + mode         │
   │ Hit: Возврат из кэша (мгновенно)    │
   │ Miss: Обработка и кэширование       │
   │ LRU вытеснение (max 100 записей)    │
   └─────────────────────────────────────┘

5. ПАКЕТНАЯ ОБРАБОТКА (+20% throughput)
   ┌─────────────────────────────────────┐
   │ Сейчас: 1 глава за раз              │
   │ Гл1 → Обработка → Гл2 → Обработка   │
   └─────────────────────────────────────┘

   ┌─────────────────────────────────────┐
   │ Оптимизировано: Пакет из 5 глав     │
   │ [Гл1,Гл2,Гл3,Гл4,Гл5] → Parallel    │
   │ Лучшая утилизация CPU/GPU           │
   └─────────────────────────────────────┘
```

---

## Сравнение структуры файлов

### До (Текущее)
```
backend/app/services/
├── multi_nlp_manager.py        (627 строк) ⚠️ God Object
├── nlp_processor.py            (567 строк) ⚠️ DEPRECATED
├── enhanced_nlp_system.py      (610 строк) ⚠️ SpaCy + Base
├── natasha_processor.py        (486 строк)
└── stanza_processor.py         (519 строк)
Всего: 2,809 строк

Проблемы:
• 40% дублирования кода
• Manager слишком сложный (627 строк)
• Legacy код (nlp_processor.py)
• Плохое разделение ответственности
```

### После (Целевое)
```
backend/app/services/nlp/
├── __init__.py
├── manager.py                  (<300 строк) ✅ Упрощено
├── processor_registry.py       (100 строк) ✅ Plugin система
├── config_loader.py            (150 строк) ✅ Управление конфигом
├── exceptions.py               (50 строк)  ✅ Custom исключения
├── logging_config.py           (80 строк)  ✅ Структурированное логирование
│
├── utils/
│   ├── text_cleaner.py         (40 строк)  ✅ Общий
│   ├── description_filter.py   (100 строк) ✅ Общий
│   ├── type_mapper.py          (60 строк)  ✅ Общий
│   ├── quality_scorer.py       (80 строк)  ✅ Общий
│   └── deduplicator.py         (60 строк)  ✅ Общий
│
├── strategies/
│   ├── base.py                 (50 строк)  ✅ Интерфейс
│   ├── single.py               (80 строк)  ✅ Стратегия
│   ├── parallel.py             (100 строк) ✅ Стратегия
│   ├── sequential.py           (90 строк)  ✅ Стратегия
│   ├── ensemble.py             (120 строк) ✅ Стратегия
│   └── adaptive.py             (130 строк) ✅ Стратегия
│
├── voting/
│   ├── ensemble_voter.py       (100 строк) ✅ Логика голосования
│   └── weighted_consensus.py   (80 строк)  ✅ Алгоритм
│
└── processors/
    ├── spacy_processor.py      (~400 строк) ✅ Без дублирования
    ├── natasha_processor.py    (~350 строк) ✅ Без дублирования
    └── stanza_processor.py     (~400 строк) ✅ Без дублирования

Всего: ~2,400 строк (сокращение на 14%)

Преимущества:
• <10% дублирования кода (улучшение на 75%)
• Четкое разделение ответственности
• Легко тестировать каждый компонент
• Легко расширять (plugins, strategies)
```

---

## Резюме

### Проблемы текущей архитектуры:
1. **God Object:** manager на 627 строк
2. **Дублирование кода:** 40% между процессорами
3. **Жесткий дизайн:** Сложно добавлять процессоры/режимы
4. **Плохая тестируемость:** Сложные зависимости

### Преимущества целевой архитектуры:
1. **Четкое разделение:** Каждый компонент имеет одну ответственность
2. **Без дублирования:** Общие утилиты (<10% дублирования)
3. **Расширяемость:** Plugin система для процессоров, Strategy pattern для режимов
4. **Тестируемость:** Изолированные компоненты, легко мокировать
5. **Производительность:** Оптимизированная инициализация и обработка

### Ожидаемые улучшения:
- **Качество кода:** 40% → <10% дублирования
- **Покрытие тестами:** ~5% → >80%
- **Инициализация:** 6-10s → 3-5s (на 50% быстрее)
- **Обработка:** 4s → 3.2-3.6s (на 10-20% быстрее)
- **Поддерживаемость:** Manager 627 → <300 строк (на 52% проще)

---

**Статус:** Готово к реализации
**Следующий шаг:** Рефакторинг Phase 1 (foundation + tests)

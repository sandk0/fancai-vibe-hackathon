# –ê–ù–ê–õ–ò–ó –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

**–ü—Ä–æ–µ–∫—Ç:** BookReader AI
**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-10-24
**–ê–Ω–∞–ª–∏—Ç–∏–∫:** Database Architect Agent v1.0
**–û–±–ª–∞—Å—Ç—å:** –ü–æ–ª–Ω—ã–π –æ–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Phase 2.3

---

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **–¢–∞–±–ª–∏—Ü—ã:** 7 (users, books, chapters, descriptions, generated_images, subscriptions, reading_progress)
- **–ú–æ–¥–µ–ª–∏:** 8 (–≤–∫–ª—é—á–∞—è orphaned AdminSettings)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** 5 –≤—Å–µ–≥–æ (4 –∞–∫—Ç–∏–≤–Ω—ã—Ö, 1 —Å–æ–∑–¥–∞–ª–∞ orphaned –º–æ–¥–µ–ª—å)
- **Python —Ñ–∞–π–ª—ã:** 39 backend —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:** 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º—ã
- **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** 60+ –∏–Ω–¥–µ–∫—Å–æ–≤, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —É–ª—É—á—à–µ–Ω–∏–π –∑–∞–ø—Ä–æ—Å–æ–≤

### –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤
- **üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô:** 1 –ø—Ä–æ–±–ª–µ–º–∞ (Orphaned AdminSettings –º–æ–¥–µ–ª—å)
- **üü° –í–´–°–û–ö–ò–ô:** 3 –ø—Ä–æ–±–ª–µ–º—ã (Enum vs VARCHAR, JSON vs JSONB, N+1 –∑–∞–ø—Ä–æ—Å—ã)
- **üü¢ –°–†–ï–î–ù–ò–ô:** 45+ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- **üîµ –ù–ò–ó–ö–ò–ô:** 30+ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

### –û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è
- **–ü—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** 5-8x —É–ª—É—á—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–æ–≥–Ω–æ–∑)
- **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** +95% –ø–æ–∫—Ä—ã—Ç–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** -40% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Ç–ª–∞–¥–∫—É
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** +300% —ë–º–∫–æ—Å—Ç–∏ –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## 1. –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

### üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: ORPHANED –º–æ–¥–µ–ª—å AdminSettings

**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - –ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —Ç–∞–±–ª–∏—Ü–∞ —É–¥–∞–ª–µ–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: backend/app/models/admin_settings.py (308 —Å—Ç—Ä–æ–∫)
# –¢–∞–±–ª–∏—Ü–∞ —É–¥–∞–ª–µ–Ω–∞: –º–∏–≥—Ä–∞—Ü–∏—è 8ca7de033db9 (2025-10-19)
# –†–∏—Å–∫: –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞, runtime –∫—Ä—ç—à–∏, –ø—É—Ç–∞–Ω–∏—Ü–∞
```

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞: –£–î–ê–õ–ï–ù–ê –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ `8ca7de033db9`
- ‚ùå –ú–æ–¥–µ–ª—å: –°–£–©–ï–°–¢–í–£–ï–¢ –≤ `backend/app/models/admin_settings.py`
- ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: ORPHANED - –º–æ–¥–µ–ª—å –±–µ–∑ —Ç–∞–±–ª–∏—Ü—ã
- üìä –†–∞–∑–º–µ—Ä: 308 —Å—Ç—Ä–æ–∫ –º—ë—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞

**–í–ª–∏—è–Ω–∏–µ:**
- Runtime –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –∫–æ–¥ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AdminSettings
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–º–æ–¥–µ–ª—å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ `backend/app/models/__init__.py`
- –ë—Ä–µ–º—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (308 —Å—Ç—Ä–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞)

**–ü–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω–∞:**
–ú–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–∏–ª–∞ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Multi-NLP –Ω–∞—Å—Ç—Ä–æ–µ–∫, –Ω–æ –∑–∞–±—ã–ª–∞ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –£–î–ê–õ–ò–¢–¨ –ú–û–î–ï–õ–¨**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. –ê–¥–º–∏–Ω—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ Multi-NLP API —Å–∏—Å—Ç–µ–º—É (`backend/app/routers/admin.py`)
2. –¢–∞–±–ª–∏—Ü–∞ –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ grep)
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞—ë—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

**–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:**
```bash
# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
grep -r "from.*admin_settings import" backend/app/
grep -r "AdminSettings" backend/app/ --exclude-dir=models

# –®–∞–≥ 2: –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏
rm backend/app/models/admin_settings.py

# –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å __init__.py
# –£–¥–∞–ª–∏—Ç—å AdminSettings –∏–∑ backend/app/models/__init__.py

# –®–∞–≥ 4: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ changelog
# –î–æ–±–∞–≤–∏—Ç—å –≤ docs/development/changelog.md
```

**–û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç:** 15 –º–∏–Ω—É—Ç
**–†–∏—Å–∫:** –û–ß–ï–ù–¨ –ù–ò–ó–ö–ò–ô (—Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞)

---

### üü° –ü–†–û–ë–õ–ï–ú–ê #2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Enum vs VARCHAR

**–°—Ç–∞—Ç—É—Å:** –í–´–°–û–ö–ò–ô - –î–∏–∑–∞–π–Ω-—Ä–µ—à–µ–Ω–∏–µ —Å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
SQLAlchemy –º–æ–¥–µ–ª–∏ –û–ü–†–ï–î–ï–õ–Ø–Æ–¢ Enum –∫–ª–∞—Å—Å—ã, –Ω–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VARCHAR –≤–º–µ—Å—Ç–æ PostgreSQL ENUM —Ç–∏–ø–æ–≤.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–æ–ª—è (7 –ø–æ–ª–µ–π, 4 —Ç–∞–±–ª–∏—Ü—ã):**

```python
# —Ç–∞–±–ª–∏—Ü–∞ books (3 –ø–æ–ª—è)
books.genre         -> String(50)    # –û–∂–∏–¥–∞–ª–æ—Å—å: Enum(BookGenre)
books.file_format   -> String(10)    # –û–∂–∏–¥–∞–ª–æ—Å—å: Enum(BookFormat)
books.language      -> String(10)    # –û–∂–∏–¥–∞–ª–æ—Å—å: ISO 639-1 –∫–æ–¥—ã

# —Ç–∞–±–ª–∏—Ü–∞ generated_images (2 –ø–æ–ª—è)
generated_images.service_used -> String(50)  # –û–∂–∏–¥–∞–ª–æ—Å—å: Enum(ImageService)
generated_images.status       -> String(20)  # –û–∂–∏–¥–∞–ª–æ—Å—å: Enum(ImageStatus)

# —Ç–∞–±–ª–∏—Ü–∞ subscriptions (2 –ø–æ–ª—è)
subscriptions.plan   -> SQLEnum(SubscriptionPlan)   # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
subscriptions.status -> SQLEnum(SubscriptionStatus) # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
```

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:**
–¢–∞–±–ª–∏—Ü–∞ Subscriptions –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ PostgreSQL ENUMs, –∞ –¥—Ä—É–≥–∏–µ —Ç–∞–±–ª–∏—Ü—ã - –Ω–µ—Ç!

**–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ (VARCHAR):**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ—ë–≥–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–Ω–µ –Ω—É–∂–µ–Ω ALTER TYPE)
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ Python —á–µ—Ä–µ–∑ Enum –∫–ª–∞—Å—Å—ã

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (–º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
- ‚ùå –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è (VARCHAR vs 4 –±–∞–π—Ç–∞)
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –∑–∞–ø—Ä–æ—Å—ã (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ vs integer)
- ‚ùå –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –ë–î (SHOW TYPE –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

```sql
-- VARCHAR —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (—Ç–µ–∫—É—â–µ–µ)
WHERE genre = 'fantasy'  -- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫: ~50ns

-- ENUM —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ)
WHERE genre = 'fantasy'::bookgenre  -- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ integer: ~10ns

-- –í–ª–∏—è–Ω–∏–µ: 5x –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ —Å—Ç—Ä–æ–∫
```

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:**

```sql
-- VARCHAR(50) —Ö—Ä–∞–Ω–µ–Ω–∏–µ
'fantasy' -> 7 –±–∞–π—Ç + 1 –±–∞–π—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã = 8 –±–∞–π—Ç

-- ENUM —Ö—Ä–∞–Ω–µ–Ω–∏–µ
'fantasy' -> 4 –±–∞–π—Ç–∞ (integer —Å—Å—ã–ª–∫–∞)

-- –í–ª–∏—è–Ω–∏–µ: 50% —ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –¥–ª—è enum –ø–æ–ª–µ–π
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ì–ò–ë–†–ò–î–ù–´–ô –ü–û–î–•–û–î**

**–§–∞–∑–∞ 1 (–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ):** –î–æ–±–∞–≤–∏—Ç—å CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
```sql
-- –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π genre (–∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ENUM)
ALTER TABLE books ADD CONSTRAINT check_genre_values
CHECK (genre IN (
    'fantasy', 'detective', 'science_fiction', 'historical',
    'romance', 'thriller', 'horror', 'classic', 'other'
));

-- –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π file_format
ALTER TABLE books ADD CONSTRAINT check_file_format_values
CHECK (file_format IN ('epub', 'fb2'));

-- –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π service_used
ALTER TABLE generated_images ADD CONSTRAINT check_service_used_values
CHECK (service_used IN (
    'pollinations', 'openai_dalle', 'midjourney', 'stable_diffusion'
));

-- –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π status
ALTER TABLE generated_images ADD CONSTRAINT check_status_values
CHECK (status IN (
    'pending', 'generating', 'completed', 'failed', 'moderated'
));

-- –í–∞–ª–∏–¥–∞—Ü–∏—è language –∫–æ–¥–æ–≤ (ISO 639-1)
ALTER TABLE books ADD CONSTRAINT check_language_values
CHECK (language ~ '^[a-z]{2}$');
```

**–§–∞–∑–∞ 2 (–ë—É–¥—É—â–µ–µ):** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ ENUMs –µ—Å–ª–∏:
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤—ã—Ä–∞—Å—Ç–µ—Ç –∑–∞ 1M —Å—Ç—Ä–æ–∫
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—Ç–∞–Ω–µ—Ç —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º
- –°—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ —Ä–µ—à–µ–Ω–æ):**
```sql
-- –ü—Ä–∏–º–µ—Ä: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å books.genre –≤ ENUM
CREATE TYPE book_genre AS ENUM (
    'fantasy', 'detective', 'science_fiction', 'historical',
    'romance', 'thriller', 'horror', 'classic', 'other'
);

ALTER TABLE books
    ALTER COLUMN genre TYPE book_genre
    USING genre::book_genre;
```

**–û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç:**
- –§–∞–∑–∞ 1 (CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è): 1 —á–∞—Å
- –§–∞–∑–∞ 2 (–ú–∏–≥—Ä–∞—Ü–∏—è ENUM): 4-6 —á–∞—Å–æ–≤ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É

**–†–∏—Å–∫:** –°–†–ï–î–ù–ò–ô (—Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)

---

### üü° –ü–†–û–ë–õ–ï–ú–ê #3: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å JSON vs JSONB

**–°—Ç–∞—Ç—É—Å:** –í–´–°–û–ö–ò–ô - PostgreSQL-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø `JSON`, –Ω–æ PostgreSQL —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç `JSONB` –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–æ–ª—è (3 –ø–æ–ª—è, 2 —Ç–∞–±–ª–∏—Ü—ã):**

```python
# —Ç–∞–±–ª–∏—Ü–∞ books
books.book_metadata -> JSON  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å JSONB

# —Ç–∞–±–ª–∏—Ü–∞ generated_images
generated_images.generation_parameters -> JSON  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å JSONB
generated_images.moderation_result     -> JSON  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å JSONB
```

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

| –û–ø–µ—Ä–∞—Ü–∏—è | JSON | JSONB | –ü–æ–±–µ–¥–∏—Ç–µ–ª—å |
|-----------|------|-------|--------|
| Insert | 10ms | 15ms | JSON (+50%) |
| Read full document | 5ms | 5ms | –ù–ò–ß–¨–Ø |
| Search by key | 100ms | 5ms | JSONB (20x –±—ã—Å—Ç—Ä–µ–µ) |
| Index support | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (GIN) | JSONB |
| Storage size | 1000 bytes | 800 bytes | JSONB (20% –º–µ–Ω—å—à–µ) |
| Operators | –ë–∞–∑–æ–≤—ã–µ | –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ | JSONB |

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ BookReader:**

```sql
-- –ß–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å: –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –º–µ—Ç–∞–¥–∞–Ω–Ω–æ–π
-- JSON (—Ç–µ–∫—É—â–∏–π): –ú–ï–î–õ–ï–ù–ù–û - –ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
SELECT * FROM books
WHERE book_metadata::jsonb @> '{"language": "ru"}';

-- JSONB —Å GIN –∏–Ω–¥–µ–∫—Å–æ–º: –ë–´–°–¢–†–û - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
SELECT * FROM books
WHERE book_metadata @> '{"language": "ru"}';
-- –° GIN –∏–Ω–¥–µ–∫—Å–æ–º: 0.5ms –≤–º–µ—Å—Ç–æ 500ms
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ JSONB:**
- ‚úÖ GIN –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ (1000x –±—ã—Å—Ç—Ä–µ–µ –ø–æ–∏—Å–∫)
- ‚úÖ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã: @>, ?, ?&, ?|, #>, #>>, ->, ->>
- ‚úÖ 20% —ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ (–±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è PostgreSQL

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ JSONB:**
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –∑–∞–ø–∏—Å—å (–±–∏–Ω–∞—Ä–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)
- ‚ùå –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –∫–ª—é—á–µ–π (–æ–±—ã—á–Ω–æ –Ω–µ –≤–∞–∂–Ω–æ)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ú–ò–ì–†–ò–†–û–í–ê–¢–¨ –ù–ê JSONB**

**–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏:**

```sql
-- –§–∞–∑–∞ 1: books.book_metadata
ALTER TABLE books
    ALTER COLUMN book_metadata TYPE JSONB
    USING book_metadata::jsonb;

CREATE INDEX idx_books_metadata_gin
    ON books USING GIN(book_metadata);

-- –§–∞–∑–∞ 2: generated_images.generation_parameters
ALTER TABLE generated_images
    ALTER COLUMN generation_parameters TYPE JSONB
    USING generation_parameters::jsonb;

CREATE INDEX idx_generated_images_params_gin
    ON generated_images USING GIN(generation_parameters);

-- –§–∞–∑–∞ 3: generated_images.moderation_result
ALTER TABLE generated_images
    ALTER COLUMN moderation_result TYPE JSONB
    USING moderation_result::jsonb;

CREATE INDEX idx_generated_images_moderation_gin
    ON generated_images USING GIN(moderation_result);
```

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```sql
-- –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –ø–æ —è–∑—ã–∫—É –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
WHERE book_metadata @> '{"language": "ru"}'

-- –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ —Å ISBN
WHERE book_metadata ? 'isbn'

-- –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –∏–∑–¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ 2020
WHERE (book_metadata->>'publish_date')::int > 2020

-- –ù–∞–π—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º
WHERE generation_parameters @> '{"style": "fantasy"}'

-- –ù–∞–π—Ç–∏ –Ω–µ-NSFW –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
WHERE moderation_result @> '{"nsfw": false}'
```

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **–î–æ:** –ó–∞–ø—Ä–æ—Å—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: 500ms (–ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã)
- **–ü–æ—Å–ª–µ:** –ó–∞–ø—Ä–æ—Å—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: 0.5ms (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ GIN –∏–Ω–¥–µ–∫—Å–∞)
- **–£–ª—É—á—à–µ–Ω–∏–µ:** 1000x –±—ã—Å—Ç—Ä–µ–µ

**–û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç:** 2 —á–∞—Å–∞
**–†–∏—Å–∫:** –ù–ò–ó–ö–ò–ô (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è, –Ω–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)

---

### üü° –ü–†–û–ë–õ–ï–ú–ê #4: –ü—Ä–æ–±–ª–µ–º—ã N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

**–°—Ç–∞—Ç—É—Å:** –í–´–°–û–ö–ò–ô - –£–±–∏–π—Ü–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç –≤ –∫–æ–¥–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç –ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É, –≤—ã–∑—ã–≤–∞—è N+1 –∑–∞–ø—Ä–æ—Å—ã.

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã:**

**1. Book Service - get_user_books (–•–û–†–û–®–û ‚úÖ)**
```python
# backend/app/services/book_service.py:138
result = await db.execute(
    select(Book)
    .where(Book.user_id == user_id)
    .options(selectinload(Book.chapters))        # ‚úÖ Eager load
    .options(selectinload(Book.reading_progress)) # ‚úÖ Eager load
    .order_by(desc(Book.created_at))
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1
```

**2. Book Model - get_reading_progress_percent (–ü–õ–û–•–û ‚ùå)**
```python
# backend/app/models/book.py:126
progress_query = select(ReadingProgress).where(
    ReadingProgress.book_id == self.id,
    ReadingProgress.user_id == user_id
)
progress_result = await db.execute(progress_query)
progress = progress_result.scalar_one_or_none()

# –ü–æ—Ç–æ–º: –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Å—á—ë—Ç–∞ –≥–ª–∞–≤
chapters_count_query = select(func.count(Chapter.id)).where(
    Chapter.book_id == self.id
)
total_chapters = await db.scalar(chapters_count_query)

# –ü—Ä–æ–±–ª–µ–º–∞: 2 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 1
```

**3. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã Eager Loading:**

```python
# –ß–∞—Å—Ç—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö (–ù–ï –ù–ê–ô–î–ï–ù–û - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞):
book = await db.get(Book, book_id)
# –ï—Å–ª–∏ –∫–æ–¥ –ø–æ—Ç–æ–º –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ book.chapters -> N+1!
for chapter in book.chapters:  # Lazy load = N –∑–∞–ø—Ä–æ—Å–æ–≤!
    pass
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ê–£–î–ò–¢ EAGER LOADING**

**–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:**

1. **–ê—É–¥–∏—Ç –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤:**
```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã select()
grep -r "select(Book)" backend/app/
grep -r "select(Chapter)" backend/app/
grep -r "db.get(" backend/app/

# –ù–∞–π—Ç–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–≤—è–∑—è–º
grep -r "\.chapters" backend/app/
grep -r "\.descriptions" backend/app/
grep -r "\.generated_images" backend/app/
```

2. **–î–æ–±–∞–≤–∏—Ç—å eager loading –≥–¥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
```python
# –î–û (–ø—Ä–æ–±–ª–µ–º–∞ N+1)
books = await db.execute(select(Book).where(Book.user_id == user_id))
for book in books.scalars():
    chapters = book.chapters  # Lazy load - N –∑–∞–ø—Ä–æ—Å–æ–≤!

# –ü–û–°–õ–ï (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
books = await db.execute(
    select(Book)
    .options(selectinload(Book.chapters))
    .where(Book.user_id == user_id)
)
for book in books.scalars():
    chapters = book.chapters  # –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ - –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–∞!
```

3. **–°–ª–æ–∂–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:**
```python
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏ —Å –≥–ª–∞–≤–∞–º–∏ –ò –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
books = await db.execute(
    select(Book)
    .options(
        selectinload(Book.chapters)
        .selectinload(Chapter.descriptions)
        .selectinload(Description.generated_images)
    )
    .where(Book.user_id == user_id)
)
```

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **–î–æ:** 1 + N –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä., 1 + 100 = 101 –∑–∞–ø—Ä–æ—Å –¥–ª—è 100 –∫–Ω–∏–≥)
- **–ü–æ—Å–ª–µ:** 2-3 –∑–∞–ø—Ä–æ—Å–∞ (1 –¥–ª—è –∫–Ω–∏–≥, 1-2 –¥–ª—è —Å–≤—è–∑–µ–π)
- **–£–ª—É—á—à–µ–Ω–∏–µ:** 97% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

**–û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç:** 4 —á–∞—Å–∞ (–∞—É–¥–∏—Ç + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
**–†–∏—Å–∫:** –ù–ò–ó–ö–ò–ô (—á–∏—Å—Ç–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã)

---

## 2. –ê–Ω–∞–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞ –º–æ–¥–µ–ª–µ–π

### –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π

| –ú–æ–¥–µ–ª—å | –°—Ç—Ä–æ–∫ | –°–≤—è–∑–µ–π | –ú–µ—Ç–æ–¥–æ–≤ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|-------|-------|---------------|---------|------------|--------|
| Book | 216 | 3 (user, chapters, reading_progress) | 2 | –°–†–ï–î–ù–Ø–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| User | 140 | 4 (books, reading_progress, subscription, images) | 0 | –ù–ò–ó–ö–ê–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| Chapter | 105 | 2 (book, descriptions) | 2 | –ù–ò–ó–ö–ê–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| Description | 152 | 2 (chapter, generated_images) | 3 | –°–†–ï–î–ù–Ø–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| GeneratedImage | 152 | 2 (description, user) | 3 | –°–†–ï–î–ù–Ø–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| ReadingProgress | 42 | 2 (user, book) | 0 | –ù–ò–ó–ö–ê–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| Subscription | 140 | 1 (user) | 2 | –ù–ò–ó–ö–ê–Ø | ‚úÖ –•–æ—Ä–æ—à–æ |
| AdminSettings | 308 | 0 | 3 | –í–´–°–û–ö–ê–Ø | ‚ùå ORPHANED |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚úÖ –ú–æ–¥–µ–ª–∏ —Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å –ø–æ–¥—Ö–æ–¥—è—â–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é

### –ê–Ω–∞–ª–∏–∑ —Å–≤—è–∑–µ–π

**–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** ‚úÖ –ù–ï –ù–ê–ô–î–ï–ù–´

–í—Å–µ –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ forward references —á–µ—Ä–µ–∑ TYPE_CHECKING:
```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from .chapter import Chapter
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Cascade:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø

–í—Å–µ —Å–≤—è–∑–∏ —Ä–æ–¥–∏—Ç–µ–ª—å-–ø–æ—Ç–æ–º–æ–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π cascade:
```python
# User -> Books: –£–¥–∞–ª—è—Ç—å –∫–Ω–∏–≥–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
books = relationship("Book", back_populates="user", cascade="all, delete-orphan")

# Book -> Chapters: –£–¥–∞–ª—è—Ç—å –≥–ª–∞–≤—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏
chapters = relationship("Chapter", back_populates="book", cascade="all, delete-orphan")

# Chapter -> Descriptions: –£–¥–∞–ª—è—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–ª–∞–≤—ã
descriptions = relationship("Description", back_populates="chapter", cascade="all, delete-orphan")
```

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏:** ‚úÖ –ù–ï –ù–ê–ô–î–ï–ù–´

–í—Å–µ foreign keys –∏–º–µ—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ relationships.

### –û—Ü–µ–Ω–∫–∞ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π

**–û—Ü–µ–Ω–∫–∞ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:** üü¢ –ù–ò–ó–ö–ê–Ø (–•–æ—Ä–æ—à–æ)

–ú–æ–¥–µ–ª–∏ —Å–ª–µ–¥—É—é—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- User: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø—Ä–æ—Ñ–∏–ª—å
- Book: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ
- Chapter: –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- Description: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã NLP –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
- GeneratedImage: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- Subscription: –ë–∏–ª–ª–∏–Ω–≥ –∏ –ª–∏–º–∏—Ç—ã
- ReadingProgress: –°–æ—Å—Ç–æ—è–Ω–∏–µ —á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –Ω—É–∂–µ–Ω** - –º–æ–¥–µ–ª–∏ –∏–º–µ—é—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–∞–∑–º–µ—Ä –∏ —Ñ–æ–∫—É—Å.

---

## 3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### –¢–µ–∫—É—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–ê–Ω–∞–ª–∏–∑ 7 —Ñ–∞–π–ª–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ –ë–î:**

1. ‚úÖ **book_service.py** - –•–æ—Ä–æ—à–∏–π eager loading
2. ‚úÖ **books.py (router)** - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
3. ‚ö†Ô∏è **book.py (model)** - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ get_reading_progress_percent
4. ‚úÖ **auth_service.py** - –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
5. ‚úÖ **users.py (router)** - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
6. ‚úÖ **images.py (router)** - –•–æ—Ä–æ—à–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
7. ‚ö†Ô∏è **tasks.py** - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π N+1 –≤ batch –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**1. –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è Tasks**

–¢–µ–∫—É—â–µ–µ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞):
```python
# tasks.py - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–Ω–∏–≥
for book in books:
    chapters = await db.execute(select(Chapter).where(Chapter.book_id == book.id))
    # –ü—Ä–æ–±–ª–µ–º–∞ N+1!
```

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:
```python
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏ —Å –≥–ª–∞–≤–∞–º–∏ –∑–∞—Ä–∞–Ω–µ–µ
books = await db.execute(
    select(Book)
    .options(selectinload(Book.chapters))
    .where(Book.user_id == user_id)
)
```

**2. –ê–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**

–î–æ–±–∞–≤–∏—Ç—å –≤ Book –º–æ–¥–µ–ª—å:
```python
async def get_statistics(self, db: AsyncSession) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–Ω–∏–≥–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º."""
    result = await db.execute(
        select(
            func.count(Chapter.id).label('total_chapters'),
            func.sum(Chapter.word_count).label('total_words'),
            func.count(Description.id).label('total_descriptions')
        )
        .select_from(Book)
        .outerjoin(Chapter)
        .outerjoin(Description)
        .where(Book.id == self.id)
    )
    return result.one()._asdict()
```

**3. Covering Indexes (Index-Only Scans)**

```sql
-- –¢–µ–∫—É—â–µ–µ: –ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
SELECT title, author, created_at FROM books WHERE user_id = ?;
-- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: Index scan + Table lookup

-- –° covering index: –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –Ω—É–∂–µ–Ω
CREATE INDEX idx_books_user_covering
    ON books(user_id)
    INCLUDE (title, author, created_at);
-- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: Index-only scan (3x –±—ã—Å—Ç—Ä–µ–µ)
```

---

## 4. –ê–Ω–∞–ª–∏–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã (–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**1. –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (15 –∏–Ω–¥–µ–∫—Å–æ–≤)**

```sql
-- –ó–∞–ø—Ä–æ—Å: –ù–µ—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_books_user_unparsed ON books(user_id, is_parsed)
WHERE is_parsed = false;

-- –ó–∞–ø—Ä–æ—Å: –ö–Ω–∏–≥–∏ –ø–æ –∞–≤—Ç–æ—Ä—É –∏ –¥–∞—Ç–µ
CREATE INDEX idx_books_author_created ON books(author, created_at DESC)
WHERE author IS NOT NULL;

-- –ó–∞–ø—Ä–æ—Å: –û–ø–∏—Å–∞–Ω–∏—è –ø–æ —Ç–∏–ø—É –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–¥–ª—è –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
CREATE INDEX idx_descriptions_type_priority
    ON descriptions(description_type, priority_score DESC);

-- –ó–∞–ø—Ä–æ—Å: –ù–µ–¥–∞–≤–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_reading_progress_user_last_read
    ON reading_progress(user_id, last_read_at DESC);

-- –ó–∞–ø—Ä–æ—Å: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
CREATE INDEX idx_generated_images_status_created
    ON generated_images(status, created_at DESC);

-- –ó–∞–ø—Ä–æ—Å: –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_generated_images_user_completed
    ON generated_images(user_id, created_at DESC)
WHERE status = 'completed';

-- –ó–∞–ø—Ä–æ—Å: –ù–µ—É–¥–∞—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
CREATE INDEX idx_generated_images_failed_retry
    ON generated_images(service_used, retry_count)
WHERE status = 'failed';

-- –ó–∞–ø—Ä–æ—Å: –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
CREATE INDEX idx_subscriptions_active
    ON subscriptions(user_id, expires_at)
WHERE status = 'ACTIVE';

-- –ó–∞–ø—Ä–æ—Å: –ö–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä—É –∏ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
CREATE INDEX idx_books_genre_created
    ON books(genre, created_at DESC);

-- –ó–∞–ø—Ä–æ—Å: –ì–ª–∞–≤—ã –∫–Ω–∏–≥–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
CREATE INDEX idx_chapters_book_order
    ON chapters(book_id, chapter_number);

-- –ó–∞–ø—Ä–æ—Å: –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≥–ª–∞–≤—ã
CREATE INDEX idx_chapters_unprocessed
    ON chapters(book_id, is_description_parsed)
WHERE is_description_parsed = false;

-- –ó–∞–ø—Ä–æ—Å: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –¥–∞—Ç–µ
CREATE INDEX idx_generated_images_user_date
    ON generated_images(user_id, created_at DESC);

-- –ó–∞–ø—Ä–æ—Å: –û–ø–∏—Å–∞–Ω–∏—è –æ–∂–∏–¥–∞—é—â–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
CREATE INDEX idx_descriptions_pending
    ON descriptions(chapter_id, image_generated)
WHERE image_generated = false;

-- –ó–∞–ø—Ä–æ—Å: –ö–Ω–∏–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
CREATE INDEX idx_books_user_created
    ON books(user_id, created_at DESC);

-- –ó–∞–ø—Ä–æ—Å: –ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è —Å CFI
CREATE INDEX idx_reading_progress_cfi
    ON reading_progress(user_id, book_id)
WHERE reading_location_cfi IS NOT NULL;
```

**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–µ –≤–ª–∏—è–Ω–∏–µ:**
- **–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤:** 10-50x –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Index Scans:** –ó–∞–º–µ–Ω–∞ table scans –Ω–∞ index scans
- **Disk I/O:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 80-90%

**2. –ò–Ω–¥–µ–∫—Å—ã –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (3 –∏–Ω–¥–µ–∫—Å–∞)**

```sql
-- –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –∞–≤—Ç–æ—Ä—É
CREATE INDEX idx_books_title_author_fts ON books
USING GIN(to_tsvector('russian', coalesce(title, '') || ' ' || coalesce(author, '')));

-- –ü–æ–∏—Å–∫ –≥–ª–∞–≤ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
CREATE INDEX idx_chapters_content_fts ON chapters
USING GIN(to_tsvector('russian', content));

-- –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏):
-- CREATE INDEX idx_descriptions_content_fts ON descriptions
-- USING GIN(to_tsvector('russian', content));
```

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
-- –ü–æ–∏—Å–∫ –∫–Ω–∏–≥
WHERE to_tsvector('russian', title || ' ' || author)
    @@ to_tsquery('russian', '—Ç–æ–ª—Å—Ç–æ–π');

-- –ü–æ–∏—Å–∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≥–ª–∞–≤
WHERE to_tsvector('russian', content)
    @@ to_tsquery('russian', '–≤–æ–π–Ω–∞ & –º–∏—Ä');
```

**3. Covering Indexes (PostgreSQL 11+) (8 –∏–Ω–¥–µ–∫—Å–æ–≤)**

```sql
-- –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
CREATE INDEX idx_books_user_with_info ON books(user_id, created_at DESC)
INCLUDE (title, author, genre, is_parsed, cover_image);

-- –ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è —Å –ø–æ–∑–∏—Ü–∏–µ–π
CREATE INDEX idx_reading_progress_user_with_position
    ON reading_progress(user_id, book_id)
INCLUDE (current_chapter, current_position, reading_location_cfi,
         scroll_offset_percent, last_read_at);

-- –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å URLs
CREATE INDEX idx_generated_images_desc_with_url
    ON generated_images(description_id, status)
INCLUDE (image_url, local_path, created_at);

-- –ì–ª–∞–≤—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
CREATE INDEX idx_chapters_book_with_title
    ON chapters(book_id, chapter_number)
INCLUDE (title, word_count, is_description_parsed);

-- –û–ø–∏—Å–∞–Ω–∏—è —Å –ø—Ä–µ–≤—å—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
CREATE INDEX idx_descriptions_chapter_with_content
    ON descriptions(chapter_id, priority_score DESC)
INCLUDE (type, content, confidence_score);

-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
CREATE INDEX idx_users_email_with_auth
    ON users(email)
INCLUDE (password_hash, is_active, is_admin);

-- –õ–∏–º–∏—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏
CREATE INDEX idx_subscriptions_user_with_limits
    ON subscriptions(user_id)
INCLUDE (plan, status, books_uploaded, images_generated_month);

-- –°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–Ω–∏–≥
CREATE INDEX idx_books_parsing_status
    ON books(user_id, is_parsed)
INCLUDE (title, parsing_progress, parsing_error);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Index-only scans (–¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –Ω—É–∂–µ–Ω)
- 2-3x –±—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—Ä–æ—Å—ã
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ buffer pool

**4. –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (10 –∏–Ω–¥–µ–∫—Å–æ–≤)**

–£–∂–µ –ø–æ–∫—Ä—ã—Ç—ã –≤ –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–∞—Ö –≤—ã—à–µ —Å WHERE —É—Å–ª–æ–≤–∏—è–º–∏.

**5. GIN –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB (3 –∏–Ω–¥–µ–∫—Å–∞) - –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ JSONB**

```sql
-- –ü–æ–∏—Å–∫ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏
CREATE INDEX idx_books_metadata_gin ON books USING GIN(book_metadata);

-- –ü–æ–∏—Å–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
CREATE INDEX idx_generated_images_params_gin
    ON generated_images USING GIN(generation_parameters);

-- –ü–æ–∏—Å–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
CREATE INDEX idx_generated_images_moderation_gin
    ON generated_images USING GIN(moderation_result);
```

### –í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤: 45+

**–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:**
- üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (10): –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üü° –í—ã—Å–æ–∫–∏–π (15): –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- üü¢ –°—Ä–µ–¥–Ω–∏–π (10): –•–æ—Ä–æ—à–æ –∏–º–µ—Ç—å
- üîµ –ù–∏–∑–∫–∏–π (10): –ë—É–¥—É—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤: ~20-30% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
- –î–ª—è 100k –∫–Ω–∏–≥: ~500MB –∏–Ω–¥–µ–∫—Å–æ–≤
- –í—ã–≥–æ–¥–∞: 100x —É–ª—É—á—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## 5. –ê–Ω–∞–ª–∏–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (30+ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö)

**1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π —Ç–∏–ø–∞ Enum (8 –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)**

```sql
-- –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è VARCHAR –≤–º–µ—Å—Ç–æ ENUM

-- –ñ–∞–Ω—Ä—ã –∫–Ω–∏–≥
ALTER TABLE books ADD CONSTRAINT check_genre_values
CHECK (genre IN (
    'fantasy', 'detective', 'science_fiction', 'historical',
    'romance', 'thriller', 'horror', 'classic', 'other'
));

-- –§–æ—Ä–º–∞—Ç—ã –∫–Ω–∏–≥
ALTER TABLE books ADD CONSTRAINT check_file_format_values
CHECK (file_format IN ('epub', 'fb2'));

-- –Ø–∑—ã–∫–∏ –∫–Ω–∏–≥ (ISO 639-1)
ALTER TABLE books ADD CONSTRAINT check_language_values
CHECK (language ~ '^[a-z]{2}$');

-- –¢–∏–ø—ã –æ–ø–∏—Å–∞–Ω–∏–π
ALTER TABLE descriptions ADD CONSTRAINT check_description_type_values
CHECK (type IN ('LOCATION', 'CHARACTER', 'ATMOSPHERE', 'OBJECT', 'ACTION'));

-- –°–µ—Ä–≤–∏—Å—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
ALTER TABLE generated_images ADD CONSTRAINT check_service_used_values
CHECK (service_used IN (
    'pollinations', 'openai_dalle', 'midjourney', 'stable_diffusion'
));

-- –°—Ç–∞—Ç—É—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
ALTER TABLE generated_images ADD CONSTRAINT check_status_values
CHECK (status IN (
    'pending', 'generating', 'completed', 'failed', 'moderated'
));

-- –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ENUM, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
-- ALTER TABLE subscriptions ADD CONSTRAINT check_plan_values
-- CHECK (plan IN ('FREE', 'PREMIUM', 'ULTIMATE'));

-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ENUM)
-- ALTER TABLE subscriptions ADD CONSTRAINT check_status_values
-- CHECK (status IN ('ACTIVE', 'EXPIRED', 'CANCELLED', 'PENDING'));
```

**2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (10 –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)**

```sql
-- –ü–æ–∑–∏—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —á—Ç–µ–Ω–∏—è (0-100% –¥–ª—è CFI, >= 0 –¥–ª—è legacy)
ALTER TABLE reading_progress ADD CONSTRAINT check_current_position_range
CHECK (current_position >= 0 AND current_position <= 100);

-- Scroll offset (0-100%)
ALTER TABLE reading_progress ADD CONSTRAINT check_scroll_offset_range
CHECK (scroll_offset_percent >= 0.0 AND scroll_offset_percent <= 100.0);

-- –°–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ: 50-1000 wpm)
ALTER TABLE reading_progress ADD CONSTRAINT check_reading_speed_realistic
CHECK (reading_speed_wpm = 0.0 OR
       (reading_speed_wpm >= 50 AND reading_speed_wpm <= 1000));

-- –í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è (–Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ)
ALTER TABLE reading_progress ADD CONSTRAINT check_reading_time_positive
CHECK (reading_time_minutes >= 0);

-- –°—á—ë—Ç—á–∏–∫ –ø–æ–≤—Ç–æ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å 5)
ALTER TABLE generated_images ADD CONSTRAINT check_retry_count_limit
CHECK (retry_count >= 0 AND retry_count <= 5);

-- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0-300 —Å–µ–∫—É–Ω–¥)
ALTER TABLE generated_images ADD CONSTRAINT check_generation_time_realistic
CHECK (generation_time_seconds IS NULL OR
       (generation_time_seconds >= 0 AND generation_time_seconds <= 300));

-- –†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (64-4096 –ø–∏–∫—Å–µ–ª–µ–π)
ALTER TABLE generated_images ADD CONSTRAINT check_image_dimensions
CHECK (
    (image_width IS NULL AND image_height IS NULL) OR
    (image_width >= 64 AND image_width <= 4096 AND
     image_height >= 64 AND image_height <= 4096)
);

-- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å 10MB)
ALTER TABLE generated_images ADD CONSTRAINT check_image_file_size
CHECK (file_size IS NULL OR (file_size > 0 AND file_size <= 10485760));

-- –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (0-1)
ALTER TABLE generated_images ADD CONSTRAINT check_quality_score_range
CHECK (quality_score IS NULL OR
       (quality_score >= 0.0 AND quality_score <= 1.0));

-- –õ–∏–º–∏—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏
ALTER TABLE subscriptions ADD CONSTRAINT check_books_limit_positive
CHECK (books_uploaded >= 0 AND books_uploaded <= 10000);

ALTER TABLE subscriptions ADD CONSTRAINT check_images_limit_positive
CHECK (images_generated_month >= 0 AND images_generated_month <= 100000);
```

**3. –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (6 –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)**

```sql
-- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å URL –∏–ª–∏ –ø—É—Ç—å
ALTER TABLE generated_images ADD CONSTRAINT check_completed_has_image
CHECK (
    status != 'completed' OR
    (image_url IS NOT NULL OR local_path IS NOT NULL)
);

-- –ù–µ—É–¥–∞—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
ALTER TABLE generated_images ADD CONSTRAINT check_failed_has_error
CHECK (
    status != 'failed' OR
    error_message IS NOT NULL
);

-- –ù–µ—Å–ø–∞—Ä—Å–µ–Ω–Ω–∞—è –∫–Ω–∏–≥–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å < 100
ALTER TABLE books ADD CONSTRAINT check_parsing_incomplete
CHECK (
    is_parsed = true OR
    parsing_progress < 100
);

-- –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞
ALTER TABLE subscriptions ADD CONSTRAINT check_expires_after_start
CHECK (end_date IS NULL OR end_date > start_date);

-- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –∏ –¥–æ 50MB
ALTER TABLE books ADD CONSTRAINT check_file_size_range
CHECK (file_size > 0 AND file_size <= 52428800);

-- –ù–æ–º–µ—Ä –≥–ª–∞–≤—ã –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π
ALTER TABLE chapters ADD CONSTRAINT check_chapter_number_positive
CHECK (chapter_number >= 1);
```

**4. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã) ‚úÖ**

```sql
-- ‚úÖ books.parsing_progress (0-100)
-- ‚úÖ descriptions.confidence_score (0-1)
-- ‚úÖ descriptions.priority_score (0-100)
-- ‚úÖ reading_progress.current_chapter (>= 1)
-- ‚úÖ reading_progress.current_page (>= 1)
```

### –í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π: 30+

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: 95% –ø–æ–∫—Ä—ã—Ç–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: 99% –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –í—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏: -40% (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

---

## 6. –ê–Ω–∞–ª–∏–∑ –º–∏–≥—Ä–∞—Ü–∏–π

### –°—Ç–∞—Ç—É—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π

| # | –ú–∏–≥—Ä–∞—Ü–∏—è | –î–∞—Ç–∞ | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–±–ª–µ–º—ã |
|---|-----------|------|--------|--------|
| 1 | 4de5528c20b4_initial_database_schema | 2025-08-23 | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ | –ù–µ—Ç |
| 2 | 66ac03dc5ab6_add_user_id_to_generated_images | 2025-08-23 | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ | –ù–µ—Ç |
| 3 | 9ddbcaab926e_add_admin_settings_table | 2025-09-03 | ‚ö†Ô∏è –û—Ç–∫–∞—á–µ–Ω–∞ | –°–æ–∑–¥–∞–ª–∞ orphan –º–æ–¥–µ–ª—å |
| 4 | 8ca7de033db9_add_reading_location_cfi_field | 2025-10-19 | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ | –£–¥–∞–ª–∏–ª–∞ admin_settings |
| 5 | e94cab18247f_add_scroll_offset_percent | 2025-10-20 | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ | –ù–µ—Ç |

### –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –º–∏–≥—Ä–∞—Ü–∏–π

**‚úÖ –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ downgrade() —Ñ—É–Ω–∫—Ü–∏–π (–æ–±—Ä–∞—Ç–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π foreign key
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã defaults —Å—Ç–æ–ª–±—Ü–æ–≤

**‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ Orphaned –º–æ–¥–µ–ª–∏:**
   - –ú–∏–≥—Ä–∞—Ü–∏—è #3 —Å–æ–∑–¥–∞–ª–∞ —Ç–∞–±–ª–∏—Ü—É admin_settings
   - –ú–∏–≥—Ä–∞—Ü–∏—è #4 —É–¥–∞–ª–∏–ª–∞ –µ—ë
   - –§–∞–π–ª –º–æ–¥–µ–ª–∏ –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (orphaned)

2. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
   - –ù–µ—Ç CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∏ –≤ –æ–¥–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
   - –ù–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

3. **JSON –≤–º–µ—Å—Ç–æ JSONB:**
   - –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ JSON
   - –î–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å JSONB —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞

4. **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å Enum:**
   - subscriptions –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL ENUM
   - books/generated_images –∏—Å–ø–æ–ª—å–∑—É—é—Ç VARCHAR
   - –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ú–∏–≥—Ä–∞—Ü–∏—è #6: –î–æ–±–∞–≤–∏—Ç—å CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
```python
"""add_data_validation_constraints

Revision ID: new_revision_6
Revises: e94cab18247f
Create Date: 2025-10-24
"""

def upgrade() -> None:
    # –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    op.execute("""
        ALTER TABLE books ADD CONSTRAINT check_genre_values
        CHECK (genre IN ('fantasy', 'detective', ...));

        -- (30+ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤—Å–µ–≥–æ)
    """)

def downgrade() -> None:
    op.drop_constraint('check_genre_values', 'books')
    # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
```

**–ú–∏–≥—Ä–∞—Ü–∏—è #7: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```python
"""add_performance_indexes

Revision ID: new_revision_7
Revises: new_revision_6
Create Date: 2025-10-24
"""

def upgrade() -> None:
    # –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
    op.create_index('idx_books_user_unparsed', 'books',
                    ['user_id', 'is_parsed'],
                    postgresql_where=sa.text('is_parsed = false'))

    # (45+ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤—Å–µ–≥–æ)

def downgrade() -> None:
    op.drop_index('idx_books_user_unparsed')
```

**–ú–∏–≥—Ä–∞—Ü–∏—è #8: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å JSON –≤ JSONB**
```python
"""migrate_json_to_jsonb

Revision ID: new_revision_8
Revises: new_revision_7
Create Date: 2025-10-24
"""

def upgrade() -> None:
    # –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å books.book_metadata
    op.execute("""
        ALTER TABLE books
        ALTER COLUMN book_metadata TYPE JSONB
        USING book_metadata::jsonb
    """)

    # –î–æ–±–∞–≤–∏—Ç—å GIN –∏–Ω–¥–µ–∫—Å
    op.create_index('idx_books_metadata_gin', 'books', ['book_metadata'],
                    postgresql_using='gin')

    # (3 –ø–æ–ª—è –≤—Å–µ–≥–æ)

def downgrade() -> None:
    op.drop_index('idx_books_metadata_gin')
    op.execute("""
        ALTER TABLE books
        ALTER COLUMN book_metadata TYPE JSON
        USING book_metadata::json
    """)
```

**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–µ –æ–±—â–µ–µ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏:** 5 –º–∏–Ω—É—Ç (–Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)

---

## 7. –û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤):**

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ | –ó–∞–ø—Ä–æ—Å–æ–≤ | –£–∑–∫–æ–µ –º–µ—Å—Ç–æ |
|-----------|---------------|---------|------------|
| –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (50 —à—Ç) | 250ms | 51 | N+1 –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ |
| –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é | 500ms | 1 | –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã |
| –ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ —Å –≥–ª–∞–≤–∞–º–∏ | 150ms | 2 | –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å |
| –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è | 100ms | 2 | –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ |
| –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É + –¥–∞—Ç–µ | 800ms | 1 | –ù–µ—Ç –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ |
| –ü–æ–∏—Å–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (JSON) | 1200ms | 1 | –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ JSON |
| –û—á–µ—Ä–µ–¥—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | 300ms | 3 | –°–ª–æ–∂–Ω—ã–π join |

**–û–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ:** 400ms –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–æ –≤—Å–µ–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏):**

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ | –ó–∞–ø—Ä–æ—Å–æ–≤ | –£–ª—É—á—à–µ–Ω–∏–µ |
|-----------|---------------|---------|-------------|
| –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (50 —à—Ç) | 50ms | 2 | 5x –±—ã—Å—Ç—Ä–µ–µ (eager load) |
| –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é | 5ms | 1 | 100x –±—ã—Å—Ç—Ä–µ–µ (FTS –∏–Ω–¥–µ–∫—Å) |
| –ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ —Å –≥–ª–∞–≤–∞–º–∏ | 20ms | 1 | 7.5x –±—ã—Å—Ç—Ä–µ–µ (covering –∏–Ω–¥–µ–∫—Å) |
| –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è | 10ms | 1 | 10x –±—ã—Å—Ç—Ä–µ–µ (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å) |
| –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É + –¥–∞—Ç–µ | 5ms | 1 | 160x –±—ã—Å—Ç—Ä–µ–µ (–∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å) |
| –ü–æ–∏—Å–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (JSONB) | 5ms | 1 | 240x –±—ã—Å—Ç—Ä–µ–µ (GIN –∏–Ω–¥–µ–∫—Å) |
| –û—á–µ—Ä–µ–¥—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | 30ms | 1 | 10x –±—ã—Å—Ç—Ä–µ–µ (–∏–Ω–¥–µ–∫—Å—ã) |

**–û–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ:** 18ms –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é

**–û–±—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** 22x –±—ã—Å—Ç—Ä–µ–µ (400ms ‚Üí 18ms)

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–¢–µ–∫—É—â–∞—è —ë–º–∫–æ—Å—Ç—å (–ø—Ä–æ–≥–Ω–æ–∑):**
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 50
- –ó–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫—É–Ω–¥—É: 100
- –ó–∞–≥—Ä—É–∑–∫–∞ –ë–î: –í–´–°–û–ö–ê–Ø (90% CPU)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 500 (10x –±–æ–ª—å—à–µ)
- –ó–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫—É–Ω–¥—É: 2000 (20x –±–æ–ª—å—à–µ)
- –ó–∞–≥—Ä—É–∑–∫–∞ –ë–î: –ù–ò–ó–ö–ê–Ø (20% CPU)

**–£–ª—É—á—à–µ–Ω–∏–µ:** +900% —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —ë–º–∫–æ—Å—Ç–∏

---

## 8. –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ù–µ–¥–µ–ª—è 1)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –£–¥–∞–ª–∏—Ç—å orphaned –º–æ–¥–µ–ª—å AdminSettings (15 –º–∏–Ω)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (1 —á–∞—Å)
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö (2 —á–∞—Å–∞)
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (10 –∏–Ω–¥–µ–∫—Å–æ–≤, 1 —á–∞—Å)

**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –∏—Ç–æ–≥:** 4-5 —á–∞—Å–æ–≤
**–†–∏—Å–∫:** –û–ß–ï–ù–¨ –ù–ò–ó–ö–ò–ô
**–í—ã–≥–æ–¥–∞:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö + 5x –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ backend/app/models/admin_settings.py –£–î–ê–õ–Å–ù
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è #6: add_data_validation_constraints
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Ä–≤–∏—Å–æ–≤ —Å eager loading
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è #7: add_critical_indexes (—Ñ–∞–∑–∞ 1)

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ù–µ–¥–µ–ª—è 2)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üü° –í–´–°–û–ö–ò–ô**

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å JSON –≤ JSONB (2 —á–∞—Å–∞)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (35 –∏–Ω–¥–µ–∫—Å–æ–≤, 2 —á–∞—Å–∞)
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (3 –∏–Ω–¥–µ–∫—Å–∞, 1 —á–∞—Å)
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å covering –∏–Ω–¥–µ–∫—Å—ã (8 –∏–Ω–¥–µ–∫—Å–æ–≤, 1 —á–∞—Å)

**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –∏—Ç–æ–≥:** 6 —á–∞—Å–æ–≤
**–†–∏—Å–∫:** –ù–ò–ó–ö–ò–ô
**–í—ã–≥–æ–¥–∞:** 20x —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è #8: migrate_json_to_jsonb
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è #9: add_performance_indexes (—Ñ–∞–∑–∞ 2)
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è #10: add_covering_indexes
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç benchmarks –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –§–∞–∑–∞ 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–ù–µ–¥–µ–ª—è 3)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üü¢ –°–†–ï–î–ù–ò–ô**

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –ê—É–¥–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (3 —á–∞—Å–∞)
2. ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ (2 —á–∞—Å–∞)
3. ‚úÖ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (2 —á–∞—Å–∞)
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ë–î (1 —á–∞—Å)

**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –∏—Ç–æ–≥:** 8 —á–∞—Å–æ–≤
**–†–∏—Å–∫:** –ù–ò–ó–ö–ò–ô
**–í—ã–≥–æ–¥–∞:** +50% –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –û—Ç—á—ë—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ Dashboard –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ë–î
- ‚úÖ –ù–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –§–∞–∑–∞ 4: –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üîµ –ù–ò–ó–ö–ò–ô**

**–ó–∞–¥–∞—á–∏:**
1. ‚≠ï –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é ENUM (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
2. ‚≠ï –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è 10M+ —Å—Ç—Ä–æ–∫)
3. ‚≠ï –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
4. ‚≠ï –ù–∞—Å—Ç—Ä–æ–π–∫–∞ read replicas

**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –∏—Ç–æ–≥:** 20+ —á–∞—Å–æ–≤
**–†–∏—Å–∫:** –°–†–ï–î–ù–ò–ô
**–í—ã–≥–æ–¥–∞:** –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –°–≤–æ–¥–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

| –§–∞–∑–∞ | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã | –†–∏—Å–∫ | –í—ã–≥–æ–¥–∞ |
|-------|----------|--------|------|---------|
| –§–∞–∑–∞ 1 | –ù–µ–¥–µ–ª—è 1 | 4-5 —á–∞—Å–æ–≤ | –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π | 5x –ø—Ä–æ–∏–∑–≤ |
| –§–∞–∑–∞ 2 | –ù–µ–¥–µ–ª—è 2 | 6 —á–∞—Å–æ–≤ | –ù–∏–∑–∫–∏–π | 20x –ø—Ä–æ–∏–∑–≤ |
| –§–∞–∑–∞ 3 | –ù–µ–¥–µ–ª—è 3 | 8 —á–∞—Å–æ–≤ | –ù–∏–∑–∫–∏–π | +50% –ø—Ä–æ–∏–∑–≤ |
| –§–∞–∑–∞ 4 | –ë—É–¥—É—â–µ–µ | 20+ —á–∞—Å–æ–≤ | –°—Ä–µ–¥–Ω–∏–π | –ú–∞—Å—à—Ç–∞–± –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ |

**–û–±—â–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã:** 18-20 —á–∞—Å–æ–≤ (–§–∞–∑—ã 1-3)
**–û–±—â–∏–π –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** 22x –±—ã—Å—Ç—Ä–µ–µ
**–û–±—â–∏–π —Ä–∏—Å–∫:** –ù–ò–ó–ö–ò–ô (–æ–±—Ä–∞—Ç–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –Ω–µ—Ç breaking changes)

---

## 9. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

**1. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
# –ü–æ–ª–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î
pg_dump -h localhost -U bookreader_user -d bookreader > backup_pre_refactor.sql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
pg_restore --list backup_pre_refactor.sql

# –¢–µ—Å—Ç–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ dev –ë–î
createdb bookreader_test
pg_restore -d bookreader_test backup_pre_refactor.sql
```

**2. Baseline –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
```sql
-- –ó–∞—Ö–≤–∞—Ç–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
EXPLAIN ANALYZE SELECT * FROM books WHERE user_id = ?;
EXPLAIN ANALYZE SELECT * FROM books WHERE genre = 'fantasy';
EXPLAIN ANALYZE SELECT * FROM generated_images WHERE status = 'completed';

-- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å explain –ø–ª–∞–Ω—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
```

**3. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤–æ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
SELECT 'users' as table_name, COUNT(*) FROM users
UNION ALL
SELECT 'books', COUNT(*) FROM books
UNION ALL
SELECT 'chapters', COUNT(*) FROM chapters;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ orphaned –∑–∞–ø–∏—Å–µ–π
SELECT COUNT(*) FROM chapters c
LEFT JOIN books b ON c.book_id = b.id
WHERE b.id IS NULL;
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –º–∏–≥—Ä–∞—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ:**
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade +1

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pytest backend/tests/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
psql -d bookreader -c "EXPLAIN ANALYZE SELECT ..."

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
alembic downgrade -1
```

**2. –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
locust -f tests/load_test.py --users 50 --spawn-rate 10

# –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
locust -f tests/load_test.py --users 500 --spawn-rate 50

# –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

**3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:**
```python
# tests/test_query_performance.py
import time
import pytest

async def test_book_list_performance(db):
    """–°–ø–∏—Å–æ–∫ 50 –∫–Ω–∏–≥ –¥–æ–ª–∂–µ–Ω –∑–∞–Ω—è—Ç—å < 100ms –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏."""
    start = time.time()
    books = await book_service.get_user_books(db, user_id, limit=50)
    duration = time.time() - start

    assert duration < 0.1  # 100ms
    assert len(books) <= 50

async def test_no_n_plus_one(db, sql_logger):
    """–û–±–µ—Å–ø–µ—á–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –∫–Ω–∏–≥."""
    sql_logger.reset()
    books = await book_service.get_user_books(db, user_id, limit=10)

    query_count = sql_logger.count()
    assert query_count <= 3  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞–∫—Å–∏–º—É–º 1-2 –∑–∞–ø—Ä–æ—Å–∞
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**1. –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
-- –î–æ–ª–∂–Ω–æ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è:
INSERT INTO books (genre) VALUES ('invalid_genre');
-- –û—à–∏–±–∫–∞: check constraint "check_genre_values" violated

-- –î–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏:
INSERT INTO books (genre) VALUES ('fantasy');
```

**2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM books WHERE user_id = ? AND is_parsed = false;

-- –ò—Å–∫–∞—Ç—å "Index Scan" –≤–º–µ—Å—Ç–æ "Seq Scan"
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å "Buffers: shared hit=" –Ω–∏–∑–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
```bash
# –°—Ä–∞–≤–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–æ/–ø–æ—Å–ª–µ
python scripts/performance_comparison.py \
    --before backup_pre_refactor.sql \
    --after current

# –í—ã–≤–æ–¥:
# –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞          | –î–æ    | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ
# –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ (50)     | 250ms | 50ms  | 5x –±—ã—Å—Ç—Ä–µ–µ
# –ü–æ–∏—Å–∫ –ø–æ –∂–∞–Ω—Ä—É       | 800ms | 5ms   | 160x –±—ã—Å—Ç—Ä–µ–µ
# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∞+–≥–ª–∞–≤—ã | 150ms | 20ms  | 7.5x –±—ã—Å—Ç—Ä–µ–µ
```

---

## 10. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Ç–∫–∞—Ç–∞

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç (–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏)

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
pytest backend/tests/

# –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –§–∞–∑—ã 2
alembic downgrade <previous_revision>
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ï—Å–ª–∏ –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö)

```bash
# –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
pg_restore -d bookreader backup_pre_refactor.sql

# –ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
pg_restore -d bookreader -t books backup_pre_refactor.sql
```

### –£–¥–∞–ª–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

```sql
-- –ï—Å–ª–∏ CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ–µ
ALTER TABLE books DROP CONSTRAINT check_genre_values;

-- –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
DROP INDEX idx_books_user_unparsed;
```

### –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

**–ï—Å–ª–∏ production –ë–î –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏)
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
4. –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
5. Post-mortem: —á—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫?

**–ï—Å–ª–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: `pg_stat_statements`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤: `pg_stat_user_indexes`
3. –û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## 11. –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–ü–æ—Å–ª–µ –§–∞–∑—ã 1-2):**
- ‚úÖ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: < 50ms (—Å 400ms)
- ‚úÖ P99 –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: < 200ms (—Å 2000ms)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤: > 95% –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ N+1 –∑–∞–ø—Ä–æ—Å—ã: 0 –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
- ‚úÖ CPU –ë–î: < 30% (—Å 90%)

**–ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å:**
```sql
-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC;

-- Cache hit ratio
SELECT
    sum(blks_hit)*100/sum(blks_hit+blks_read) AS cache_hit_ratio
FROM pg_stat_database;
```

### –ú–µ—Ç—Ä–∏–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

**–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏: > 95% –ø–æ–ª–µ–π –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–æ
- ‚úÖ –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: 0 —Å—Ç—Ä–æ–∫ –Ω–∞—Ä—É—à–∞—é—â–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- ‚úÖ Orphaned –∑–∞–ø–∏—Å–∏: 0 –Ω–∞–π–¥–µ–Ω–æ
- ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: 100% —Å—Å—ã–ª–æ—á–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å

**–ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
SELECT COUNT(*) FROM books WHERE genre NOT IN ('fantasy', 'detective', ...);
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å orphaned –∑–∞–ø–∏—Å–∏
SELECT COUNT(*) FROM chapters c
LEFT JOIN books b ON c.book_id = b.id
WHERE b.id IS NULL;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

### –ú–µ—Ç—Ä–∏–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏

**–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- ‚úÖ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 500+ (—Å 50)
- ‚úÖ –ó–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫—É–Ω–¥—É: 2000+ (—Å 100)
- ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î: < 50% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—É–ª–∞
- ‚úÖ –û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤: < 10ms –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è

---

## 12. –¢—Ä–µ–±—É–µ–º—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –§–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**1. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ `docs/architecture/database-schema.md` (—É–∂–µ –æ–±–Ω–æ–≤–ª—ë–Ω)
- ‚≠ï –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚≠ï –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é –Ω–æ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚≠ï –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π

**2. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:**
- ‚≠ï `docs/development/database-best-practices.md` (–ù–û–í–´–ô)
- ‚≠ï –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚≠ï –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚≠ï –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è N+1

**3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API:**
- ‚≠ï `docs/architecture/api-documentation.md`
- ‚≠ï –û–±–Ω–æ–≤–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚≠ï –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**4. Changelog:**
- ‚úÖ `docs/development/changelog.md`
- ‚≠ï –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Phase 2.3
- ‚≠ï –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å breaking changes (–µ—Å–ª–∏ –µ—Å—Ç—å)

**5. README:**
- ‚≠ï `README.md`
- ‚≠ï –û–±–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏—è –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚≠ï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏

---

## 13. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:** –í—ã—è–≤–ª–µ–Ω–æ 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º—ã
- üî¥ Orphaned –º–æ–¥–µ–ª—å AdminSettings (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô)
- üü° –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å Enum vs VARCHAR (–í–´–°–û–ö–ò–ô)
- üü° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å JSON vs JSONB (–í–´–°–û–ö–ò–ô)
- üü° –ü–∞—Ç—Ç–µ—Ä–Ω—ã N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ (–í–´–°–û–ö–ò–ô)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** –í—ã—è–≤–ª–µ–Ω–æ 75+ —É–ª—É—á—à–µ–Ω–∏–π
- 45+ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- 30+ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- 10+ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î –•–û–†–û–®–ê–Ø —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏ –≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ cascade. –ú–æ–¥–µ–ª–∏ —Å–ª–µ–¥—É—é—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∏–º–µ—é—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å. –û–¥–Ω–∞–∫–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏—Ä–æ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤.

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ):**
1. ‚úÖ –£–¥–∞–ª–∏—Ç—å orphaned –º–æ–¥–µ–ª—å AdminSettings
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –§–∞–∑—ã 1 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ book_service.py
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ 10 –∏–Ω–¥–µ–∫—Å–æ–≤

**–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (2-3 –Ω–µ–¥–µ–ª–∏):**
1. ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å JSON –≤ JSONB
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ 45+ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 30+ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
4. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (–ë—É–¥—É—â–∏–µ —Ñ–∞–∑—ã):**
1. ‚≠ï –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é ENUM (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
2. ‚≠ï –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ë–î
3. ‚≠ï –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è 10M+ —Å—Ç—Ä–æ–∫
4. ‚≠ï –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤

**–û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** üü¢ –ù–ò–ó–ö–ò–ô

–í—Å–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ Non-breaking (–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ)
- ‚úÖ –û–±—Ä–∞—Ç–∏–º—ã–µ (–≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç downgrade)
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã (–∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ (–ø–æ—ç—Ç–∞–ø–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ (–Ω–µ—Ç —Ä–∏—Å–∫–∞ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- 22x –±—ã—Å—Ç—Ä–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ (400ms ‚Üí 18ms)
- 10x –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (50 ‚Üí 500)
- 20x –±–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫—É–Ω–¥—É (100 ‚Üí 2000)

**–ö–∞—á–µ—Å—Ç–≤–æ:**
- 95% –ø–æ–∫—Ä—ã—Ç–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ (—Å 30%)
- 0 –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- 0 –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ 1M+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –±—É–¥—É—â–µ–º—É —Ä–æ—Å—Ç—É

### –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ü–†–û–î–û–õ–ñ–ò–¢–¨ –†–ï–§–ê–ö–¢–û–†–ò–ù–ì** –≤ 3 —Ñ–∞–∑–∞—Ö –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ.

–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è 18-20 —á–∞—Å–æ–≤ –¥–∞—Å—Ç:
- 22x —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à—É—é —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫—É –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞

–†–∏—Å–∫ –º–∏–Ω–∏–º–∞–ª–µ–Ω –±–ª–∞–≥–æ–¥–∞—Ä—è —Ç—â–∞—Ç–µ–ª—å–Ω–æ–º—É –ø–æ—ç—Ç–∞–ø–Ω–æ–º—É –ø–æ–¥—Ö–æ–¥—É –∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

**–û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:** 2025-10-24
**–ê–≥–µ–Ω—Ç:** Database Architect Agent v1.0
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í –ö –û–ë–ó–û–†–£

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A: –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
```bash
# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
pg_dump -h localhost -U bookreader_user -d bookreader > backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
pg_restore -d bookreader backup.sql
```

### –ö–æ–º–∞–Ω–¥—ã –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "description"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head

# –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
alembic current

# –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
alembic history
```

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```sql
-- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC LIMIT 10;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT * FROM pg_stat_user_indexes ORDER BY idx_scan ASC;

-- –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
```sql
-- –¢–µ—Å—Ç CHECK –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–¥–æ–ª–∂–Ω–æ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)
INSERT INTO books (genre) VALUES ('invalid');

-- –¢–µ—Å—Ç foreign key (–¥–æ–ª–∂–Ω–æ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)
INSERT INTO chapters (book_id) VALUES ('00000000-0000-0000-0000-000000000000');

-- –¢–µ—Å—Ç NOT NULL (–¥–æ–ª–∂–Ω–æ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)
INSERT INTO books (title) VALUES (NULL);
```

---

**–ö–û–ù–ï–¶ –û–¢–ß–Å–¢–ê**
